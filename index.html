<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å…«æ–¹ç’°çƒ ERP V11.1</title>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    window.firebaseModules = { initializeApp, getDatabase, ref, set, onValue, remove };
  </script>

  <style>
    body { -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif; }
    .loader { border: 3px solid #e2e8f0; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* SVG åœ–ç¤º */
    .icon-svg { width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    .icon-svg-sm { width: 16px; height: 16px; }
    .icon-svg-lg { width: 24px; height: 24px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // SVG åœ–ç¤º
    const Icons = {
      Star: ({filled, className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24" fill={filled ? "currentColor" : "none"}>
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
      ),
      Camera: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
          <circle cx="12" cy="13" r="4"/>
        </svg>
      ),
      Copy: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
        </svg>
      ),
      Trash: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <polyline points="3 6 5 6 21 6"/>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
        </svg>
      ),
      Plus: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
      ),
      Eye: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
      ),
      Send: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <line x1="22" y1="2" x2="11" y2="13"/>
          <polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      ),
      Clock: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
      ),
      Save: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
          <polyline points="17 21 17 13 7 13 7 21"/>
          <polyline points="7 3 7 8 15 8"/>
        </svg>
      ),
      Sparkles: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>
        </svg>
      ),
      DollarSign: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <line x1="12" y1="1" x2="12" y2="23"/>
          <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
        </svg>
      ),
      Package: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/>
          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
          <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
          <line x1="12" y1="22.08" x2="12" y2="12"/>
        </svg>
      ),
      User: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
          <circle cx="12" cy="7" r="4"/>
        </svg>
      ),
      Upload: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
      ),
      Settings: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="3"/>
          <path d="M12 1v6m0 6v6M5.6 5.6l4.2 4.2m4.2 4.2l4.2 4.2M1 12h6m6 0h6M5.6 18.4l4.2-4.2m4.2-4.2l4.2-4.2"/>
        </svg>
      ),
      Search: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
      ),
    };

    // CONFIG
    const CONFIG = {
        firebase: {
            apiKey: "AIzaSyD59OwEnbcLZShhTTJJMu1VjJxrvzIcG_g",
            authDomain: "seafoodq-11b9d.firebaseapp.com",
            databaseURL: "https://seafoodq-11b9d-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "seafoodq-11b9d",
            storageBucket: "seafoodq-11b9d.firebasestorage.app",
            messagingSenderId: "454420146806",
            appId: "1:454420146806:web:802e6bd5e8e90aab21cd57"
        },
        pwd: { ADMIN: "8888", SALES: "1688" }
    };

    // å·¥å…·å‡½å¼
    const cleanStr = (s) => s ? String(s).trim() : '';
    const sanitizeKey = (s) => s ? String(s).replace(/[.#$/\[\]]/g, '_').trim() : '';
    const parseNum = (v) => {
        if (!v) return 0;
        if (typeof v === 'number') return v;
        const n = String(v).replace(/,/g, '').match(/-?\d+(\.\d+)?/);
        return n ? parseFloat(n[0]) : 0;
    };

    let db = null;

    // ä¸»æ‡‰ç”¨
    const App = () => {
      const [page, setPage] = useState('login');
      const [role, setRole] = useState('');
      const [status, setStatus] = useState('æœªé€£ç·š');
      const [data, setData] = useState({ products: {}, inventory: {}, tiers: ['ç”Ÿæ„åƒ¹'], meta: {} });
      const [inputPwd, setInputPwd] = useState('');
      
      // å ±åƒ¹ç‹€æ…‹
      const [cart, setCart] = useState([]);
      const [custInfo, setCustInfo] = useState({ 
        name: '', phone: '', mobile: '', address: '', 
        date: new Date().toISOString().split('T')[0], 
        tier: 'é–€å¸‚å”®åƒ¹',
        paymentMethod: 'æœˆçµ30å¤©'
      });
      
      // å½ˆçª—ç‹€æ…‹
      const [showProductSearch, setShowProductSearch] = useState(false);
      const [showPriceModal, setShowPriceModal] = useState(false);
      const [showHistory, setShowHistory] = useState(false);
      const [search, setSearch] = useState('');
      const [currentPriceItem, setCurrentPriceItem] = useState(null);
      const [reSelectCartId, setReSelectCartId] = useState(null); // é‡æ–°é¸æ“‡ç”¢å“çš„ cartId
      
      // æœ¬åœ°å„²å­˜
      const [quotes, setQuotes] = useState([]);

      // è¼‰å…¥æœ¬åœ°è³‡æ–™
      useEffect(() => {
        const saved = localStorage.getItem('erpQuotesV11');
        if (saved) {
          try {
            setQuotes(JSON.parse(saved));
          } catch (e) {}
        }
      }, []);

      const saveLocal = () => {
        localStorage.setItem('erpQuotesV11', JSON.stringify(quotes));
      };

      // Firebase åˆå§‹åŒ–
      const initDB = () => {
        if (db) return true;
        if (!window.firebaseModules) return false;
        try {
            const { initializeApp, getDatabase } = window.firebaseModules;
            const app = initializeApp(CONFIG.firebase);
            db = getDatabase(app);
            return true;
        } catch (e) {
            alert("Firebase åˆå§‹åŒ–å¤±æ•—: " + e.message);
            return false;
        }
      };

      // ç›£è½è³‡æ–™
      const listenDB = () => {
          if (!initDB()) return;
          const { ref, onValue } = window.firebaseModules;
          setStatus('é€£ç·šä¸­...');
          onValue(ref(db, 'seafoodData'), (snap) => {
              const val = snap.val();
              if (val) {
                  setData({
                      products: val.productDB || {},
                      inventory: val.inventoryDB || {},
                      tiers: val.priceTiers || ['ç”Ÿæ„åƒ¹'],
                      meta: val.dbMeta || {}
                  });
                  setStatus('â— å·²é€£ç·š');
              } else {
                  setStatus('â— è³‡æ–™åº«ç‚ºç©º');
              }
          }, (err) => setStatus('é€£ç·šéŒ¯èª¤'));
      };

      // ç™»å…¥
      const handleLogin = () => {
          if (inputPwd === CONFIG.pwd.ADMIN) {
              setRole('admin');
              setPage('quote');
              listenDB();
          } else if (inputPwd === CONFIG.pwd.SALES) {
              setRole('sales');
              setPage('quote');
              listenDB();
          } else {
              alert("å¯†ç¢¼éŒ¯èª¤");
          }
      };

      // Excel ä¸Šå‚³
      const handleUpload = (e, type) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const fileName = file.name.toLowerCase();
          const reader = new FileReader();
          
          reader.onload = (evt) => {
              try {
                  let wb;
                  
                  // CSV æª”æ¡ˆéœ€è¦ Big5 è§£ç¢¼
                  if (fileName.endsWith('.csv')) {
                      const decoder = new TextDecoder("big5");
                      const csvText = decoder.decode(new Uint8Array(evt.target.result));
                      wb = XLSX.read(csvText, { type: 'string' });
                  } 
                  // Excel æª”æ¡ˆç›´æ¥è®€å–äºŒé€²ä½
                  else {
                      const data = new Uint8Array(evt.target.result);
                      wb = XLSX.read(data, { type: 'array' });
                  }
                  
                  const ws = wb.Sheets[wb.SheetNames[0]];
                  const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
                  
                  console.log('è®€å–åˆ°', rows.length, 'è¡Œè³‡æ–™');
                  
                  if (type === 'stock') processStock(rows);
                  else if (type === 'quote') processQuote(rows);

              } catch (err) {
                  console.error('è®€å–éŒ¯èª¤:', err);
                  alert("è®€å–å¤±æ•—ï¼š" + err.message + "\n\nè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º");
              }
          };
          
          reader.onerror = () => {
              alert("æª”æ¡ˆè®€å–å¤±æ•—ï¼Œè«‹é‡è©¦");
          };
          
          reader.readAsArrayBuffer(file);
          e.target.value = null;
      };

      const processStock = (rows) => {
          console.log('é–‹å§‹è™•ç†åº«å­˜è³‡æ–™ï¼Œç¸½è¡Œæ•¸:', rows.length);
          
          let headerIdx = -1;
          for(let i=0; i<Math.min(rows.length, 20); i++) {
              const str = rows[i].join('');
              if (str.includes('å“è™Ÿ') && (str.includes('åº«åˆ¥') || str.includes('å€‰åº«'))) {
                  headerIdx = i; 
                  console.log('æ‰¾åˆ°æ¨™é¡Œåˆ—æ–¼ç¬¬', i+1, 'è¡Œ:', rows[i]);
                  break;
              }
          }
          if (headerIdx === -1) { 
              alert("âŒ æ‰¾ä¸åˆ°æ¨™é¡Œåˆ—\n\nè«‹ç¢ºèª Excel æª”æ¡ˆåŒ…å«ã€Œå“è™Ÿã€å’Œã€Œåº«åˆ¥ã€æ¬„ä½");
              console.error('å‰20è¡Œå…§å®¹:', rows.slice(0, 20));
              return; 
          }

          const headers = rows[headerIdx].map(cleanStr);
          const rawData = rows.slice(headerIdx + 1);
          const idxPid = headers.findIndex(h => h.includes('å“è™Ÿ'));
          const idxName = headers.findIndex(h => h.includes('å“å'));
          const idxSpec = headers.findIndex(h => h.includes('è¦æ ¼'));
          const idxWh = headers.findIndex(h => h.includes('åº«åˆ¥') || h.includes('å€‰åº«'));
          const idxQty = headers.findIndex(h => h.includes('åº«å­˜') || h.includes('æ•¸é‡'));

          console.log('æ¬„ä½ç´¢å¼• - å“è™Ÿ:', idxPid, 'å“å:', idxName, 'è¦æ ¼:', idxSpec, 'åº«åˆ¥:', idxWh, 'æ•¸é‡:', idxQty);

          if (idxPid === -1 || idxWh === -1 || idxQty === -1) {
              alert("âŒ ç¼ºå°‘å¿…è¦æ¬„ä½\n\néœ€è¦ï¼šå“è™Ÿã€åº«åˆ¥ã€åº«å­˜æ•¸é‡");
              return;
          }

          const newInv = {};
          const newProds = { ...data.products };
          let lastPid = null;
          let count = 0, newProdCount = 0;

          rawData.forEach((row, index) => {
              let pid = sanitizeKey(cleanStr(row[idxPid]));
              const wh = cleanStr(row[idxWh]);
              const qty = parseNum(row[idxQty]);
              if (!wh) return;
              if (!pid && lastPid) pid = lastPid;
              else if (pid) lastPid = pid;
              if (!pid) return;

              if (qty !== 0) {
                  if (!newInv[pid]) newInv[pid] = [];
                  if (!newInv[pid].some(x => x.warehouse === wh)) {
                      newInv[pid].push({ warehouse: wh, stock: qty });
                      count++;
                  }
              }

              const name = cleanStr(row[idxName]);
              if (name && newInv[pid]) {
                  const safeName = sanitizeKey(name);
                  if (!newProds[safeName]) newProds[safeName] = [];
                  if (!newProds[safeName].find(s => s.id === pid)) {
                      newProds[safeName].push({
                          id: pid, name: name, specDetail: cleanStr(row[idxSpec]),
                          prices: {"é–€å¸‚å”®åƒ¹":0, "æœƒå“¡95%":0, "é¤å»³90%":0, "ç”Ÿæ„åƒ¹":0, "æ•´ä»¶åƒ¹":0, "VIPåƒ¹":0, "æ¥­å‹™åº•åƒ¹":0}, 
                          note: '(åº«å­˜è£œå…¥)', pack: 1, smallUnit:'ä»¶', bigUnit:'ä»¶'
                      });
                      newProdCount++;
                  }
              }
          });

          console.log('è™•ç†å®Œæˆ - åº«å­˜ç­†æ•¸:', count, 'æ–°ç”¢å“:', newProdCount);

          if (count === 0) {
              alert("âŒ ç„¡æœ‰æ•ˆè³‡æ–™\n\nè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹æ˜¯å¦æ­£ç¢º");
              return;
          }

          // ä½¿ç”¨ setTimeout ç¢ºä¿å½ˆçª—åœ¨ä¸»åŸ·è¡Œç·’
          setTimeout(() => {
              const confirmed = window.confirm(`âœ… è§£ææˆåŠŸï¼\n\nåº«å­˜è³‡æ–™ï¼š${count} ç­†\næ–°å¢ç”¢å“ï¼š${newProdCount} ç­†\n\nç¢ºèªä¸Šå‚³åˆ° Firebaseï¼Ÿ`);
              if (confirmed) {
                  uploadDB({ 
                      inventoryDB: newInv, 
                      productDB: newProds, 
                      dbMeta: { ...data.meta, stockDate: new Date().toLocaleString('zh-TW') } 
                  });
              }
          }, 100);
      };

      const processQuote = (rows) => {
          console.log('é–‹å§‹è™•ç†å ±åƒ¹è³‡æ–™ï¼Œç¸½è¡Œæ•¸:', rows.length);
          
          let headerIdx = -1;
          for(let i=0; i<Math.min(rows.length, 20); i++) {
              if (rows[i].join('').includes('å“è™Ÿ')) { 
                  headerIdx = i; 
                  console.log('æ‰¾åˆ°æ¨™é¡Œåˆ—æ–¼ç¬¬', i+1, 'è¡Œ:', rows[i]);
                  break; 
              }
          }
          if (headerIdx === -1) { 
              alert("âŒ æ‰¾ä¸åˆ°æ¨™é¡Œåˆ—\n\nè«‹ç¢ºèª Excel æª”æ¡ˆåŒ…å«ã€Œå“è™Ÿã€æ¬„ä½");
              console.error('å‰20è¡Œå…§å®¹:', rows.slice(0, 20));
              return; 
          }
          
          const headers = rows[headerIdx].map(cleanStr);
          const rawData = rows.slice(headerIdx + 1);
          const idxPid = headers.findIndex(h => h.includes('å“è™Ÿ') || h==='ID');
          const idxName = headers.findIndex(h => h.includes('å“å'));
          const idxSpec = headers.findIndex(h => h.includes('è¦æ ¼'));

          console.log('æ¬„ä½ç´¢å¼• - å“è™Ÿ:', idxPid, 'å“å:', idxName, 'è¦æ ¼:', idxSpec);
          console.log('æ‰€æœ‰æ¨™é¡Œ:', headers);

          if (idxPid === -1 || idxName === -1) {
              alert("âŒ ç¼ºå°‘å¿…è¦æ¬„ä½\n\néœ€è¦ï¼šå“è™Ÿã€å“å");
              return;
          }

          const newProds = {};
          const tiers = new Set();
          let count = 0;

          rawData.forEach((row, index) => {
              const pid = sanitizeKey(cleanStr(row[idxPid]));
              const name = cleanStr(row[idxName]);
              if (!pid || !name) return;

              const prices = {};
              headers.forEach((h, i) => {
                  if ((h.includes('åƒ¹') || h.includes('+')) && !h.includes('è™Ÿ') && !h.includes('å')) {
                      const v = parseNum(row[i]);
                      if (v > 0) {
                          const t = h.replace('åƒ¹æ ¼','').replace('_','').trim();
                          prices[t] = v;
                          tiers.add(t);
                      }
                  }
              });

              const safeName = sanitizeKey(name);
              if (!newProds[safeName]) newProds[safeName] = [];
              newProds[safeName].push({
                  id: pid, name, specDetail: cleanStr(row[idxSpec]), prices,
                  pack: 1, smallUnit: 'ä»¶', bigUnit: 'ä»¶' 
              });
              count++;
          });

          console.log('è™•ç†å®Œæˆ - ç”¢å“ç­†æ•¸:', count, 'åƒ¹æ ¼ç­‰ç´š:', Array.from(tiers));

          if (count === 0) {
              alert("âŒ ç„¡æœ‰æ•ˆè³‡æ–™\n\nè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹æ˜¯å¦æ­£ç¢º");
              return;
          }

          // ä½¿ç”¨ setTimeout ç¢ºä¿å½ˆçª—åœ¨ä¸»åŸ·è¡Œç·’
          setTimeout(() => {
              const confirmed = window.confirm(`âœ… è§£ææˆåŠŸï¼\n\nç”¢å“æ•¸é‡ï¼š${count} ç­†\nåƒ¹æ ¼ç­‰ç´šï¼š${Array.from(tiers).join(', ')}\n\nç¢ºèªä¸Šå‚³åˆ° Firebaseï¼Ÿ`);
              if (confirmed) {
                  uploadDB({ 
                      productDB: newProds, 
                      priceTiers: Array.from(tiers), 
                      dbMeta: { ...data.meta, quoteDate: new Date().toLocaleString('zh-TW') } 
                  });
              }
          }, 100);
      };

      const uploadDB = (updates) => {
          if (!initDB()) {
              alert("âŒ Firebase æœªé€£ç·š\n\nè«‹ç¢ºèªç¶²è·¯é€£ç·šæ­£å¸¸");
              return;
          }
          
          const { ref, set } = window.firebaseModules;
          const finalData = { 
              productDB: updates.productDB || data.products,
              inventoryDB: updates.inventoryDB || data.inventory,
              priceTiers: updates.priceTiers || data.tiers,
              dbMeta: updates.dbMeta || data.meta
          };
          
          console.log('æº–å‚™ä¸Šå‚³åˆ° Firebase:', {
              ç”¢å“æ•¸: Object.keys(finalData.productDB).length,
              åº«å­˜å“é …: Object.keys(finalData.inventoryDB).length,
              åƒ¹æ ¼ç­‰ç´š: finalData.priceTiers
          });
          
          // é¡¯ç¤ºä¸Šå‚³ä¸­æç¤º
          const originalStatus = status;
          setStatus('ğŸ“¤ ä¸Šå‚³ä¸­...');
          
          set(ref(db, 'seafoodData'), finalData)
            .then(() => {
                setStatus('â— å·²é€£ç·š');
                alert("âœ… ä¸Šå‚³æˆåŠŸï¼\n\nè³‡æ–™å·²åŒæ­¥åˆ°é›²ç«¯");
                console.log('ä¸Šå‚³æˆåŠŸ');
            })
            .catch(e => {
                setStatus(originalStatus);
                console.error('ä¸Šå‚³éŒ¯èª¤:', e);
                alert("âŒ ä¸Šå‚³å¤±æ•—\n\néŒ¯èª¤è¨Šæ¯ï¼š" + e.message + "\n\nè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–é‡è©¦");
            });
      };

      // è³¼ç‰©è»Šæ“ä½œ
      const addProductFromDB = (spec) => {
        if (reSelectCartId) {
          // é‡æ–°é¸æ“‡ç”¢å“ - æ›´æ–°ç¾æœ‰ç”¢å“
          setCart(cart.map(item => {
            if (item.cartId === reSelectCartId) {
              return {
                ...spec,
                cartId: item.cartId, // ä¿æŒåŸæœ‰çš„ cartId
                qty: item.qty, // ä¿æŒåŸæœ‰çš„æ•¸é‡
                price: spec.prices[custInfo.tier] || 0,
                note: item.note, // ä¿æŒåŸæœ‰çš„å‚™è¨»
                image: item.image // ä¿æŒåŸæœ‰çš„åœ–ç‰‡
              };
            }
            return item;
          }));
          setReSelectCartId(null);
        } else {
          // æ–°å¢ç”¢å“
          const newItem = {
            ...spec,
            cartId: Date.now(),
            qty: 1,
            price: spec.prices[custInfo.tier] || 0,
            note: '',
            image: ''
          };
          setCart([...cart, newItem]);
        }
        setShowProductSearch(false);
        setSearch('');
      };

      const reSelectProduct = (cartId) => {
        setReSelectCartId(cartId);
        setShowProductSearch(true);
      };

      const updateCart = (cartId, field, value) => {
        setCart(cart.map(item => item.cartId === cartId ? {...item, [field]: value} : item));
      };

      const deleteFromCart = (cartId) => {
        setCart(cart.filter(item => item.cartId !== cartId));
      };

      const copyCartItem = (cartId) => {
        const item = cart.find(i => i.cartId === cartId);
        if (item) {
          setCart([...cart, {...item, cartId: Date.now()}]);
        }
      };

      const showPriceSelector = (cartId) => {
        setCurrentPriceItem(cartId);
        setShowPriceModal(true);
      };

      const selectPrice = (tier, price) => {
        if (currentPriceItem) {
          updateCart(currentPriceItem, 'price', price);
          setShowPriceModal(false);
          setCurrentPriceItem(null);
        }
      };

      const uploadImage = (cartId) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              updateCart(cartId, 'image', event.target.result);
            };
            reader.readAsDataURL(file);
          }
        };
        input.click();
      };

      const calculateSubtotal = (item) => item.qty * item.price;
      const calculateTotal = () => cart.reduce((sum, item) => sum + calculateSubtotal(item), 0);

      const saveQuote = () => {
        if (cart.length === 0) {
          alert('è«‹å…ˆæ–°å¢ç”¢å“');
          return;
        }
        const quote = {
          id: Date.now(),
          date: new Date().toISOString(),
          customer: {...custInfo},
          products: cart.map(p => ({...p})),
          total: calculateTotal()
        };
        const newQuotes = [...quotes, quote];
        setQuotes(newQuotes);
        setTimeout(() => {
          localStorage.setItem('erpQuotesV11', JSON.stringify(newQuotes));
        }, 100);
        alert('å ±åƒ¹å·²å„²å­˜ï¼');
      };

      const loadQuote = (quoteId) => {
        const quote = quotes.find(q => q.id === quoteId);
        if (quote) {
          setCustInfo({...quote.customer});
          setCart(quote.products.map(p => ({...p, cartId: Date.now() + Math.random()})));
          setShowHistory(false);
        }
      };

      const deleteQuote = (quoteId) => {
        if (confirm('ç¢ºå®šåˆªé™¤æ­¤å ±åƒ¹ï¼Ÿ')) {
          const newQuotes = quotes.filter(q => q.id !== quoteId);
          setQuotes(newQuotes);
          localStorage.setItem('erpQuotesV11', JSON.stringify(newQuotes));
        }
      };

      const previewQuote = () => {
        if (cart.length === 0) {
          alert('è«‹å…ˆæ–°å¢ç”¢å“');
          return;
        }
        
        let html = `
          <html><head><meta charset="UTF-8"><title>å ±åƒ¹å–®</title>
          <style>
            body { font-family: Arial; padding: 40px; }
            h1 { text-align: center; margin-bottom: 30px; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
            th { background: #f3f4f6; }
            .total { text-align: right; font-size: 20px; font-weight: bold; margin-top: 20px; }
            .info { margin-bottom: 20px; line-height: 1.8; }
          </style></head><body>
          <h1>å ±åƒ¹å–®</h1>
          <div class="info">
            <p><strong>å®¢æˆ¶ï¼š</strong>${custInfo.name}</p>
            <p><strong>åƒ¹æ ¼ç­‰ç´šï¼š</strong>${custInfo.tier}</p>
            <p><strong>çµå¸³æ–¹å¼ï¼š</strong>${custInfo.paymentMethod}</p>
            <p><strong>é›»è©±ï¼š</strong>${custInfo.phone}</p>
            <p><strong>æ‰‹æ©Ÿï¼š</strong>${custInfo.mobile}</p>
            <p><strong>åœ°å€ï¼š</strong>${custInfo.address}</p>
            <p><strong>æ—¥æœŸï¼š</strong>${custInfo.date}</p>
          </div>
          <table><thead><tr>
            <th>é …æ¬¡</th><th>ç”¢å“åç¨±</th><th>è¦æ ¼</th><th>æ•¸é‡</th><th>å–®åƒ¹</th><th>å°è¨ˆ</th><th>å‚™è¨»</th>
          </tr></thead><tbody>
          ${cart.map((p, i) => `
            <tr>
              <td>${i + 1}</td>
              <td>${p.name}</td>
              <td>${p.specDetail}</td>
              <td>${p.qty} ${p.smallUnit}</td>
              <td>$${p.price}</td>
              <td>$${calculateSubtotal(p).toLocaleString()}</td>
              <td>${p.note}</td>
            </tr>
          `).join('')}
          </tbody></table>
          <div class="total">ç¸½é‡‘é¡ï¼š$${calculateTotal().toLocaleString()}</div>
          </body></html>
        `;
        
        const win = window.open('', '_blank');
        win.document.write(html);
        win.document.close();
      };

      const shareToLine = () => {
        if (cart.length === 0) {
          alert('è«‹å…ˆæ–°å¢ç”¢å“');
          return;
        }
        
        let message = `ã€å ±åƒ¹å–®ã€‘\nå®¢æˆ¶ï¼š${custInfo.name}\nåƒ¹æ ¼ç­‰ç´šï¼š${custInfo.tier}\nçµå¸³æ–¹å¼ï¼š${custInfo.paymentMethod}\næ—¥æœŸï¼š${custInfo.date}\n\n`;
        cart.forEach((p, i) => {
          message += `${i + 1}. ${p.name}\n   ${p.specDetail}\n   ${p.qty} ${p.smallUnit} Ã— $${p.price} = $${calculateSubtotal(p)}\n`;
          if (p.note) message += `   å‚™è¨»ï¼š${p.note}\n`;
          message += `\n`;
        });
        message += `ç¸½é‡‘é¡ï¼š$${calculateTotal().toLocaleString()}`;
        
        window.open(`https://line.me/R/msg/text/?${encodeURIComponent(message)}`, '_blank');
      };

      // æœå°‹çµæœ - åŒæ™‚æœå°‹ç”¢å“åç¨±å’Œè¦æ ¼
      const filteredProds = Object.keys(data.products).filter(key => {
        // æœå°‹ç”¢å“åç¨±
        if (key.includes(search)) return true;
        // æœå°‹è¦æ ¼å…§å®¹
        const group = data.products[key];
        return group.some(spec => spec.specDetail && spec.specDetail.includes(search));
      });

      // ç™»å…¥é 
      if (page === 'login') {
        return (
          <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-indigo-100">
            <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
              <div className="text-center mb-8">
                <div className="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl mx-auto mb-4 flex items-center justify-center">
                  <Icons.Package className="icon-svg-lg text-white" />
                </div>
                <h1 className="text-3xl font-black text-gray-800">å…«æ–¹ç’°çƒ</h1>
                <p className="text-sm text-gray-500 mt-2">ERP å ±åƒ¹ç³»çµ± V11.1</p>
              </div>
              
              <input 
                type="password" 
                placeholder="è«‹è¼¸å…¥å¯†ç¢¼" 
                className="w-full p-4 border-2 border-gray-200 rounded-xl mb-4 text-center text-xl focus:border-blue-500 focus:outline-none transition-colors" 
                value={inputPwd} 
                onChange={e => setInputPwd(e.target.value)}
                onKeyPress={e => e.key === 'Enter' && handleLogin()}
              />
              
              <button 
                onClick={handleLogin} 
                className="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition-all hover:scale-[1.02]"
              >
                ç™»å…¥ç³»çµ±
              </button>
              
              <div className="mt-8 pt-6 border-t border-gray-200 text-center">
                <p className="text-xs text-gray-400 mb-3">æ¸¬è©¦å¯†ç¢¼ï¼šAdmin(8888) / Sales(1688)</p>
              </div>
            </div>
          </div>
        );
      }

      // ç®¡ç†å“¡é 
      if (page === 'admin') {
        return (
          <div className="min-h-screen bg-gray-50">
            <div className="bg-white px-4 py-3 border-b flex justify-between items-center sticky top-0 z-20 shadow-sm">
              <div>
                <h1 className="font-black text-lg">ç®¡ç†å“¡è¨­å®š</h1>
                <span className={`text-xs ${status.includes('å·²é€£ç·š')?'text-green-600':'text-gray-400'}`}>{status}</span>
              </div>
              <button onClick={() => setPage('quote')} className="bg-blue-500 text-white px-4 py-2 rounded-lg font-bold">è¿”å›å ±åƒ¹</button>
            </div>

            <div className="p-4 max-w-2xl mx-auto">
              <div className="bg-white p-6 rounded-xl shadow-lg mb-4">
                <h2 className="font-bold text-lg mb-4 flex items-center gap-2">
                  <Icons.Upload />
                  è³‡æ–™åŒ¯å…¥
                </h2>
                <div className="space-y-4">
                  <label className="block w-full p-6 border-2 border-dashed border-blue-300 bg-blue-50 text-center rounded-xl cursor-pointer hover:bg-blue-100 transition-colors">
                    <Icons.Package className="icon-svg-lg mx-auto mb-2 text-blue-600" />
                    <span className="text-blue-700 font-bold block">ğŸ“¦ ä¸Šå‚³åº«å­˜è¡¨ (XLSX/XLS/CSV)</span>
                    <span className="text-xs text-gray-500 block mt-2">å¿…é ˆåŒ…å«ï¼šå“è™Ÿã€å“åã€è¦æ ¼ã€åº«åˆ¥ã€åº«å­˜æ•¸é‡</span>
                    <input type="file" className="hidden" accept=".xlsx,.xls,.csv" onChange={e => handleUpload(e, 'stock')} />
                  </label>
                  
                  <label className="block w-full p-6 border-2 border-dashed border-green-300 bg-green-50 text-center rounded-xl cursor-pointer hover:bg-green-100 transition-colors">
                    <Icons.DollarSign className="icon-svg-lg mx-auto mb-2 text-green-600" />
                    <span className="text-green-700 font-bold block">ğŸ’° ä¸Šå‚³å ±åƒ¹è¡¨ (XLSX/XLS/CSV)</span>
                    <span className="text-xs text-gray-500 block mt-2">å¿…é ˆåŒ…å«ï¼šå“è™Ÿã€å“åã€è¦æ ¼ã€å„åƒ¹æ ¼ç­‰ç´šæ¬„ä½</span>
                    <input type="file" className="hidden" accept=".xlsx,.xls,.csv" onChange={e => handleUpload(e, 'quote')} />
                  </label>
                </div>
                
                <div className="mt-6 p-4 bg-yellow-50 border-2 border-yellow-200 rounded-xl">
                  <p className="font-bold text-sm mb-3 flex items-center gap-2">
                    <span className="text-lg">âš ï¸</span>
                    æª”æ¡ˆæ ¼å¼è¦æ±‚
                  </p>
                  <div className="space-y-2 text-xs text-gray-700">
                    <div>
                      <strong className="text-blue-700">åº«å­˜è¡¨æ¬„ä½ï¼š</strong>
                      <p className="ml-4 mt-1">å“è™Ÿã€å“åã€è¦æ ¼ã€åº«åˆ¥ï¼ˆæˆ–å€‰åº«ï¼‰ã€åº«å­˜ï¼ˆæˆ–æ•¸é‡ï¼‰</p>
                    </div>
                    <div>
                      <strong className="text-green-700">å ±åƒ¹è¡¨æ¬„ä½ï¼š</strong>
                      <p className="ml-4 mt-1">å“è™Ÿã€å“åã€è¦æ ¼ã€é–€å¸‚å”®åƒ¹ã€æœƒå“¡95%ã€é¤å»³90%ã€ç”Ÿæ„åƒ¹ã€æ•´ä»¶åƒ¹ã€VIPåƒ¹ã€æ¥­å‹™åº•åƒ¹</p>
                    </div>
                    <div className="pt-2 border-t border-yellow-300">
                      <strong>æ”¯æ´æ ¼å¼ï¼š</strong>
                      <p className="ml-4 mt-1">.xlsx (æ¨è–¦) / .xls / .csv (éœ€ Big5 ç·¨ç¢¼)</p>
                    </div>
                  </div>
                </div>
                
                <div className="mt-4 p-4 bg-blue-50 border-2 border-blue-200 rounded-xl">
                  <p className="font-bold text-sm mb-2 flex items-center gap-2">
                    <span className="text-lg">ğŸ’¡</span>
                    ä¸Šå‚³æç¤º
                  </p>
                  <ul className="space-y-1 text-xs text-gray-700 ml-6 list-disc">
                    <li>é¸æ“‡æª”æ¡ˆå¾Œæœƒè‡ªå‹•é–‹å§‹è™•ç†</li>
                    <li>è™•ç†éç¨‹æœƒé¡¯ç¤ºåœ¨ç€è¦½å™¨æ§åˆ¶å°ï¼ˆæŒ‰ F12 æŸ¥çœ‹ï¼‰</li>
                    <li>æˆåŠŸè§£æå¾Œæœƒå½ˆå‡ºç¢ºèªå°è©±æ¡†</li>
                    <li>ç¢ºèªå¾Œæ‰æœƒä¸Šå‚³åˆ° Firebase</li>
                    <li>å¦‚é‡å•é¡Œï¼Œè«‹æª¢æŸ¥æ¬„ä½åç¨±æ˜¯å¦æ­£ç¢º</li>
                  </ul>
                </div>
              </div>

              <div className="bg-white p-6 rounded-xl shadow-lg">
                <h2 className="font-bold text-lg mb-4">ç³»çµ±è³‡è¨Š</h2>
                <div className="space-y-2 text-sm">
                  <p><strong>è³‡æ–™åº«ç‹€æ…‹ï¼š</strong>{status}</p>
                  <p><strong>ç”¢å“æ•¸é‡ï¼š</strong>{Object.keys(data.products).length} é …</p>
                  <p><strong>åƒ¹æ ¼ç­‰ç´šï¼š</strong>{data.tiers.join(', ')}</p>
                  {data.meta.stockDate && <p><strong>åº«å­˜æ›´æ–°ï¼š</strong>{data.meta.stockDate}</p>}
                  {data.meta.quoteDate && <p><strong>å ±åƒ¹æ›´æ–°ï¼š</strong>{data.meta.quoteDate}</p>}
                </div>
              </div>
            </div>
          </div>
        );
      }

      // å ±åƒ¹é 
      const isMobile = typeof window !== 'undefined' && window.innerWidth <= 768;
      const total = calculateTotal();

      return (
        <div className="min-h-screen bg-gray-50">
          {/* Header */}
          {!isMobile && (
            <div className="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-6 py-4 shadow-lg">
              <div className="max-w-7xl mx-auto flex justify-between items-center">
                <div className="flex items-center gap-3">
                  <Icons.Package className="icon-svg-lg" />
                  <div>
                    <h1 className="text-xl font-black">å…«æ–¹ç’°çƒ ERP</h1>
                    <p className="text-xs opacity-90">{status}</p>
                  </div>
                </div>
                <div className="flex gap-2">
                  {role === 'admin' && (
                    <button onClick={() => setPage('admin')} className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-bold flex items-center gap-2">
                      <Icons.Settings className="icon-svg-sm" />
                      ç®¡ç†
                    </button>
                  )}
                  <button onClick={() => setPage('login')} className="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg font-bold">
                    ç™»å‡º
                  </button>
                </div>
              </div>
            </div>
          )}

          {isMobile && (
            <div className="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-4 py-3 shadow-lg sticky top-0 z-50">
              <div className="flex justify-between items-center">
                <div className="flex items-center gap-2">
                  <Icons.Package className="icon-svg" />
                  <div>
                    <h1 className="text-base font-black">å…«æ–¹ç’°çƒ ERP V11.1</h1>
                    <p className="text-xs opacity-90">{status}</p>
                  </div>
                </div>
                <div className="flex gap-2">
                  {role === 'admin' && (
                    <button onClick={() => setPage('admin')} className="bg-white/20 p-2 rounded-lg">
                      <Icons.Settings className="icon-svg-sm" />
                    </button>
                  )}
                  <button onClick={() => setPage('login')} className="bg-red-500 px-3 py-1.5 rounded-lg text-sm font-bold">
                    ç™»å‡º
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* æ¡Œé¢ç‰ˆä½ˆå±€ */}
          {!isMobile && (
            <div className="max-w-7xl mx-auto p-6">
              <div className="grid grid-cols-[280px_1fr] gap-6">
                {/* å·¦å´æ¬„ */}
                <div className="bg-gradient-to-b from-blue-500 to-indigo-600 text-white rounded-2xl p-6 shadow-xl h-fit sticky top-24">
                  <h2 className="font-bold text-lg mb-4 flex items-center gap-2">
                    <Icons.User />
                    å®¢æˆ¶è³‡è¨Š
                  </h2>
                  
                  <div className="space-y-3 mb-6">
                    <input type="text" placeholder="å®¢æˆ¶åç¨±" className="w-full p-2.5 rounded-lg text-gray-800 text-sm" 
                      value={custInfo.name} onChange={e => setCustInfo({...custInfo, name: e.target.value})} />
                    <select className="w-full p-2.5 rounded-lg text-gray-800 text-sm font-bold bg-yellow-100"
                      value={custInfo.tier} onChange={e => setCustInfo({...custInfo, tier: e.target.value})}>
                      <option value="é–€å¸‚å”®åƒ¹">é–€å¸‚å”®åƒ¹</option>
                      <option value="æœƒå“¡95%">æœƒå“¡95%</option>
                      <option value="é¤å»³90%">é¤å»³90%</option>
                      <option value="ç”Ÿæ„åƒ¹">ç”Ÿæ„åƒ¹</option>
                      <option value="æ•´ä»¶åƒ¹">æ•´ä»¶åƒ¹</option>
                      <option value="VIPåƒ¹">VIPåƒ¹</option>
                      <option value="æ¥­å‹™åº•åƒ¹">æ¥­å‹™åº•åƒ¹</option>
                    </select>
                    <select className="w-full p-2.5 rounded-lg text-gray-800 text-sm font-bold bg-green-100"
                      value={custInfo.paymentMethod} onChange={e => setCustInfo({...custInfo, paymentMethod: e.target.value})}>
                      <option value="æœˆçµ30å¤©">æœˆçµ30å¤©</option>
                      <option value="æœˆçµ60å¤©">æœˆçµ60å¤©</option>
                      <option value="ç¾é‡‘">ç¾é‡‘</option>
                      <option value="è²¨åˆ°ä»˜æ¬¾">è²¨åˆ°ä»˜æ¬¾</option>
                      <option value="åŒ¯æ¬¾">åŒ¯æ¬¾</option>
                      <option value="æ”¯ç¥¨">æ”¯ç¥¨</option>
                    </select>
                    <input type="tel" placeholder="é›»è©±" className="w-full p-2.5 rounded-lg text-gray-800 text-sm"
                      value={custInfo.phone} onChange={e => setCustInfo({...custInfo, phone: e.target.value})} />
                    <input type="tel" placeholder="æ‰‹æ©Ÿ" className="w-full p-2.5 rounded-lg text-gray-800 text-sm"
                      value={custInfo.mobile} onChange={e => setCustInfo({...custInfo, mobile: e.target.value})} />
                    <input type="text" placeholder="åœ°å€" className="w-full p-2.5 rounded-lg text-gray-800 text-sm"
                      value={custInfo.address} onChange={e => setCustInfo({...custInfo, address: e.target.value})} />
                    <input type="date" className="w-full p-2.5 rounded-lg text-gray-800 text-sm"
                      value={custInfo.date} onChange={e => setCustInfo({...custInfo, date: e.target.value})} />
                  </div>

                  <div className="space-y-2 mb-6 pt-6 border-t border-white/20">
                    <button onClick={saveQuote} className="w-full bg-white/20 hover:bg-white/30 p-3 rounded-lg font-bold flex items-center gap-2 transition-colors">
                      <Icons.Save className="icon-svg-sm" />
                      å„²å­˜å ±åƒ¹
                    </button>
                    <button onClick={() => setShowHistory(true)} className="w-full bg-white/20 hover:bg-white/30 p-3 rounded-lg font-bold flex items-center gap-2 transition-colors">
                      <Icons.Clock className="icon-svg-sm" />
                      æ­·å²å ±åƒ¹
                    </button>
                  </div>

                  <div className="pt-6 border-t border-white/20">
                    <p className="text-sm opacity-90 mb-2">ç¸½é‡‘é¡</p>
                    <p className="text-4xl font-black">${total.toLocaleString()}</p>
                  </div>
                </div>

                {/* å³å´ç”¢å“å€ */}
                <div>
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-2xl font-black text-gray-800">ç”¢å“æ¸…å–®</h2>
                    <button onClick={() => setShowProductSearch(true)} className="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg hover:shadow-xl transition-all hover:scale-[1.02]">
                      <Icons.Plus />
                      æ–°å¢ç”¢å“
                    </button>
                  </div>

                  <div className="space-y-2">
                    {cart.map((item, index) => (
                      <div key={item.cartId} className="bg-white border-2 border-gray-200 rounded-xl p-4 flex items-center gap-4 hover:border-blue-400 hover:shadow-lg transition-all" style={{minHeight: '120px'}}>
                        <div className="w-11 h-11 bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-xl flex items-center justify-center font-bold text-lg flex-shrink-0 shadow-md">
                          {index + 1}
                        </div>

                        <div className="w-28 h-28 bg-gray-100 rounded-xl flex items-center justify-center border-2 border-gray-200 cursor-pointer hover:border-blue-400 transition-colors flex-shrink-0 overflow-hidden"
                          onClick={() => uploadImage(item.cartId)}>
                          {item.image ? (
                            <img src={item.image} alt="ç”¢å“" className="w-full h-full object-cover" />
                          ) : (
                            <Icons.Camera className="icon-svg-lg text-gray-400" />
                          )}
                        </div>

                        <div className="flex-1 flex flex-col gap-2 min-w-0">
                          <div className="font-bold text-lg text-gray-800 cursor-pointer hover:text-blue-600 transition-colors" onClick={() => reSelectProduct(item.cartId)} title="é»æ“Šé‡æ–°é¸æ“‡ç”¢å“">{item.name}</div>
                          <div className="text-sm text-blue-600 font-semibold cursor-pointer hover:text-blue-800 transition-colors" onClick={() => { setSearch(item.name); setShowProductSearch(true); }} title="é»æ“Šæœå°‹åŒå“åç”¢å“">{item.specDetail}</div>
                          
                          <div className="flex items-center gap-2 flex-wrap">
                            <div className="flex items-center gap-1">
                              <span className="text-xs text-gray-600 font-semibold">æ•¸é‡</span>
                              <input type="number" className="w-20 px-2 py-1.5 border-2 border-gray-200 rounded-lg text-center font-bold focus:border-blue-500 outline-none"
                                value={item.qty} onChange={e => updateCart(item.cartId, 'qty', parseFloat(e.target.value) || 0)} />
                              <span className="text-sm font-bold text-gray-600">{item.smallUnit}</span>
                            </div>

                            <div className="flex items-center gap-1">
                              <span className="text-xs text-gray-600 font-semibold">å–®åƒ¹ $</span>
                              <input type="number" className="w-20 px-2 py-1.5 border-2 border-gray-200 rounded-lg text-center font-bold focus:border-blue-500 outline-none"
                                value={item.price} onChange={e => updateCart(item.cartId, 'price', parseFloat(e.target.value) || 0)} />
                              <button onClick={() => showPriceSelector(item.cartId)} className="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-3 py-1.5 rounded-lg font-bold flex items-center gap-1 hover:shadow-lg transition-all">
                                <Icons.DollarSign className="icon-svg-sm" />
                              </button>
                            </div>

                            <div className="text-xl font-bold text-blue-600 ml-auto">
                              ${calculateSubtotal(item).toLocaleString()}
                            </div>

                            <input type="text" placeholder="å‚™è¨»..." className="flex-1 px-3 py-1.5 border-2 border-yellow-300 bg-yellow-50 rounded-lg text-sm focus:border-yellow-500 outline-none min-w-[150px]"
                              value={item.note} onChange={e => updateCart(item.cartId, 'note', e.target.value)} />
                          </div>
                        </div>

                        <div className="flex flex-col gap-1.5 flex-shrink-0">
                          <button onClick={() => uploadImage(item.cartId)} className="w-10 h-10 bg-gray-100 border-2 border-gray-300 rounded-lg hover:bg-gray-200 transition-colors flex items-center justify-center">
                            <Icons.Camera className="icon-svg-sm" />
                          </button>
                          <button onClick={() => copyCartItem(item.cartId)} className="w-10 h-10 bg-blue-100 border-2 border-blue-300 rounded-lg hover:bg-blue-200 transition-colors flex items-center justify-center">
                            <Icons.Copy className="icon-svg-sm" />
                          </button>
                          <button onClick={() => deleteFromCart(item.cartId)} className="w-10 h-10 bg-red-100 border-2 border-red-300 rounded-lg hover:bg-red-200 transition-colors flex items-center justify-center">
                            <Icons.Trash className="icon-svg-sm" />
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* æ‰‹æ©Ÿç‰ˆä½ˆå±€ */}
          {isMobile && (
            <div className="pb-32">
              <div className="bg-white m-4 rounded-2xl p-4 shadow-lg">
                <div className="space-y-2.5">
                  <input type="text" placeholder="å®¢æˆ¶åç¨±" className="w-full p-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none transition-colors text-sm"
                    value={custInfo.name} onChange={e => setCustInfo({...custInfo, name: e.target.value})} />
                  <div className="grid grid-cols-2 gap-2.5">
                    <select className="p-3 bg-yellow-100 border-2 border-yellow-300 rounded-xl focus:border-yellow-500 outline-none transition-colors text-sm font-bold"
                      value={custInfo.tier} onChange={e => setCustInfo({...custInfo, tier: e.target.value})}>
                      <option value="é–€å¸‚å”®åƒ¹">é–€å¸‚å”®åƒ¹</option>
                      <option value="æœƒå“¡95%">æœƒå“¡95%</option>
                      <option value="é¤å»³90%">é¤å»³90%</option>
                      <option value="ç”Ÿæ„åƒ¹">ç”Ÿæ„åƒ¹</option>
                      <option value="æ•´ä»¶åƒ¹">æ•´ä»¶åƒ¹</option>
                      <option value="VIPåƒ¹">VIPåƒ¹</option>
                      <option value="æ¥­å‹™åº•åƒ¹">æ¥­å‹™åº•åƒ¹</option>
                    </select>
                    <select className="p-3 bg-green-100 border-2 border-green-300 rounded-xl focus:border-green-500 outline-none transition-colors text-sm font-bold"
                      value={custInfo.paymentMethod} onChange={e => setCustInfo({...custInfo, paymentMethod: e.target.value})}>
                      <option value="æœˆçµ30å¤©">æœˆçµ30å¤©</option>
                      <option value="æœˆçµ60å¤©">æœˆçµ60å¤©</option>
                      <option value="ç¾é‡‘">ç¾é‡‘</option>
                      <option value="è²¨åˆ°ä»˜æ¬¾">è²¨åˆ°ä»˜æ¬¾</option>
                      <option value="åŒ¯æ¬¾">åŒ¯æ¬¾</option>
                      <option value="æ”¯ç¥¨">æ”¯ç¥¨</option>
                    </select>
                  </div>
                  <div className="grid grid-cols-2 gap-2.5">
                    <input type="tel" placeholder="é›»è©±" className="w-full p-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none transition-colors text-sm min-w-0"
                      value={custInfo.phone} onChange={e => setCustInfo({...custInfo, phone: e.target.value})} />
                    <input type="tel" placeholder="æ‰‹æ©Ÿ" className="w-full p-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none transition-colors text-sm min-w-0"
                      value={custInfo.mobile} onChange={e => setCustInfo({...custInfo, mobile: e.target.value})} />
                    <input type="text" placeholder="åœ°å€" className="w-full p-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none transition-colors text-sm min-w-0"
                      value={custInfo.address} onChange={e => setCustInfo({...custInfo, address: e.target.value})} />
                    <input type="date" className="w-full p-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none transition-colors text-sm min-w-0"
                      value={custInfo.date} onChange={e => setCustInfo({...custInfo, date: e.target.value})} />
                  </div>
                </div>
              </div>

              <div className="px-4">
                <div className="flex items-center justify-between mb-3">
                  <h2 className="text-base font-bold text-gray-800 flex items-center gap-2">
                    <Icons.Package className="icon-svg-sm" />
                    ç”¢å“æ¸…å–®
                  </h2>
                </div>

                <div className="space-y-2.5">
                  {cart.map((item, index) => (
                    <div key={item.cartId} className="bg-white border-2 border-gray-200 rounded-2xl p-4 shadow-sm">
                      <div className="flex items-start gap-2.5 mb-2.5">
                        <div className="w-9 h-9 bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-xl flex items-center justify-center font-bold flex-shrink-0 shadow-md text-base">
                          {index + 1}
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className="font-bold text-base text-gray-800 mb-1 cursor-pointer active:text-blue-600" onClick={() => reSelectProduct(item.cartId)}>{item.name}</div>
                          <div className="text-sm text-blue-600 font-semibold cursor-pointer active:text-blue-800" onClick={() => { setSearch(item.name); setShowProductSearch(true); }}>{item.specDetail}</div>
                        </div>
                        <div className="flex gap-1 flex-shrink-0">
                          <button onClick={() => uploadImage(item.cartId)} className="w-8 h-8 bg-gray-100 border-2 border-gray-300 rounded-lg flex items-center justify-center">
                            <Icons.Camera className="icon-svg-sm" />
                          </button>
                          <button onClick={() => copyCartItem(item.cartId)} className="w-8 h-8 bg-blue-100 border-2 border-blue-300 rounded-lg flex items-center justify-center">
                            <Icons.Copy className="icon-svg-sm" />
                          </button>
                          <button onClick={() => deleteFromCart(item.cartId)} className="w-8 h-8 bg-red-100 border-2 border-red-300 rounded-lg flex items-center justify-center">
                            <Icons.Trash className="icon-svg-sm" />
                          </button>
                        </div>
                      </div>

                      <div className="flex gap-2 mb-3">
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-1.5 bg-gray-50 border-2 border-gray-200 rounded-xl p-2.5">
                            <span className="text-xs text-gray-500 font-semibold flex-shrink-0">æ•¸é‡</span>
                            <input type="number" className="flex-1 bg-transparent text-base font-bold text-center outline-none min-w-0"
                              value={item.qty} onChange={e => updateCart(item.cartId, 'qty', parseFloat(e.target.value) || 0)} />
                            <span className="text-sm font-bold text-gray-600 flex-shrink-0">{item.smallUnit}</span>
                          </div>
                        </div>

                        <div className="flex-1 flex gap-1 min-w-0">
                          <div className="flex-1 flex items-center gap-1 bg-gray-50 border-2 border-gray-200 rounded-xl p-2.5 min-w-0">
                            <span className="text-xs text-gray-500 font-semibold flex-shrink-0">$</span>
                            <input type="number" className="flex-1 bg-transparent text-base font-bold text-center outline-none min-w-0" style={{width: '60px'}}
                              value={item.price} onChange={e => updateCart(item.cartId, 'price', parseFloat(e.target.value) || 0)} />
                          </div>
                          <button onClick={() => showPriceSelector(item.cartId)} className="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-xl flex items-center justify-center shadow-md flex-shrink-0">
                            <Icons.DollarSign className="icon-svg-sm" />
                          </button>
                        </div>
                      </div>

                      <div className="flex gap-2 items-center">
                        <input type="text" placeholder="å‚™è¨»..." className="px-2.5 py-2.5 border-2 border-yellow-300 bg-yellow-50 rounded-xl text-sm focus:border-yellow-500 outline-none min-w-0" style={{width: '40%'}}
                          value={item.note} onChange={e => updateCart(item.cartId, 'note', e.target.value)} />
                        <div className="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-400 rounded-xl px-3 py-2 flex-shrink-0" style={{width: '60%'}}>
                          <p className="text-xs text-gray-600 font-semibold">å°è¨ˆ</p>
                          <p className="text-lg font-bold text-blue-600 whitespace-nowrap">${calculateSubtotal(item).toLocaleString()}</p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>

                <button onClick={() => setShowProductSearch(true)} className="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-2xl font-bold text-base shadow-lg mt-4 flex items-center justify-center gap-2">
                  <Icons.Plus />
                  æ–°å¢ç”¢å“
                </button>
              </div>

              <div className="fixed bottom-0 left-0 right-0 bg-white border-t-2 border-gray-200 shadow-2xl z-50">
                <div className="grid grid-cols-3 border-b border-gray-200">
                  <button onClick={previewQuote} className="flex flex-col items-center justify-center py-2.5 border-r border-gray-200 text-blue-600 active:bg-gray-50">
                    <Icons.Eye className="icon-svg-lg mb-1" />
                    <span className="text-xs font-semibold">é è¦½</span>
                  </button>
                  <button onClick={shareToLine} className="flex flex-col items-center justify-center py-2.5 border-r border-gray-200 text-green-600 active:bg-gray-50">
                    <Icons.Send className="icon-svg-lg mb-1" />
                    <span className="text-xs font-semibold">LINE</span>
                  </button>
                  <div className="flex flex-col items-center justify-center py-2.5 bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
                    <span className="text-xs opacity-90">ç¸½é‡‘é¡</span>
                    <span className="text-lg font-black">${total.toLocaleString()}</span>
                  </div>
                </div>

                <div className="grid grid-cols-2">
                  <button onClick={saveQuote} className="flex items-center justify-center gap-1.5 py-2 border-r border-gray-200 active:bg-gray-50">
                    <Icons.Save className="icon-svg-lg" />
                    <span className="text-xs font-semibold">å„²å­˜</span>
                  </button>
                  <button onClick={() => setShowHistory(true)} className="flex items-center justify-center gap-1.5 py-2 active:bg-gray-50">
                    <Icons.Clock className="icon-svg-lg" />
                    <span className="text-xs font-semibold">æ­·å²</span>
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* ç”¢å“æœå°‹å½ˆçª— */}
          {showProductSearch && (
            <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
              <div className="bg-white w-full max-w-2xl rounded-2xl flex flex-col overflow-hidden shadow-2xl" style={{maxHeight: '80vh'}}>
                <div className="px-6 py-4 border-b flex gap-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2">
                      <Icons.Search className="icon-svg" />
                      <h3 className="font-bold text-lg">
                        {reSelectCartId ? 'é‡æ–°é¸æ“‡ç”¢å“' : 'æ–°å¢ç”¢å“'}
                      </h3>
                    </div>
                    <div className="relative">
                      <input 
                        autoFocus 
                        placeholder="æœå°‹ç”¢å“åç¨±..." 
                        className="w-full px-4 py-2.5 rounded-lg text-gray-800 outline-none" 
                        value={search} 
                        onChange={e => setSearch(e.target.value)} 
                      />
                    </div>
                  </div>
                  <button onClick={() => { setShowProductSearch(false); setSearch(''); setReSelectCartId(null); }} className="bg-white/20 hover:bg-white/30 px-6 rounded-lg font-bold text-lg h-fit">âœ•</button>
                </div>

                <div className="flex-1 overflow-auto p-4">
                  {filteredProds.length === 0 ? (
                    <div className="text-center text-gray-400 py-20">
                      <Icons.Search className="icon-svg-lg mx-auto mb-4 opacity-50" />
                      <p>ç„¡ç¬¦åˆå•†å“</p>
                    </div>
                  ) : (
                    <div className="space-y-4">
                      {filteredProds.slice(0, 50).map(key => {
                        const group = data.products[key];
                        return (
                          <div key={key} className="border-2 border-gray-200 rounded-xl overflow-hidden">
                            <div className="bg-gray-100 px-4 py-2 font-bold text-gray-800">{key}</div>
                            {group.map((spec, i) => {
                              const stocks = data.inventory[spec.id] || [];
                              const total = stocks.reduce((s, x) => s + x.stock, 0);
                              const price = spec.prices[custInfo.tier] || 0;
                              
                              return (
                                <div 
                                  key={i} 
                                  onClick={() => addProductFromDB(spec)}
                                  className="p-4 border-b border-gray-200 last:border-b-0 hover:bg-blue-50 cursor-pointer transition-colors"
                                >
                                  <div className="flex justify-between items-start mb-2">
                                    <div className="flex-1">
                                      <div className="font-bold text-blue-800">{spec.specDetail}</div>
                                      <div className="text-xs text-gray-500 mt-1">å“è™Ÿ: {spec.id}</div>
                                    </div>
                                    <div className="text-right flex-shrink-0 ml-4">
                                      <div className="font-black text-2xl text-blue-600">${price}</div>
                                      <span className={`inline-block text-xs px-2 py-1 rounded mt-1 ${total > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-500'}`}>
                                        åº«å­˜: {total}
                                      </span>
                                    </div>
                                  </div>
                                  
                                  {stocks.length > 0 && (
                                    <div className="flex gap-2 flex-wrap mt-2">
                                      {stocks.map((s, k) => (
                                        <span key={k} className="text-xs bg-gray-100 px-2 py-1 rounded border border-gray-300">
                                          {s.warehouse}: {s.stock}
                                        </span>
                                      ))}
                                    </div>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* åƒ¹æ ¼é¸æ“‡å½ˆçª— */}
          {showPriceModal && currentPriceItem && (
            <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4" onClick={() => setShowPriceModal(false)}>
              <div className="bg-white rounded-2xl max-w-lg w-full max-h-[80vh] overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                <div className="px-6 py-4 border-b flex justify-between items-center bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
                  <h3 className="font-bold text-lg flex items-center gap-2">
                    <Icons.DollarSign />
                    é¸æ“‡åƒ¹æ ¼
                  </h3>
                  <button onClick={() => setShowPriceModal(false)} className="w-8 h-8 bg-white/20 hover:bg-white/30 rounded-lg flex items-center justify-center text-xl font-bold">âœ•</button>
                </div>

                <div className="p-6 overflow-y-auto max-h-[calc(80vh-80px)]">
                  {(() => {
                    const item = cart.find(i => i.cartId === currentPriceItem);
                    if (!item || !item.prices) return null;
                    
                    // å›ºå®šçš„7å€‹åƒ¹æ ¼ç­‰ç´šé †åºï¼ˆç”±é«˜åˆ°ä½ï¼‰
                    const priceOrder = [
                      'é–€å¸‚å”®åƒ¹',
                      'æœƒå“¡95%',
                      'é¤å»³90%',
                      'ç”Ÿæ„åƒ¹',
                      'æ•´ä»¶åƒ¹',
                      'VIPåƒ¹',
                      'æ¥­å‹™åº•åƒ¹'
                    ];
                    
                    return (
                      <div className="space-y-3">
                        {priceOrder.map((tier) => {
                          const price = item.prices[tier];
                          if (!price && price !== 0) return null; // å¦‚æœæ²’æœ‰é€™å€‹åƒ¹æ ¼å°±ä¸é¡¯ç¤º
                          
                          return (
                            <button 
                              key={tier}
                              onClick={() => selectPrice(tier, price)}
                              className="w-full p-4 border-2 border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-colors text-left"
                            >
                              <div className="flex justify-between items-center">
                                <div>
                                  <div className="text-sm text-gray-500">{tier}</div>
                                  <div className="text-2xl font-bold text-blue-600">${price}</div>
                                </div>
                                {custInfo.tier === tier && (
                                  <span className="bg-green-100 text-green-700 text-xs px-3 py-1 rounded-full font-bold">ç›®å‰ç­‰ç´š</span>
                                )}
                              </div>
                            </button>
                          );
                        })}
                      </div>
                    );
                  })()}
                </div>
              </div>
            </div>
          )}

          {/* æ­·å²å ±åƒ¹å½ˆçª— */}
          {showHistory && (
            <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4" onClick={() => setShowHistory(false)}>
              <div className="bg-white rounded-2xl max-w-lg w-full max-h-[80vh] overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                <div className="px-6 py-4 border-b flex justify-between items-center bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
                  <h3 className="font-bold text-lg flex items-center gap-2">
                    <Icons.Clock />
                    æ­·å²å ±åƒ¹
                  </h3>
                  <button onClick={() => setShowHistory(false)} className="w-8 h-8 bg-white/20 hover:bg-white/30 rounded-lg flex items-center justify-center text-xl font-bold">âœ•</button>
                </div>

                <div className="p-6 overflow-y-auto max-h-[calc(80vh-80px)]">
                  {quotes.length === 0 ? (
                    <p className="text-center text-gray-400 py-10">å°šç„¡æ­·å²å ±åƒ¹</p>
                  ) : (
                    <div className="space-y-2">
                      {[...quotes].reverse().map(quote => {
                        const date = new Date(quote.date);
                        const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
                        return (
                          <div key={quote.id} className="p-4 border-2 border-gray-200 rounded-xl">
                            <div className="flex justify-between items-start mb-2">
                              <div>
                                <div className="font-bold">{quote.customer.name || 'æœªå‘½åå®¢æˆ¶'}</div>
                                <div className="text-xs text-gray-500">{dateStr} â€¢ {quote.customer.tier}</div>
                              </div>
                              <div className="text-right">
                                <div className="text-xl font-bold text-blue-600">${quote.total.toLocaleString()}</div>
                                <div className="text-xs text-gray-500">{quote.products.length} é …</div>
                              </div>
                            </div>
                            <div className="flex gap-2 mt-3">
                              <button onClick={() => loadQuote(quote.id)} className="flex-1 bg-blue-500 text-white py-2 rounded-lg font-bold">è¼‰å…¥</button>
                              <button onClick={() => deleteQuote(quote.id)} className="px-4 bg-red-100 text-red-600 py-2 rounded-lg font-bold">åˆªé™¤</button>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>