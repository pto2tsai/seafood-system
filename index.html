<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>八方環球報價 V9.1 (防當機急救版)</title>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    window.firebaseModules = { initializeApp, getDatabase, ref, set, onValue };
  </script>

  <style>
    body { -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    @media print { .no-print { display: none !important; } }
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #1d4ed8; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .A4-product-name { font-weight: 700; font-size: 14px; word-break: break-all; line-height: 1.4; margin-bottom: 4px; }
    .login-bg { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const firebaseConfig = {
        apiKey: "AIzaSyD59OwEnbcLZShhTTJJMu1VjJxrvzIcG_g",
        authDomain: "seafoodq-11b9d.firebaseapp.com",
        databaseURL: "https://seafoodq-11b9d-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "seafoodq-11b9d",
        storageBucket: "seafoodq-11b9d.firebasestorage.app",
        messagingSenderId: "454420146806",
        appId: "1:454420146806:web:802e6bd5e8e90aab21cd57"
    };

    const PASSWORDS = { SALES: "1688", ADMIN: "8888" };

    let db, dbRef, dbSet, dbOnValue;

    const initFirebase = () => {
        if (window.firebaseModules && !db) {
            const { initializeApp, getDatabase, ref, set, onValue } = window.firebaseModules;
            try {
                const app = initializeApp(firebaseConfig);
                db = getDatabase(app);
                dbRef = ref;
                dbSet = set;
                dbOnValue = onValue;
                return true;
            } catch (e) { console.error(e); return false; }
        }
        return false;
    };

    const Icon = ({ path, size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{ __html: path }} />
    );
    const icons = {
      Plus: '<line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>',
      Trash2: '<polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line>',
      Send: '<line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>',
      Database: '<ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M3 12a9 3 0 0 0 18 0v-1a9 3 0 0 0-18 0z"></path><path d="M3 5v14a9 3 0 0 0 18 0V5"></path>',
      Search: '<circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>',
      X: '<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>',
      Image: '<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="M21 15l-3.37-3.37a.91.91 0 0 0-1.28 0L9 17"></path>',
      Cloud: '<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>',
      Lock: '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path>',
      Unlock: '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path>',
      Printer: '<polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect>',
      LogOut: '<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line>',
      ChevronLeft: '<polyline points="15 18 9 12 15 6"></polyline>',
      ArrowRight: '<line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline>',
      DollarSign: '<line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>',
      Download: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line>'
    };
    const LucideIcon = ({ name, ...props }) => <Icon path={icons[name]} {...props} />;

    const compressImage = (file, maxWidth=800, quality=0.6) => {
        return new Promise((resolve, reject) => {
            if (!file.type.match('image.*')) { reject(new Error("非圖片")); return; }
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w=img.width, h=img.height;
                    if(w>maxWidth){ h=Math.round((h*maxWidth)/w); w=maxWidth; }
                    canvas.width=w; canvas.height=h;
                    const ctx=canvas.getContext('2d');
                    ctx.fillStyle = "#FFFFFF"; ctx.fillRect(0, 0, w, h);
                    ctx.drawImage(img,0,0,w,h);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
            };
            reader.onerror = () => reject(new Error("讀取失敗"));
        });
    };

    const cleanHeader = (val) => {
        if (!val) return '';
        return val.toString().replace(/[\r\n]+/g, ' ').trim();
    };

    const cleanID = (val) => {
        if (!val) return '';
        return val.toString().trim();
    };

    const cleanStr = (val) => {
        if (!val) return '';
        return val.toString().trim();
    };

    const parseCleanFloat = (val) => {
        if (!val) return 0;
        if (typeof val === 'number') return val;
        const cleanStr = val.toString().replace(/,/g, ''); 
        const match = cleanStr.match(/-?\d+(\.\d+)?/);
        return match ? parseFloat(match[0]) : 0;
    };

    const App = () => {
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [userRole, setUserRole] = useState('');
      const [loginInput, setLoginInput] = useState('');
      
      const [viewMode, setViewMode] = useState('edit'); 
      const [showSpecLookup, setShowSpecLookup] = useState(false);
      const [showAdmin, setShowAdmin] = useState(false);
      const [showPricePicker, setShowPricePicker] = useState(false);
      const [pickingPriceId, setPickingPriceId] = useState(null);
      const [isSyncing, setIsSyncing] = useState(true);
      const [uploadingImageId, setUploadingImageId] = useState(null);
      const [connectionStatus, setConnectionStatus] = useState('init');
      const [debugInfo, setDebugInfo] = useState(null);
      const [useBig5, setUseBig5] = useState(false);

      const [productDB, setProductDB] = useState({}); 
      const [inventoryDB, setInventoryDB] = useState({});
      const [priceTiers, setPriceTiers] = useState(['生意價']);
      const [dbMeta, setDbMeta] = useState({ quoteDate: '', stockDate: '' });

      const [customerPriceTier, setCustomerPriceTier] = useState('生意價');
      const [items, setItems] = useState([{ id: 1, name: '', specDetail: '', qty: 1, bigUnit: '件', packingContent: 1, smallUnit: 'KG', price: 0, imageBase64: '' }]);
      const [companyInfo, setCompanyInfo] = useState({ 
          name: '', phone: '', address: '', bankInfo: '', 
          note: '1. 價格以出貨當日為準。\n2. 規格與重量請於收貨時確認。' 
      });
      const [customerInfo, setCustomerInfo] = useState({
        name: '', taxId: '', contact: '', phone: '', address: '',
        paymentMethod: '現金結帳', date: new Date().toISOString().split('T')[0],
        quoteNo: `Q${new Date().toISOString().slice(2,10).replace(/-/g,'')}-01`
      });
      
      const [editingItemId, setEditingItemId] = useState(null);
      const [isQuoteOnly, setIsQuoteOnly] = useState(false);
      const [previewFormat, setPreviewFormat] = useState('mobile');
      
      const previewRef = useRef(null);

      useEffect(() => {
          const sessionRole = sessionStorage.getItem('seafood_role');
          if (sessionRole) {
              setUserRole(sessionRole);
              setIsAuthenticated(true);
              connectDB();
          }
          const load = (k,s) => { const v=localStorage.getItem(k); if(v) s(JSON.parse(v)); };
          load('v6_company', setCompanyInfo);
      }, []);

      const connectDB = () => {
          const tryConnect = () => {
              if (initFirebase()) {
                  const dataRef = dbRef(db, 'seafoodData');
                  dbOnValue(dataRef, (snapshot) => {
                      const data = snapshot.val();
                      if (data) {
                          if(data.productDB) setProductDB(data.productDB);
                          if(data.inventoryDB) setInventoryDB(data.inventoryDB);
                          if(data.priceTiers) setPriceTiers(data.priceTiers);
                          if(data.dbMeta) setDbMeta(data.dbMeta);
                      }
                      setConnectionStatus('connected');
                      setIsSyncing(false);
                  }, (error) => {
                      setConnectionStatus('error');
                      setIsSyncing(false);
                  });
              } else { setTimeout(tryConnect, 500); }
          };
          tryConnect();
      };

      const handleLogin = (e) => {
          e.preventDefault();
          if (loginInput === PASSWORDS.ADMIN) {
              setUserRole('admin'); setIsAuthenticated(true); sessionStorage.setItem('seafood_role', 'admin'); connectDB();
          } else if (loginInput === PASSWORDS.SALES) {
              setUserRole('sales'); setIsAuthenticated(true); sessionStorage.setItem('seafood_role', 'sales'); connectDB();
          } else { alert("密碼錯誤"); }
      };

      const handleLogout = () => {
          setIsAuthenticated(false); setUserRole(''); sessionStorage.removeItem('seafood_role'); setLoginInput('');
      };

      const uploadToCloud = (newProductDB, newInventoryDB, newTiers, newMeta) => {
          if(!db || !dbSet) { alert("尚未連接雲端"); return; }
          const finalProductDB = newProductDB || productDB;
          const finalInventoryDB = newInventoryDB || inventoryDB;
          const finalTiers = newTiers || priceTiers;
          const finalMeta = { ...dbMeta, ...newMeta };
          
          setIsSyncing(true);
          dbSet(dbRef(db, 'seafoodData'), {
              productDB: finalProductDB, inventoryDB: finalInventoryDB, priceTiers: finalTiers, dbMeta: finalMeta
          }).then(() => {
              alert("✅ 雲端同步成功！");
              setIsSyncing(false);
              setDebugInfo(null);
          }).catch(err => {
              alert("❌ 上傳失敗: " + err.message);
              setIsSyncing(false);
          });
      };

      const handleFileUpload = (e, type) => {
          if (userRole !== 'admin') return;
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (evt) => {
              try {
                  const data = new Uint8Array(evt.target.result);
                  let wb;
                  if (useBig5) {
                      const decoder = new TextDecoder("big5");
                      const csvText = decoder.decode(data);
                      wb = XLSX.read(csvText, { type: 'string' });
                  } else {
                      wb = XLSX.read(data, { type: 'array' });
                  }
                  const ws = wb.Sheets[wb.SheetNames[0]];
                  const rawData = XLSX.utils.sheet_to_json(ws, { header: 1 });
                  if (type === 'quote') processQuoteData(rawData);
                  if (type === 'stock') processStockData(rawData);
              } catch (err) {
                  alert("讀取失敗，請重試");
                  console.error(err);
              }
          };
          reader.readAsArrayBuffer(file);
          e.target.value = null; 
      };

      const findHeaderRow = (rows, keywords) => {
          for (let i = 0; i < Math.min(rows.length, 20); i++) {
              const rowStr = rows[i].map(c => cleanHeader(c)).join('');
              if (keywords.every(k => rowStr.includes(k))) return i;
          }
          return -1;
      };

      const processQuoteData = (rawData) => {
          const headerRowIdx = findHeaderRow(rawData, ['品號', '品名']);
          if (headerRowIdx === -1) { 
              const debugSample = rawData.slice(0,5).map(r => JSON.stringify(r)).join('\n');
              setDebugInfo(debugSample);
              alert("❌ 讀取失敗：找不到「品號」欄位。\n(若下方診斷區是亂碼，請勾選「強制 Big5」再試一次)"); 
              return; 
          }

          const headers = rawData[headerRowIdx].map(h => cleanHeader(h));
          const data = rawData.slice(headerRowIdx + 1).map(row => {
              let obj = {};
              headers.forEach((h, i) => { if(h) obj[h] = row[i]; });
              return obj;
          });

          const newDB = {}; const foundTiers = new Set(); let count = 0;
          data.forEach((row) => {
              const pidKey = Object.keys(row).find(k => k.includes('品號') || k === 'id');
              const nameKey = Object.keys(row).find(k => k.includes('品名') || k.includes('名稱'));
              const specKey = Object.keys(row).find(k => k.includes('規格'));
              const packKey = Object.keys(row).find(k => k.includes('箱容'));
              const unitKey = Object.keys(row).find(k => k.includes('單位'));
              const bigUnitKey = Object.keys(row).find(k => k.includes('大單位'));
              const noteKey = Object.keys(row).find(k => k.includes('備註'));

              const pid = cleanID(row[pidKey]); 
              const name = cleanStr(row[nameKey]);
              if (!pid || !name) return; 
              
              const prices = {};
              Object.keys(row).forEach(k => {
                  if ((k.includes('價') || k.includes('+'))) {
                      const val = parseCleanFloat(row[k]);
                      if(val > 0) {
                          let tier = k.replace('價格', '').replace('_', '').trim();
                          if(tier) { prices[tier] = val; foundTiers.add(tier); }
                      }
                  }
              });
              let packNum = 1;
              if (packKey && row[packKey]) packNum = parseCleanFloat(row[packKey]);
              else {
                  const matches = [...(row[specKey]||'').toString().matchAll(/(\d+(\.\d+)?)\s*(盒|包|塊|片)/g)];
                  if (matches.length > 0) packNum = parseFloat(matches[matches.length - 1][1]);
              }
              newDB[name] = newDB[name] || [];
              newDB[name].push({
                  id: pid, name, specDetail: cleanStr(row[specKey]||''), 
                  pack: packNum||1, smallUnit: cleanStr(row[unitKey]||'kg'), bigUnit: cleanStr(row[bigUnitKey]||'件'), 
                  prices, note: cleanStr(row[noteKey]||'')
              });
              count++;
          });

          if(count > 0) {
              if(confirm(`解析出 ${count} 筆商品，要覆蓋雲端資料嗎？`)) {
                  uploadToCloud(newDB, null, Array.from(foundTiers), { quoteDate: new Date().toLocaleString() }); 
              }
          } else alert("匯入失敗: 無有效資料");
      };

      // V9.1: 防當機核心 (過濾垃圾行 + 分批處理)
      const processStockData = (rawData) => {
          let headerRowIdx = findHeaderRow(rawData, ['品號', '庫別']); 
          if (headerRowIdx === -1) headerRowIdx = findHeaderRow(rawData, ['品號', '倉庫']);
          if (headerRowIdx === -1) headerRowIdx = findHeaderRow(rawData, ['品號', '庫存']);

          if (headerRowIdx === -1) { 
              const debugSample = rawData.slice(0,5).map(r => JSON.stringify(r)).join('\n');
              setDebugInfo(debugSample); 
              alert(`❌ 讀取失敗。\n(若下方診斷區是亂碼，請勾選「強制 Big5」再試一次)`); 
              return; 
          }

          const headers = rawData[headerRowIdx].map(h => cleanHeader(h));
          const data = rawData.slice(headerRowIdx + 1).map(row => {
              let obj = {};
              headers.forEach((h, i) => { if(h) obj[h] = row[i]; });
              return obj;
          });

          const newInv = {}; 
          let count = 0;
          let newProductsAdded = 0;
          let lastValidID = null; 
          
          const updatedProductDB = JSON.parse(JSON.stringify(productDB));

          const pidKey = Object.keys(data[0] || {}).find(k => k.includes('品號') || k === 'id');
          const nameKey = Object.keys(data[0] || {}).find(k => k.includes('品名'));
          const specKey = Object.keys(data[0] || {}).find(k => k.includes('規格'));
          const whKey = Object.keys(data[0] || {}).find(k => k.includes('庫別') || k.includes('倉庫') || k.includes('名稱'));
          const qtyKey = Object.keys(data[0] || {}).find(k => k.includes('庫存') || k.includes('數量') || k.includes('現有'));

          if (!pidKey || !whKey || !qtyKey) {
              setDebugInfo(`偵測欄位: ${JSON.stringify(Object.keys(data[0] || {}))}`);
              alert("❌ 格式不符：欄位對應失敗。");
              return;
          }

          // 防當機：大量資料檢查
          if (data.length > 5000) {
              if(!confirm(`檔案包含 ${data.length} 筆資料，處理可能需要一點時間。是否繼續？`)) return;
          }

          data.forEach((row) => {
              // 1. 垃圾行過濾: 如果沒有庫別名稱，通常是匯總行，直接跳過
              const whNameRaw = row[whKey];
              if (!whNameRaw || cleanStr(whNameRaw) === '') return;

              let pid = cleanID(row[pidKey]);
              
              // 自動補位
              if (!pid && lastValidID) pid = lastValidID;
              else if (pid) lastValidID = pid;

              if (!pid) return; 

              const name = cleanStr(row[nameKey]);
              const spec = cleanStr(row[specKey]);
              const wh = cleanStr(whNameRaw);
              const qty = parseCleanFloat(row[qtyKey]);

              if (wh && !isNaN(qty)) {
                  if (!newInv[pid]) newInv[pid] = [];
                  if (!newInv[pid].some(x => x.warehouse === wh)) {
                      newInv[pid].push({ warehouse: wh, stock: qty });
                      count++;
                  }
              }

              if (name && newInv[pid]) { 
                  if (!updatedProductDB[name]) updatedProductDB[name] = [];
                  const existingSpec = updatedProductDB[name].find(s => s.id === pid);
                  
                  if (!existingSpec) {
                      let packNum = 1;
                      const matches = [...(spec||'').toString().matchAll(/(\d+(\.\d+)?)\s*(盒|包|塊|片)/g)];
                      if (matches.length > 0) packNum = parseFloat(matches[matches.length - 1][1]);

                      updatedProductDB[name].push({
                          id: pid, name: name, specDetail: spec,
                          pack: packNum || 1, smallUnit: '件', bigUnit: '件',
                          prices: { "生意價": 0 }, note: '(庫存補入)'
                      });
                      newProductsAdded++;
                  }
              }
          });

          if (count > 0) {
              const msg = `✅ 庫存表解析成功！\n偵測到 ${count} 筆庫存紀錄。\n自動補入 ${newProductsAdded} 個新商品。\n\n按確定開始上傳...`;
              if(confirm(msg)) {
                  uploadToCloud(updatedProductDB, newInv, null, { stockDate: new Date().toLocaleString() }); 
              }
          } else {
              setDebugInfo(JSON.stringify(data.slice(0, 5), null, 2));
              alert(`❌ 讀不到庫存數字。\n請看下方診斷區。`);
          }
      };

      // --- Item Operations ---
      const updateItem = (id, f, v) => setItems(prev => prev.map(i => i.id === id ? { ...i, [f]: v } : i));
      const addItem = () => setItems([...items, { id: Date.now(), name: '', specDetail: '', qty: 1, bigUnit: '件', packingContent: 1, smallUnit: 'KG', price: 0, imageBase64: '' }]);
      const removeItem = (id) => setItems(prev => prev.filter(i => i.id !== id));
      const handleNumeric = (e) => parseFloat(e.target.value) || 0;
      const calcTotal = () => items.reduce((s, i) => s + (i.qty * i.packingContent * i.price), 0);
      const fmtMoney = (n) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits:0 }).format(n);
      
      const openSpecLookup = (id) => { setEditingItemId(id); setShowSpecLookup(true); };
      const applySpec = (spec) => {
          updateItem(editingItemId, 'originalSpec', spec);
          updateItem(editingItemId, 'name', spec.name);
          updateItem(editingItemId, 'specDetail', spec.specDetail);
          updateItem(editingItemId, 'packingContent', spec.pack);
          updateItem(editingItemId, 'smallUnit', spec.smallUnit);
          updateItem(editingItemId, 'bigUnit', spec.bigUnit);
          updateItem(editingItemId, 'price', spec.prices[customerPriceTier] || 0);
          setShowSpecLookup(false);
      };
      
      const handleImageUpload = async (e, id) => {
          const file = e.target.files[0];
          if (file) {
              setUploadingImageId(id);
              try { const b64 = await compressImage(file, 800, 0.6); updateItem(id, 'imageBase64', b64); } 
              catch(err) { alert("圖片上傳失敗：" + err.message); } 
              finally { setUploadingImageId(null); e.target.value = null; }
          }
      };

      const openPricePicker = (itemId) => {
          const item = items.find(i => i.id === itemId);
          if (!item || !item.name) { alert("請先選擇產品"); return; }
          setPickingPriceId(itemId);
          setShowPricePicker(true);
      };

      const selectPrice = (price) => {
          updateItem(pickingPriceId, 'price', price);
          setShowPricePicker(false);
          setPickingPriceId(null);
      };

      const handleDownloadImage = async () => {
          if (!previewRef.current) return;
          try {
              const canvas = await html2canvas(previewRef.current, { useCORS: true, scale: 2, backgroundColor: '#ffffff' });
              const link = document.createElement('a');
              link.download = `報價單_${customerInfo.name}_${customerInfo.date}.jpg`;
              link.href = canvas.toDataURL('image/jpeg', 0.9);
              link.click();
          } catch (err) { alert("轉存失敗"); }
      };

      const PricePickerModal = () => {
          const item = items.find(i => i.id === pickingPriceId);
          if (!item) return null;
          let pricesObj = {};
          if (item.originalSpec && item.originalSpec.prices) {
              pricesObj = item.originalSpec.prices;
          } else {
              const group = productDB[item.name];
              if (group) {
                  const spec = group.find(s => s.specDetail === item.specDetail) || group[0];
                  if(spec) pricesObj = spec.prices;
              }
          }

          return (
              <div className="fixed inset-0 bg-black/40 z-[60] flex items-center justify-center p-4 animate-in fade-in">
                  <div className="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl">
                      <div className="flex justify-between items-center mb-4">
                          <h3 className="font-black text-lg">選擇價格等級</h3>
                          <button onClick={() => setShowPricePicker(false)} className="bg-gray-100 p-2 rounded-full"><LucideIcon name="X" size={20}/></button>
                      </div>
                      <div className="mb-4 text-sm text-gray-500">產品: <span className="font-bold text-black">{item.name} {item.specDetail}</span></div>
                      <div className="space-y-2">
                          {Object.entries(pricesObj).length > 0 ? (
                              Object.entries(pricesObj).map(([tier, price]) => (
                                  <button key={tier} onClick={() => selectPrice(price)} 
                                      className="w-full flex justify-between items-center p-4 border rounded-xl hover:bg-blue-50 active:bg-blue-100 transition">
                                      <span className="font-bold text-gray-600">{tier}</span>
                                      <span className="font-black text-xl text-blue-700">${price}</span>
                                  </button>
                              ))
                          ) : <div className="text-center py-4 text-gray-400">無可用價格資訊</div>}
                      </div>
                  </div>
              </div>
          );
      };

      const AdminPanel = () => (
          <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
                  <div className="flex justify-between items-center mb-6">
                      <h3 className="text-xl font-black flex items-center gap-2">管理後台</h3>
                      <button onClick={() => setShowAdmin(false)}><LucideIcon name="X"/></button>
                  </div>
                  {userRole === 'admin' ? (
                      <div className="space-y-6">
                          <div className="bg-green-50 p-4 rounded-xl border border-green-200">
                              <h4 className="font-bold text-green-800 mb-2 flex items-center gap-2"><LucideIcon name="Cloud" size={18}/> 更新雲端資料庫</h4>
                              
                              <div className="mb-4 flex items-center gap-2 bg-yellow-50 p-2 rounded border border-yellow-200">
                                  <input type="checkbox" id="useBig5" className="w-5 h-5" checked={useBig5} onChange={e => setUseBig5(e.target.checked)}/>
                                  <label htmlFor="useBig5" className="text-sm font-bold text-yellow-800 cursor-pointer select-none">強制使用 Big5 解碼 (解決亂碼)</label>
                              </div>

                              <label className="block w-full p-3 border-2 border-dashed border-green-300 rounded-lg text-center bg-white cursor-pointer hover:bg-green-50 mb-3 transition">
                                  <span className="text-green-700 font-bold block">1. 上傳 報價單 Excel</span>
                                  <span className="text-xs text-gray-400">上次: {dbMeta.quoteDate || '無'}</span>
                                  <input type="file" accept=".xlsx,.csv" className="hidden" onChange={e => handleFileUpload(e, 'quote')} />
                              </label>
                              <label className="block w-full p-3 border-2 border-dashed border-blue-300 rounded-lg text-center bg-white cursor-pointer hover:bg-blue-50 transition">
                                  <span className="text-blue-700 font-bold block">2. 上傳 庫存表 Excel</span>
                                  <span className="text-xs text-gray-400">上次: {dbMeta.stockDate || '無'}</span>
                                  <input type="file" accept=".xlsx,.csv" className="hidden" onChange={e => handleFileUpload(e, 'stock')} />
                              </label>
                          </div>
                          {debugInfo && (
                              <div className="bg-red-50 p-3 rounded text-xs font-mono text-red-600 overflow-x-auto">
                                  <p className="font-bold mb-1">讀取診斷區:</p>
                                  <pre>{debugInfo}</pre>
                              </div>
                          )}
                      </div>
                  ) : <div className="text-center py-8 text-gray-500">權限不足</div>}
                  <div className="border-t mt-6 pt-4">
                      <h4 className="font-bold mb-2 text-sm text-gray-700">表頭設定 (本地)</h4>
                      <input type="text" placeholder="公司名" className="w-full p-2 border rounded mb-2 text-sm" value={companyInfo.name} onChange={e=>setCompanyInfo({...companyInfo, name: e.target.value})}/>
                      <button onClick={()=>{localStorage.setItem('v6_company', JSON.stringify(companyInfo)); alert('已儲存');}} className="w-full bg-gray-100 text-gray-600 py-2 rounded font-bold text-sm">儲存設定</button>
                  </div>
              </div>
          </div>
      );

      const SpecModal = () => {
          const [search, setSearch] = useState('');
          const filtered = Object.keys(productDB).filter(n => n.includes(search));
          return (
             <div className="fixed inset-0 bg-black/40 z-50 flex items-center justify-center p-4 animate-in fade-in">
                <div className="bg-white w-full max-w-lg rounded-2xl p-5 shadow-2xl h-[85vh] flex flex-col">
                   <div className="flex justify-between items-center mb-2 shrink-0">
                      <h3 className="font-black text-lg">選擇規格 <span className="text-sm text-blue-600">({customerPriceTier})</span></h3>
                      <button onClick={() => setShowSpecLookup(false)} className="bg-gray-100 p-2 rounded-full"><LucideIcon name="X" size={20}/></button>
                   </div>
                   <input autoFocus placeholder="搜尋品名..." value={search} onChange={e=>setSearch(e.target.value)} className="w-full p-3 border rounded-xl bg-blue-50 font-bold mb-2 outline-none shrink-0"/>
                   <div className="overflow-y-auto flex-1 space-y-4">
                      {filtered.map(name => (
                          <div key={name} className="border rounded-xl overflow-hidden shadow-sm">
                              <div className="bg-gray-50 px-4 py-2 font-black border-b">{name}</div>
                              {productDB[name].map((spec, i) => {
                                  const stocks = inventoryDB[spec.id] || [];
                                  const total = stocks.reduce((s, x) => s + x.stock, 0);
                                  return (
                                      <div key={i} onClick={() => applySpec(spec)} className="p-4 border-b hover:bg-blue-50 cursor-pointer active:bg-blue-100 transition">
                                          <div className="flex justify-between mb-1">
                                              <span className="font-bold text-blue-900">{spec.specDetail}</span>
                                              <div className="text-right">
                                                  <span className="block font-black">${spec.prices[customerPriceTier]||0}</span>
                                                  <span className={`text-xs px-2 py-0.5 rounded ${total>0?'bg-green-100 text-green-700':'bg-red-100 text-red-600'}`}>總存: {total}</span>
                                              </div>
                                          </div>
                                          {stocks.length > 0 && <div className="flex flex-wrap gap-1 mb-1">{stocks.map((s,k)=><span key={k} className="text-[10px] bg-gray-100 border px-1 rounded text-gray-600">{s.warehouse}:<b className="text-black ml-0.5">{s.stock}</b></span>)}</div>}
                                          <div className="text-xs text-gray-400 flex gap-2"><span>{spec.id}</span><span>箱容:{spec.pack}{spec.smallUnit}</span></div>
                                          {spec.note && <div className="text-xs text-orange-500 mt-1">{spec.note}</div>}
                                      </div>
                                  );
                              })}
                          </div>
                      ))}
                      {filtered.length===0 && <div className="text-center py-10 text-gray-400">查無資料</div>}
                   </div>
                </div>
             </div>
          );
      };

      if (!isAuthenticated) {
          return (
              <div className="min-h-screen login-bg flex items-center justify-center p-4">
                  <div className="bg-white/90 backdrop-blur rounded-2xl p-8 shadow-2xl w-full max-w-sm text-center">
                      <div className="mb-6 flex justify-center"><div className="bg-blue-600 p-4 rounded-full text-white shadow-lg"><LucideIcon name="Cloud" size={40}/></div></div>
                      <h1 className="text-2xl font-black text-slate-800 mb-2">八方環球 V9.1</h1>
                      <form onSubmit={handleLogin} className="space-y-4 mt-6">
                          <input type="password" className="w-full text-center text-2xl font-black p-3 border-b-4 border-blue-600 bg-slate-100 rounded focus:bg-white transition" placeholder="密碼" maxLength={4} value={loginInput} onChange={e => setLoginInput(e.target.value)} autoFocus />
                          <button type="submit" className="w-full py-4 bg-blue-600 text-white rounded-xl font-black text-lg shadow-xl active:scale-95 transition">登 入</button>
                      </form>
                  </div>
              </div>
          );
      }

      if (viewMode === 'preview') {
          return (
            <div className="min-h-screen bg-white pb-12">
               <div className="bg-blue-900 text-white p-4 sticky top-0 z-50 flex justify-between items-center no-print">
                   <div className="flex items-center gap-4">
                      <button onClick={() => setViewMode('edit')} className="flex items-center gap-1 font-bold text-sm"><LucideIcon name="ChevronLeft"/> 返回</button>
                      <div className="flex bg-blue-800 rounded p-1">
                         <button onClick={() => setPreviewFormat('mobile')} className={`px-3 py-1 rounded text-xs font-bold ${previewFormat==='mobile'?'bg-white':'text-blue-200'}`}>手機</button>
                         <button onClick={() => setPreviewFormat('a4')} className={`px-3 py-1 rounded text-xs font-bold ${previewFormat==='a4'?'bg-white':'text-blue-200'}`}>A4</button>
                      </div>
                   </div>
                   <div className="flex gap-2">
                       <button onClick={handleDownloadImage} className="bg-yellow-500 text-white px-3 py-2 rounded font-bold text-xs flex items-center gap-1"><LucideIcon name="Image" size={14}/> 轉圖片</button>
                       <button onClick={() => window.print()} className="bg-white text-blue-900 px-3 py-2 rounded font-bold text-xs flex items-center gap-1"><LucideIcon name="Printer" size={14}/> 列印</button>
                   </div>
               </div>
               
               <div ref={previewRef} className="bg-white">
                   {previewFormat === 'mobile' ? (
                      <div className="max-w-md mx-auto shadow-xl my-4 rounded-lg overflow-hidden border border-gray-200">
                         <div className="bg-blue-600 text-white p-5">
                             <h2 className="text-xl font-black">{customerInfo.name}</h2>
                             <p className="text-sm opacity-80">{customerInfo.quoteNo}</p>
                             {!isQuoteOnly && <div className="mt-4 text-3xl font-black text-right">{fmtMoney(calcTotal())}</div>}
                         </div>
                         <div className="divide-y divide-gray-100">
                             {items.map((item, i) => (
                                 <div key={i} className="p-4">
                                     <div className="flex justify-between font-bold text-lg mb-1">
                                         <span>{item.name} {item.specDetail}</span>
                                         {!isQuoteOnly && <span>{fmtMoney(item.qty * item.packingContent * item.price)}</span>}
                                     </div>
                                     <div className="text-sm text-gray-500 flex justify-between items-center">
                                         <div className="flex items-center gap-2">
                                             {item.imageBase64 && <img src={item.imageBase64} className="w-10 h-10 object-cover rounded"/>}
                                             <span>${item.price}/{item.smallUnit}</span>
                                         </div>
                                         {!isQuoteOnly && <span className="bg-blue-50 text-blue-700 px-2 py-1 rounded font-bold">{item.qty}{item.bigUnit}</span>}
                                     </div>
                                 </div>
                             ))}
                         </div>
                         <div className="p-5 bg-gray-50 text-sm text-gray-600">
                             <div className="font-bold text-black mb-2">備註:</div>
                             <pre className="whitespace-pre-wrap font-sans">{companyInfo.bankInfo}</pre>
                         </div>
                      </div>
                   ) : (
                      <div className="max-w-[210mm] mx-auto p-8 shadow-xl my-4 print:shadow-none print:my-0 print:p-0">
                          <div className="flex justify-between items-end border-b-2 border-black pb-4 mb-6">
                              <div><h1 className="text-3xl font-black">{isQuoteOnly ? '報 價 單' : '銷 貨 單'}</h1><p>{companyInfo.name} | {companyInfo.phone}</p></div>
                              <div className="text-right"><p>單號: <b>{customerInfo.quoteNo}</b></p><p>日期: <b>{customerInfo.date}</b></p></div>
                          </div>
                          <div className="mb-6 p-3 border rounded"><p>客戶: <b>{customerInfo.name}</b></p><p>地址: {customerInfo.address}</p></div>
                          <table className="w-full text-sm border-collapse border border-black mb-6">
                              <thead><tr className="bg-gray-100 text-black"><th className="border p-2">No.</th><th className="border p-2 text-left">品名規格</th>{!isQuoteOnly && <th className="border p-2">數量</th>}<th className="border p-2 text-right">單價</th>{!isQuoteOnly && <th className="border p-2 text-right">金額</th>}</tr></thead>
                              <tbody>
                                  {items.map((item, i) => (
                                      <tr key={i}>
                                          <td className="border p-2 text-center">{i+1}</td>
                                          <td className="border p-2">
                                              <div className="flex items-center gap-2">
                                                  {item.imageBase64 && <img src={item.imageBase64} className="w-12 h-12 object-cover rounded border border-gray-200" />}
                                                  <div className="A4-product-name">{item.name} {item.specDetail}</div>
                                              </div>
                                          </td>
                                          {!isQuoteOnly && <td className="border p-2 text-center font-bold">{item.qty} {item.bigUnit}</td>}
                                          <td className="border p-2 text-right">${item.price}</td>
                                          {!isQuoteOnly && <td className="border p-2 text-right font-bold">{fmtMoney(item.qty * item.packingContent * item.price)}</td>}
                                      </tr>
                                  ))}
                              </tbody>
                          </table>
                          {!isQuoteOnly && <div className="text-right text-2xl font-black mb-8">總計: {fmtMoney(calcTotal())}</div>}
                          <div className="border p-4 text-sm bg-gray-50"><p className="font-bold">匯款資訊:</p><pre className="whitespace-pre-wrap">{companyInfo.bankInfo}</pre></div>
                      </div>
                   )}
               </div>
            </div>
          );
      }

      return (
        <div className="min-h-screen pb-32 font-sans bg-slate-50">
          {showAdmin && <AdminPanel />}
          {showSpecLookup && <SpecModal />}
          {showPricePicker && <PricePickerModal />}

          <div className="bg-white border-b px-4 py-3 sticky top-0 z-30 flex justify-between items-center shadow-sm">
            <div className="flex items-center gap-2">
               <div className={`text-white p-2 rounded-lg ${connectionStatus==='connected'?'bg-green-600':(connectionStatus==='error'?'bg-red-500':'bg-blue-600')}`}>
                   <LucideIcon name="Cloud" size={20}/>
               </div>
               <div>
                   <h1 className="text-lg font-black text-slate-800">八方環球 V9.1</h1>
                   {isSyncing ? <span className="text-xs text-blue-500">連線中...</span> : 
                    (connectionStatus==='connected' ? <span className="text-[10px] text-green-600 font-bold">● 已連線</span> :
                     connectionStatus==='error' ? <span className="text-[10px] text-red-500 font-bold">● 連線失敗</span> : 
                     <span className="text-[10px] text-gray-400">● 初始化...</span>)
                   }
               </div>
            </div>
            <div className="flex gap-2">
                <button onClick={() => setShowAdmin(true)} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200 relative">
                    <LucideIcon name="Database" size={20}/>
                    {userRole === 'admin' && <span className="absolute top-0 right-0 w-2 h-2 bg-green-500 rounded-full"></span>}
                </button>
                <button onClick={handleLogout} className="p-2 bg-red-50 text-red-500 rounded-full hover:bg-red-100"><LucideIcon name="LogOut" size={20}/></button>
            </div>
          </div>

          <div className="max-w-3xl mx-auto p-4 space-y-4">
            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
               <div className="flex justify-between mb-4 border-b pb-2"><span className="text-xs font-black text-blue-600">ORDER INFO</span><div className="flex items-center gap-2"><input type="date" value={customerInfo.date} onChange={e => setCustomerInfo({...customerInfo, date: e.target.value})} className="bg-gray-100 px-2 py-1 rounded"/><label className="flex items-center gap-1 text-xs font-bold bg-gray-50 px-2 py-1 rounded"><input type="checkbox" checked={isQuoteOnly} onChange={e => setIsQuoteOnly(e.target.checked)}/> 純報價</label></div></div>
               <div className="grid grid-cols-3 gap-4">
                   <div className="col-span-2"><input type="text" placeholder="客戶名稱" className="w-full text-xl font-black border-b-2 py-1 outline-none focus:border-blue-600" value={customerInfo.name} onChange={e => setCustomerInfo({...customerInfo, name: e.target.value})} /></div>
                   <div className="col-span-1"><select value={customerPriceTier} onChange={e => setCustomerPriceTier(e.target.value)} className="w-full h-full font-bold text-blue-700 bg-blue-50 rounded-lg text-center outline-none">{priceTiers.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                   <input type="text" placeholder="統編" className="p-2 bg-gray-50 rounded text-sm" value={customerInfo.taxId} onChange={e => setCustomerInfo({...customerInfo, taxId: e.target.value})}/>
                   <input type="text" placeholder="聯絡人" className="p-2 bg-gray-50 rounded text-sm" value={customerInfo.contact} onChange={e => setCustomerInfo({...customerInfo, contact: e.target.value})}/>
                   <select value={customerInfo.paymentMethod} onChange={e => setCustomerInfo({...customerInfo, paymentMethod: e.target.value})} className="p-2 bg-gray-50 rounded font-bold text-sm">{['現金', '月結30', '月結60', '匯款'].map(m => <option key={m} value={m}>{m}</option>)}</select>
               </div>
            </div>

            <div className="space-y-3">
               {items.map((item, index) => (
                   <div key={item.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-200 relative group">
                       <div className="absolute top-3 right-3 flex gap-1 z-10">
                           <button onClick={() => removeItem(item.id)} className="p-1.5 bg-red-50 rounded text-red-500 hover:bg-red-100"><LucideIcon name="Trash2" size={16}/></button>
                       </div>
                       <div className="flex gap-3 mb-3 pr-10" onClick={() => openSpecLookup(item.id)}>
                           <div className="w-8 h-8 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center font-black text-sm shrink-0 mt-1">{index+1}</div>
                           <div className="cursor-pointer">
                               <div className={`text-lg font-black leading-tight ${!item.name ? 'text-gray-300' : 'text-gray-800'}`}>{item.name || '點擊選擇產品...'}</div>
                               {item.specDetail && <div className="text-sm font-bold text-blue-600 mt-1">{item.specDetail}</div>}
                           </div>
                       </div>
                       <div className="grid grid-cols-12 gap-3 items-end">
                           <div className="col-span-4"><label className="text-[10px] font-bold text-gray-400 uppercase">數量</label><div className="flex items-center border-b"><input type="number" className="w-full text-xl font-black text-center outline-none number-input-lg" value={item.qty || ''} onChange={e => updateItem(item.id, 'qty', handleNumeric(e))}/><select value={item.bigUnit} onChange={e => updateItem(item.id, 'bigUnit', e.target.value)} className="text-sm font-bold bg-transparent outline-none">{['件','箱','籃','保'].map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                           <div className="col-span-4"><label className="text-[10px] font-bold text-gray-400 uppercase">單價</label>
                                <div className="flex items-center border-b">
                                    <input type="number" className="w-full text-xl font-black text-center outline-none number-input-lg" value={item.price || ''} onChange={e => updateItem(item.id, 'price', handleNumeric(e))}/>
                                    <button onClick={() => openPricePicker(item.id)} className="text-blue-500 hover:text-blue-700 p-1"><LucideIcon name="DollarSign" size={16}/></button>
                                </div>
                           </div>
                           <div className="col-span-4 text-right"><div className="text-xl font-black text-gray-900">{fmtMoney(item.qty * item.packingContent * item.price)}</div><div className="text-[10px] font-bold text-gray-400">小計</div></div>
                       </div>
                       <div className="mt-3 pt-3 border-t border-dashed border-gray-100 flex justify-between items-center">
                           <label className={`flex items-center gap-1 text-xs font-bold px-2 py-1 rounded cursor-pointer hover:bg-blue-100 transition ${uploadingImageId === item.id ? 'text-gray-400' : 'text-blue-600 bg-blue-50'}`}>
                               {uploadingImageId === item.id ? <><div className="loader w-3 h-3 border-gray-400 mr-1"></div> 處理中...</> : <><LucideIcon name="Image" size={14}/> {item.imageBase64 ? '更換' : '圖片'}</>}
                               <input type="file" className="hidden" accept="image/*" disabled={uploadingImageId === item.id} onChange={e => handleImageUpload(e, item.id)}/>
                           </label>
                           {item.imageBase64 && <img src={item.imageBase64} className="w-10 h-10 rounded object-cover border border-gray-200"/>}
                           <div className="text-xs text-gray-400 font-medium">箱容: {item.packingContent}{item.smallUnit}</div>
                       </div>
                   </div>
               ))}
               <button onClick={addItem} className="w-full py-4 rounded-2xl border-2 border-dashed border-gray-300 text-gray-400 font-bold hover:border-blue-500 hover:text-blue-600 hover:bg-blue-50 transition flex items-center justify-center gap-2"><LucideIcon name="Plus"/> 新增項目</button>
            </div>
          </div>
          
          <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-3 px-5 flex justify-between items-center z-40 safe-area-bottom shadow-lg">
               <div><div className="text-[10px] font-bold text-gray-400 uppercase">TOTAL</div><div className="text-2xl font-black text-blue-800">{isQuoteOnly ? '---' : fmtMoney(calcTotal())}</div></div>
               <div className="flex gap-2">
                   <button onClick={() => setViewMode('preview')} className="bg-blue-600 text-white px-4 py-3 rounded-full font-bold shadow-lg flex items-center gap-2">預覽 <LucideIcon name="ArrowRight" size={18}/></button>
                   <button onClick={() => {
                        let msg = `【${customerInfo.name}】${customerInfo.quoteNo}\n------------------\n`;
                        items.forEach(i => { if(i.name) msg += `${i.name} ${i.specDetail}\n數量: ${i.qty}${i.bigUnit} (單價$${i.price})\n`; });
                        if(!isQuoteOnly) msg += `------------------\n總計: ${fmtMoney(calcTotal())}\n`;
                        msg += `\n備註: ${companyInfo.bankInfo}`;
                        window.open(`https://line.me/R/msg/text/?${encodeURIComponent(msg)}`);
                   }} className="bg-green-600 text-white px-4 py-3 rounded-full font-bold shadow-lg flex items-center gap-2">LINE <LucideIcon name="Send" size={18}/></button>
               </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>