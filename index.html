<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å…«æ–¹ç’°çƒ ERP V12.0 - ç¾ä»£åŒ–è³¼ç‰©è»Šå ±åƒ¹ç³»çµ± ğŸ›’</title>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    window.firebaseModules = { initializeApp, getDatabase, ref, set, onValue, remove };
  </script>

  <style>
    /* ğŸ¨ V12.0 ç¾ä»£åŒ–æ¨£å¼ - å…¨æ–°è¨­è¨ˆï¼ */
    body { 
      -webkit-tap-highlight-color: transparent; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      min-height: 100vh;
    }
    
    /* ğŸŒŠ ç»ç’ƒæ“¬æ…‹æ•ˆæœ */
    .glass {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .glass-dark {
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
    
    /* ğŸ’ ç¾ä»£åŒ–å¡ç‰‡é™°å½± */
    .card-shadow {
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12),
                  0 1px 8px rgba(0, 0, 0, 0.08);
    }
    
    .card-shadow-lg {
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15),
                  0 10px 30px rgba(0, 0, 0, 0.12);
    }
    
    /* ğŸ¨ æ¼¸è®ŠæŒ‰éˆ• */
    .btn-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
    }
    
    .btn-gradient:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
    }
    
    .btn-gradient:active {
      transform: translateY(0);
    }
    
    /* ğŸŒˆ æ¼¸è®Šæ–‡å­— */
    .text-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    /* âœ¨ æµæš¢å‹•ç•« */
    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .animate-slide-up { animation: slideUp 0.4s ease-out; }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    .animate-pulse { animation: pulse 2s ease-in-out infinite; }
    
    /* ğŸ¯ è³¼ç‰©è»Šå¾½ç«  */
    .cart-badge {
      animation: pulse 2s ease-in-out infinite;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
    }
    
    /* ğŸ¯ åº«å­˜ç‹€æ…‹å¾½ç«  */
    .badge-green {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }
    
    .badge-yellow {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }
    
    .badge-red {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }
    
    /* ğŸª è¼‰å…¥å‹•ç•« */
    .loader { 
      border: 3px solid rgba(255, 255, 255, 0.3); 
      border-top: 3px solid #fff; 
      border-radius: 50%; 
      width: 20px; 
      height: 20px; 
      animation: spin 1s linear infinite; 
    }
    
    /* SVG åœ–ç¤º */
    .icon-svg { width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    .icon-svg-sm { width: 16px; height: 16px; }
    .icon-svg-lg { width: 24px; height: 24px; }
    
    /* ğŸ“œ éš±è—æ»¾å‹•æ¢ */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* ğŸ–¨ï¸ åˆ—å°æ¨£å¼ */
    @media print {
      body { background: white !important; }
      .no-print { display: none !important; }
      .glass { background: white !important; backdrop-filter: none !important; }
      @page { size: A4; margin: 15mm; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // SVG åœ–ç¤º
    const Icons = {
      Star: ({filled, className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24" fill={filled ? "currentColor" : "none"}>
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
      ),
      Camera: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
          <circle cx="12" cy="13" r="4"/>
        </svg>
      ),
      Copy: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
        </svg>
      ),
      Trash: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <polyline points="3 6 5 6 21 6"/>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
        </svg>
      ),
      Plus: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
      ),
      Eye: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
      ),
      Send: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <line x1="22" y1="2" x2="11" y2="13"/>
          <polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      ),
      Clock: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
      ),
      Save: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
          <polyline points="17 21 17 13 7 13 7 21"/>
          <polyline points="7 3 7 8 15 8"/>
        </svg>
      ),
      Sparkles: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>
        </svg>
      ),
      DollarSign: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <line x1="12" y1="1" x2="12" y2="23"/>
          <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
        </svg>
      ),
      Package: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/>
          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
          <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
          <line x1="12" y1="22.08" x2="12" y2="12"/>
        </svg>
      ),
      User: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
          <circle cx="12" cy="7" r="4"/>
        </svg>
      ),
      Upload: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
      ),
      Settings: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="3"/>
          <path d="M12 1v6m0 6v6M5.6 5.6l4.2 4.2m4.2 4.2l4.2 4.2M1 12h6m6 0h6M5.6 18.4l4.2-4.2m4.2-4.2l4.2-4.2"/>
        </svg>
      ),
      Search: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
      ),
      FileText: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
          <line x1="16" y1="13" x2="8" y2="13"/>
          <line x1="16" y1="17" x2="8" y2="17"/>
          <polyline points="10 9 9 9 8 9"/>
        </svg>
      ),
      // ğŸ†• åº•éƒ¨å°èˆªå°ˆç”¨åœ–ç¤º
      Home: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          <polyline points="9 22 9 12 15 12 15 22"/>
        </svg>
      ),
      ShoppingCart: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <circle cx="9" cy="21" r="1"/>
          <circle cx="20" cy="21" r="1"/>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
        </svg>
      ),
      History: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
      ),
      Settings: ({className=""}) => (
        <svg className={`icon-svg ${className}`} viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="3"/>
          <path d="M12 1v6m0 6v6m-9-9h6m6 0h6"/>
        </svg>
      ),
    };

    // CONFIG
    const CONFIG = {
        firebase: {
            apiKey: "AIzaSyD59OwEnbcLZShhTTJJMu1VjJxrvzIcG_g",
            authDomain: "seafoodq-11b9d.firebaseapp.com",
            databaseURL: "https://seafoodq-11b9d-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "seafoodq-11b9d",
            storageBucket: "seafoodq-11b9d.firebasestorage.app",
            messagingSenderId: "454420146806",
            appId: "1:454420146806:web:802e6bd5e8e90aab21cd57"
        },
        pwd: { ADMIN: "8888", SALES: "1688" }
    };

    // å·¥å…·å‡½å¼
    const cleanStr = (s) => s ? String(s).trim() : '';
    const sanitizeKey = (s) => s ? String(s).replace(/[.#$/\[\]]/g, '_').trim() : '';
    const parseNum = (v) => {
        if (!v) return 0;
        if (typeof v === 'number') return v;
        const n = String(v).replace(/,/g, '').match(/-?\d+(\.\d+)?/);
        return n ? parseFloat(n[0]) : 0;
    };

    let db = null;

    // ä¸»æ‡‰ç”¨
    const App = () => {
      const [page, setPage] = useState('login');
      const [currentTab, setCurrentTab] = useState('home'); // ğŸ†• åº•éƒ¨å°èˆªåˆ†é 
      const [role, setRole] = useState('');
      const [status, setStatus] = useState('æœªé€£ç·š');
      const [data, setData] = useState({ 
        products: {}, 
        inventory: {}, 
        tiers: ['é–€å¸‚å”®åƒ¹', 'æœƒå“¡95%', 'é¤å»³90%', 'ç”Ÿæ„åƒ¹', 'æ•´ä»¶åƒ¹', 'VIPåƒ¹', 'æ¥­å‹™åº•åƒ¹'], 
        meta: {} 
      });
      const [inputPwd, setInputPwd] = useState('');
      
      // å ±åƒ¹ç‹€æ…‹
      const [cart, setCart] = useState([
        {
          cartId: Date.now(),
          id: 'DEMO001',
          name: 'ç”Ÿç™½è¦',
          specDetail: '40/50*850G*12ç›’*å—ç¾',
          qty: 1,
          price: 280,
          selectedTier: 'VIPåƒ¹',  // è¨˜éŒ„è©²ç”¢å“ç•¶å‰ä½¿ç”¨çš„åƒ¹æ ¼ç­‰ç´š
          note: 'é»æ“Šç”¢å“åç¨±å¯é‡æ–°é¸æ“‡ï¼Œé»æ“Šè¦æ ¼å¯æœå°‹åŒå“å',
          smallUnit: 'ä»¶',
          bigUnit: 'ä»¶',
          pack: 1,
          prices: {
            'é–€å¸‚å”®åƒ¹': 450, 
            'æœƒå“¡95%': 428, 
            'é¤å»³90%': 405, 
            'ç”Ÿæ„åƒ¹': 350, 
            'æ•´ä»¶åƒ¹': 320, 
            'VIPåƒ¹': 280, 
            'æ¥­å‹™åº•åƒ¹': 250
          },
          image: ''
        }
      ]);
      const [custInfo, setCustInfo] = useState({ 
        name: '', phone: '', mobile: '', address: '', 
        date: new Date().toISOString().split('T')[0], 
        tier: 'é–€å¸‚å”®åƒ¹',
        paymentMethod: 'æœˆçµ30å¤©'
      });
      
      // å½ˆçª—ç‹€æ…‹
      const [showProductSearch, setShowProductSearch] = useState(false);
      const [showPriceModal, setShowPriceModal] = useState(false);
      const [showHistory, setShowHistory] = useState(false);
      const [search, setSearch] = useState('');
      const [currentPriceItem, setCurrentPriceItem] = useState(null);
      const [reSelectCartId, setReSelectCartId] = useState(null); // é‡æ–°é¸æ“‡ç”¢å“çš„ cartId
      
      // æœ¬åœ°å„²å­˜
      const [quotes, setQuotes] = useState([]);

      // è¼‰å…¥æœ¬åœ°è³‡æ–™
      useEffect(() => {
        const saved = localStorage.getItem('erpQuotesV11');
        if (saved) {
          try {
            setQuotes(JSON.parse(saved));
          } catch (e) {}
        }
      }, []);

      const saveLocal = () => {
        localStorage.setItem('erpQuotesV11', JSON.stringify(quotes));
      };

      // Firebase åˆå§‹åŒ–
      const initDB = () => {
        if (db) return true;
        if (!window.firebaseModules) return false;
        try {
            const { initializeApp, getDatabase } = window.firebaseModules;
            const app = initializeApp(CONFIG.firebase);
            db = getDatabase(app);
            return true;
        } catch (e) {
            alert("Firebase åˆå§‹åŒ–å¤±æ•—: " + e.message);
            return false;
        }
      };

      // ç›£è½è³‡æ–™
      const listenDB = () => {
          if (!initDB()) return;
          const { ref, onValue } = window.firebaseModules;
          setStatus('é€£ç·šä¸­...');
          onValue(ref(db, 'seafoodData'), (snap) => {
              const val = snap.val();
              if (val) {
                  setData({
                      products: val.productDB || {},
                      inventory: val.inventoryDB || {},
                      tiers: val.priceTiers || ['ç”Ÿæ„åƒ¹'],
                      meta: val.dbMeta || {}
                  });
                  setStatus('â— å·²é€£ç·š');
              } else {
                  setStatus('â— è³‡æ–™åº«ç‚ºç©º');
              }
          }, (err) => setStatus('é€£ç·šéŒ¯èª¤'));
      };

      // ç™»å…¥
      const handleLogin = () => {
          if (inputPwd === CONFIG.pwd.ADMIN) {
              setRole('admin');
              setPage('main'); // ğŸ†• æ”¹æˆ main
              setCurrentTab('home'); // ğŸ†• é è¨­é¡¯ç¤ºé¦–é 
              listenDB();
          } else if (inputPwd === CONFIG.pwd.SALES) {
              setRole('sales');
              setPage('main'); // ğŸ†• æ”¹æˆ main
              setCurrentTab('home'); // ğŸ†• é è¨­é¡¯ç¤ºé¦–é 
              listenDB();
          } else {
              alert("å¯†ç¢¼éŒ¯èª¤");
          }
      };

      // Excel ä¸Šå‚³
      const handleUpload = (e, type) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const fileName = file.name.toLowerCase();
          const reader = new FileReader();
          
          reader.onload = (evt) => {
              try {
                  let wb;
                  
                  // CSV æª”æ¡ˆéœ€è¦ Big5 è§£ç¢¼
                  if (fileName.endsWith('.csv')) {
                      const decoder = new TextDecoder("big5");
                      const csvText = decoder.decode(new Uint8Array(evt.target.result));
                      wb = XLSX.read(csvText, { type: 'string' });
                  } 
                  // Excel æª”æ¡ˆç›´æ¥è®€å–äºŒé€²ä½
                  else {
                      const data = new Uint8Array(evt.target.result);
                      wb = XLSX.read(data, { type: 'array' });
                  }
                  
                  const ws = wb.Sheets[wb.SheetNames[0]];
                  const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
                  
                  console.log('è®€å–åˆ°', rows.length, 'è¡Œè³‡æ–™');
                  
                  if (type === 'stock') processStock(rows);
                  else if (type === 'quote') processQuote(rows);

              } catch (err) {
                  console.error('è®€å–éŒ¯èª¤:', err);
                  alert("è®€å–å¤±æ•—ï¼š" + err.message + "\n\nè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º");
              }
          };
          
          reader.onerror = () => {
              alert("æª”æ¡ˆè®€å–å¤±æ•—ï¼Œè«‹é‡è©¦");
          };
          
          reader.readAsArrayBuffer(file);
          e.target.value = null;
      };

      const processStock = (rows) => {
          console.log('é–‹å§‹è™•ç†åº«å­˜è³‡æ–™ï¼Œç¸½è¡Œæ•¸:', rows.length);
          
          let headerIdx = -1;
          for(let i=0; i<Math.min(rows.length, 20); i++) {
              const str = rows[i].join('');
              if (str.includes('å“è™Ÿ') && (str.includes('åº«åˆ¥') || str.includes('å€‰åº«'))) {
                  headerIdx = i; 
                  console.log('æ‰¾åˆ°æ¨™é¡Œåˆ—æ–¼ç¬¬', i+1, 'è¡Œ:', rows[i]);
                  break;
              }
          }
          if (headerIdx === -1) { 
              alert("âŒ æ‰¾ä¸åˆ°æ¨™é¡Œåˆ—\n\nè«‹ç¢ºèª Excel æª”æ¡ˆåŒ…å«ã€Œå“è™Ÿã€å’Œã€Œåº«åˆ¥ã€æ¬„ä½");
              console.error('å‰20è¡Œå…§å®¹:', rows.slice(0, 20));
              return; 
          }

          const headers = rows[headerIdx].map(h => cleanStr(h || ''));
          const rawData = rows.slice(headerIdx + 1);
          const idxPid = headers.findIndex(h => h && h.includes('å“è™Ÿ'));
          const idxName = headers.findIndex(h => h && h.includes('å“å'));
          const idxSpec = headers.findIndex(h => h && h.includes('è¦æ ¼'));
          const idxWh = headers.findIndex(h => h && (h.includes('åº«åˆ¥') || h.includes('å€‰åº«')));
          const idxQty = headers.findIndex(h => h && (h.includes('åº«å­˜') || h.includes('æ•¸é‡')));

          console.log('æ¬„ä½ç´¢å¼• - å“è™Ÿ:', idxPid, 'å“å:', idxName, 'è¦æ ¼:', idxSpec, 'åº«åˆ¥:', idxWh, 'æ•¸é‡:', idxQty);

          if (idxPid === -1 || idxWh === -1 || idxQty === -1) {
              alert("âŒ ç¼ºå°‘å¿…è¦æ¬„ä½\n\néœ€è¦ï¼šå“è™Ÿã€åº«åˆ¥ã€åº«å­˜æ•¸é‡");
              return;
          }

          const newInv = {};
          const newProds = { ...data.products };
          let lastPid = null;
          let count = 0, newProdCount = 0;

          rawData.forEach((row, index) => {
              if (!row || !Array.isArray(row)) return;
              
              let pid = sanitizeKey(cleanStr(row[idxPid] || ''));
              const wh = cleanStr(row[idxWh] || '');
              const qty = parseNum(row[idxQty]);
              if (!wh) return;
              if (!pid && lastPid) pid = lastPid;
              else if (pid) lastPid = pid;
              if (!pid) return;

              if (qty !== 0) {
                  if (!newInv[pid]) newInv[pid] = [];
                  if (!newInv[pid].some(x => x.warehouse === wh)) {
                      newInv[pid].push({ warehouse: wh, stock: qty });
                      count++;
                  }
              }

              const name = cleanStr(row[idxName] || '');
              if (name && newInv[pid]) {
                  const safeName = sanitizeKey(name);
                  if (!newProds[safeName]) newProds[safeName] = [];
                  if (!newProds[safeName].find(s => s.id === pid)) {
                      newProds[safeName].push({
                          id: pid, name: name, specDetail: cleanStr(row[idxSpec] || ''),
                          prices: {"é–€å¸‚å”®åƒ¹":0, "æœƒå“¡95%":0, "é¤å»³90%":0, "ç”Ÿæ„åƒ¹":0, "æ•´ä»¶åƒ¹":0, "VIPåƒ¹":0, "æ¥­å‹™åº•åƒ¹":0}, 
                          note: '(åº«å­˜è£œå…¥)', pack: 1, smallUnit:'ä»¶', bigUnit:'ä»¶'
                      });
                      newProdCount++;
                  }
              }
          });

          console.log('è™•ç†å®Œæˆ - åº«å­˜ç­†æ•¸:', count, 'æ–°ç”¢å“:', newProdCount);

          if (count === 0) {
              alert("âŒ ç„¡æœ‰æ•ˆè³‡æ–™\n\nè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹æ˜¯å¦æ­£ç¢º");
              return;
          }

          // ä½¿ç”¨ setTimeout ç¢ºä¿å½ˆçª—åœ¨ä¸»åŸ·è¡Œç·’
          setTimeout(() => {
              const confirmed = window.confirm(`âœ… è§£ææˆåŠŸï¼\n\nåº«å­˜è³‡æ–™ï¼š${count} ç­†\næ–°å¢ç”¢å“ï¼š${newProdCount} ç­†\n\nç¢ºèªä¸Šå‚³åˆ° Firebaseï¼Ÿ`);
              if (confirmed) {
                  uploadDB({ 
                      inventoryDB: newInv, 
                      productDB: newProds, 
                      dbMeta: { 
                          ...(data.meta || {}), 
                          stockDate: new Date().toLocaleString('zh-TW'),
                          lastUpdate: new Date().toISOString()
                      } 
                  });
              }
          }, 100);
      };

      const processQuote = (rows) => {
          console.log('é–‹å§‹è™•ç†å ±åƒ¹è³‡æ–™ï¼Œç¸½è¡Œæ•¸:', rows.length);
          
          let headerIdx = -1;
          // å°‹æ‰¾çœŸæ­£çš„æ¨™é¡Œåˆ—ï¼šå¿…é ˆåŒæ™‚åŒ…å«ã€Œå“è™Ÿã€å’Œã€Œå“åã€
          for(let i=0; i<Math.min(rows.length, 20); i++) {
              const row = rows[i];
              if (!row || row.length === 0) continue;
              
              // å°‡æ•´è¡Œè½‰æˆå­—ä¸²æª¢æŸ¥
              const rowStr = row.join('|');
              
              // å¿…é ˆåŒæ™‚åŒ…å«ã€Œå“è™Ÿã€å’Œã€Œå“åã€æ‰ç®—æ˜¯çœŸæ­£çš„æ¨™é¡Œåˆ—
              if (rowStr.includes('å“è™Ÿ') && rowStr.includes('å“å')) {
                  headerIdx = i; 
                  console.log('æ‰¾åˆ°æ¨™é¡Œåˆ—æ–¼ç¬¬', i+1, 'è¡Œ:', row);
                  break;
              }
          }
          
          if (headerIdx === -1) { 
              alert("âŒ æ‰¾ä¸åˆ°æ¨™é¡Œåˆ—\n\nè«‹ç¢ºèª Excel æª”æ¡ˆåŒ…å«ã€Œå“è™Ÿã€å’Œã€Œå“åã€æ¬„ä½\n\næ¨™é¡Œè¡Œæ‡‰è©²åŒæ™‚åŒ…å«é€™å…©å€‹æ¬„ä½");
              console.error('å‰20è¡Œå…§å®¹:', rows.slice(0, 20));
              return; 
          }
          
          const headers = rows[headerIdx].map(cleanStr);
          const rawData = rows.slice(headerIdx + 1);
          const idxPid = headers.findIndex(h => h && h.includes('å“è™Ÿ'));
          const idxName = headers.findIndex(h => h && h.includes('å“å'));
          const idxSpec = headers.findIndex(h => h && h.includes('è¦æ ¼'));

          console.log('æ¬„ä½ç´¢å¼• - å“è™Ÿ:', idxPid, 'å“å:', idxName, 'è¦æ ¼:', idxSpec);
          console.log('æ‰€æœ‰æ¨™é¡Œ:', headers);

          if (idxPid === -1 || idxName === -1) {
              alert("âŒ ç¼ºå°‘å¿…è¦æ¬„ä½\n\néœ€è¦ï¼šå“è™Ÿã€å“å");
              return;
          }

          const newProds = {};
          const tiers = new Set();
          let count = 0;

          rawData.forEach((row, index) => {
              if (!row || !Array.isArray(row)) return;
              
              const pid = sanitizeKey(cleanStr(row[idxPid] || ''));
              const name = cleanStr(row[idxName] || '');
              if (!pid || !name) return;

              const prices = {};
              headers.forEach((h, i) => {
                  if (!h || typeof h !== 'string') return;
                  // åƒ¹æ ¼æ¬„ä½ï¼šåŒ…å«ã€Œåƒ¹ã€å­—ï¼Œä½†ä¸åŒ…å«ã€Œè™Ÿã€ã€Œåã€ã€Œè³‡æ–™ã€ã€Œå»ºç«‹ã€ã€Œä½œæ¥­ã€
                  if ((h.includes('åƒ¹') || h.includes('+')) && 
                      !h.includes('è™Ÿ') && 
                      !h.includes('å') &&
                      !h.includes('è³‡æ–™') &&
                      !h.includes('å»ºç«‹') &&
                      !h.includes('ä½œæ¥­')) {
                      const cellValue = row[i];
                      // å¦‚æœå„²å­˜æ ¼æ˜¯ç©ºç™½ã€undefinedã€nullï¼Œå°±è·³é
                      if (cellValue === undefined || cellValue === null || cellValue === '') return;
                      
                      const v = parseNum(cellValue);
                      // åªè¦èƒ½è§£ææˆæ•¸å­—ï¼ˆåŒ…æ‹¬ 0ï¼‰ï¼Œå°±åŠ å…¥
                      if (!isNaN(v)) {
                          // æ¸…ç†åƒ¹æ ¼ç­‰ç´šåç¨±
                          let tierName = h.replace('åƒ¹æ ¼','').replace('_','').replace(/\(.*\)/g, '').trim();
                          // ç‰¹æ®Šè™•ç†ï¼šã€Œæ•´ä»¶åƒ¹(10ä»¶ä»¥ä¸‹)ã€â†’ã€Œæ•´ä»¶åƒ¹ã€
                          if (tierName.includes('æ•´ä»¶')) tierName = 'æ•´ä»¶åƒ¹';
                          prices[tierName] = v;
                          tiers.add(tierName);
                      }
                  }
              });

              // åªæœ‰ç•¶æœ‰åƒ¹æ ¼è³‡æ–™æ™‚æ‰åŠ å…¥
              if (Object.keys(prices).length > 0) {
                  const safeName = sanitizeKey(name);
                  if (!newProds[safeName]) newProds[safeName] = [];
                  newProds[safeName].push({
                      id: pid, 
                      name, 
                      specDetail: cleanStr(row[idxSpec] || '') || '', 
                      prices,
                      pack: 1, 
                      smallUnit: 'ä»¶', 
                      bigUnit: 'ä»¶' 
                  });
                  count++;
              }
          });

          console.log('è™•ç†å®Œæˆ - ç”¢å“ç­†æ•¸:', count, 'åƒ¹æ ¼ç­‰ç´š:', Array.from(tiers));

          if (count === 0) {
              alert("âŒ ç„¡æœ‰æ•ˆè³‡æ–™\n\nå¯èƒ½åŸå› ï¼š\n1. æ‰€æœ‰ç”¢å“çš„åƒ¹æ ¼éƒ½æ˜¯ 0 æˆ–ç©ºç™½\n2. åƒ¹æ ¼æ¬„ä½åç¨±ç„¡æ³•è­˜åˆ¥\n3. å“è™Ÿæˆ–å“åç‚ºç©º\n\nè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹");
              console.log('åƒ¹æ ¼æ¬„ä½æª¢æŸ¥:', headers.filter(h => h && h.includes('åƒ¹')));
              return;
          }

          // ä½¿ç”¨ setTimeout ç¢ºä¿å½ˆçª—åœ¨ä¸»åŸ·è¡Œç·’
          setTimeout(() => {
              const confirmed = window.confirm(`âœ… è§£ææˆåŠŸï¼\n\nç”¢å“æ•¸é‡ï¼š${count} ç­†\nåƒ¹æ ¼ç­‰ç´šï¼š${Array.from(tiers).join(', ')}\n\nç¢ºèªä¸Šå‚³åˆ° Firebaseï¼Ÿ`);
              if (confirmed) {
                  uploadDB({ 
                      productDB: newProds, 
                      priceTiers: Array.from(tiers), 
                      dbMeta: { 
                          ...(data.meta || {}), 
                          quoteDate: new Date().toLocaleString('zh-TW'),
                          lastUpdate: new Date().toISOString()
                      } 
                  });
              }
          }, 100);
      };

      const uploadDB = (updates) => {
          if (!initDB()) {
              alert("âŒ Firebase æœªé€£ç·š\n\nè«‹ç¢ºèªç¶²è·¯é€£ç·šæ­£å¸¸");
              return;
          }
          
          const { ref, set } = window.firebaseModules;
          
          // é‡è¦ï¼šå¾ç•¶å‰ Firebase è³‡æ–™è®€å–ï¼Œè€Œéå¾ state
          // é€™æ¨£å¯ä»¥é¿å…è¦†è“‹å…¶ä»–è³‡æ–™
          const finalData = { 
              productDB: updates.productDB !== undefined ? updates.productDB : data.products,
              inventoryDB: updates.inventoryDB !== undefined ? updates.inventoryDB : data.inventory,
              priceTiers: updates.priceTiers !== undefined ? updates.priceTiers : data.tiers,
              dbMeta: updates.dbMeta !== undefined ? updates.dbMeta : data.meta
          };
          
          console.log('æº–å‚™ä¸Šå‚³åˆ° Firebase:', {
              ç”¢å“æ•¸: Object.keys(finalData.productDB).length,
              åº«å­˜å“é …: Object.keys(finalData.inventoryDB).length,
              åƒ¹æ ¼ç­‰ç´š: finalData.priceTiers,
              æ›´æ–°é …ç›®: Object.keys(updates).join(', ')
          });
          
          // é¡¯ç¤ºä¸Šå‚³ä¸­æç¤º
          const originalStatus = status;
          setStatus('ğŸ“¤ ä¸Šå‚³ä¸­...');
          
          set(ref(db, 'seafoodData'), finalData)
            .then(() => {
                setStatus('â— å·²é€£ç·š');
                alert("âœ… ä¸Šå‚³æˆåŠŸï¼\n\nè³‡æ–™å·²åŒæ­¥åˆ°é›²ç«¯");
                console.log('ä¸Šå‚³æˆåŠŸ - æœ€çµ‚è³‡æ–™:', {
                    ç”¢å“æ•¸: Object.keys(finalData.productDB).length,
                    åº«å­˜å“é …: Object.keys(finalData.inventoryDB).length
                });
            })
            .catch(e => {
                setStatus(originalStatus);
                console.error('ä¸Šå‚³éŒ¯èª¤:', e);
                alert("âŒ ä¸Šå‚³å¤±æ•—\n\néŒ¯èª¤è¨Šæ¯ï¼š" + e.message + "\n\nè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–é‡è©¦");
            });
      };

      // è³¼ç‰©è»Šæ“ä½œ
      const addProductFromDB = (spec) => {
        if (reSelectCartId) {
          // é‡æ–°é¸æ“‡ç”¢å“ - æ›´æ–°ç¾æœ‰ç”¢å“
          setCart(cart.map(item => {
            if (item.cartId === reSelectCartId) {
              return {
                ...spec,
                cartId: item.cartId, // ä¿æŒåŸæœ‰çš„ cartId
                qty: item.qty, // ä¿æŒåŸæœ‰çš„æ•¸é‡
                price: spec.prices[custInfo.tier] || 0,
                selectedTier: custInfo.tier, // è¨˜éŒ„é¸æ“‡çš„åƒ¹æ ¼ç­‰ç´š
                note: item.note, // ä¿æŒåŸæœ‰çš„å‚™è¨»
                image: item.image // ä¿æŒåŸæœ‰çš„åœ–ç‰‡
              };
            }
            return item;
          }));
          setReSelectCartId(null);
        } else {
          // æ–°å¢ç”¢å“
          const newItem = {
            ...spec,
            cartId: Date.now(),
            qty: 1,
            price: spec.prices[custInfo.tier] || 0,
            selectedTier: custInfo.tier, // è¨˜éŒ„é¸æ“‡çš„åƒ¹æ ¼ç­‰ç´š
            note: '',
            image: ''
          };
          setCart([...cart, newItem]);
        }
        setShowProductSearch(false);
        setSearch('');
      };

      const reSelectProduct = (cartId) => {
        setReSelectCartId(cartId);
        setShowProductSearch(true);
      };

      const updateCart = (cartId, field, value) => {
        setCart(cart.map(item => item.cartId === cartId ? {...item, [field]: value} : item));
      };

      const deleteFromCart = (cartId) => {
        setCart(cart.filter(item => item.cartId !== cartId));
      };

      const copyCartItem = (cartId) => {
        const item = cart.find(i => i.cartId === cartId);
        if (item) {
          setCart([...cart, {...item, cartId: Date.now()}]);
        }
      };

      const showPriceSelector = (cartId) => {
        setCurrentPriceItem(cartId);
        setShowPriceModal(true);
      };

      const selectPrice = (tier, price) => {
        if (currentPriceItem) {
          // åŒæ™‚æ›´æ–°åƒ¹æ ¼å’Œé¸æ“‡çš„åƒ¹æ ¼ç­‰ç´š
          setCart(cart.map(item => 
            item.cartId === currentPriceItem 
              ? {...item, price: price, selectedTier: tier}
              : item
          ));
          setShowPriceModal(false);
          setCurrentPriceItem(null);
        }
      };

      const uploadImage = (cartId) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              updateCart(cartId, 'image', event.target.result);
            };
            reader.readAsDataURL(file);
          }
        };
        input.click();
      };

      const calculateSubtotal = (item) => item.qty * item.price;
      const calculateTotal = () => cart.reduce((sum, item) => sum + calculateSubtotal(item), 0);

      const saveQuote = () => {
        if (cart.length === 0) {
          alert('è«‹å…ˆæ–°å¢ç”¢å“');
          return;
        }
        const quote = {
          id: Date.now(),
          date: new Date().toISOString(),
          customer: {...custInfo},
          products: cart.map(p => ({...p})),
          total: calculateTotal()
        };
        const newQuotes = [...quotes, quote];
        setQuotes(newQuotes);
        setTimeout(() => {
          localStorage.setItem('erpQuotesV11', JSON.stringify(newQuotes));
        }, 100);
        alert('å ±åƒ¹å·²å„²å­˜ï¼');
      };

      const loadQuote = (quoteId) => {
        const quote = quotes.find(q => q.id === quoteId);
        if (quote) {
          setCustInfo({...quote.customer});
          setCart(quote.products.map(p => ({...p, cartId: Date.now() + Math.random()})));
          setShowHistory(false);
        }
      };

      const deleteQuote = (quoteId) => {
        if (confirm('ç¢ºå®šåˆªé™¤æ­¤å ±åƒ¹ï¼Ÿ')) {
          const newQuotes = quotes.filter(q => q.id !== quoteId);
          setQuotes(newQuotes);
          localStorage.setItem('erpQuotesV11', JSON.stringify(newQuotes));
        }
      };

      const printQuote = () => {
        if (cart.length === 0) {
          alert('è«‹å…ˆæ–°å¢ç”¢å“');
          return;
        }
        
        let html = `
          <html>
          <head>
            <meta charset="UTF-8">
            <title>å ±åƒ¹å–®</title>
            <style>
              @media print {
                @page { margin: 1.5cm; }
              }
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { 
                font-family: 'Microsoft JhengHei', Arial, sans-serif;
                padding: 40px;
                background: #fff;
                color: #333;
              }
              .header {
                text-align: center;
                margin-bottom: 40px;
                border-bottom: 3px solid #2563eb;
                padding-bottom: 20px;
              }
              h1 { 
                font-size: 32px;
                color: #1e40af;
                margin-bottom: 10px;
                font-weight: bold;
              }
              .company-info {
                font-size: 14px;
                color: #6b7280;
              }
              .info-section {
                background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
                padding: 20px;
                border-radius: 12px;
                margin-bottom: 30px;
                border-left: 4px solid #2563eb;
              }
              .info-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
              }
              .info-item {
                display: flex;
                align-items: center;
              }
              .info-label {
                font-weight: bold;
                color: #374151;
                min-width: 90px;
              }
              .info-value {
                color: #1f2937;
              }
              table { 
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 30px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
              }
              thead {
                background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
                color: white;
              }
              th { 
                padding: 15px 12px;
                text-align: left;
                font-weight: bold;
                font-size: 14px;
                border: none;
              }
              th:first-child { border-radius: 8px 0 0 0; }
              th:last-child { border-radius: 0 8px 0 0; }
              tbody tr {
                border-bottom: 1px solid #e5e7eb;
                transition: background 0.2s;
              }
              tbody tr:hover {
                background: #f9fafb;
              }
              tbody tr:last-child {
                border-bottom: 2px solid #2563eb;
              }
              td { 
                padding: 12px;
                font-size: 14px;
              }
              td:first-child {
                font-weight: bold;
                color: #2563eb;
                text-align: center;
                width: 50px;
              }
              .product-name {
                font-weight: bold;
                color: #1f2937;
              }
              .spec-detail {
                color: #6b7280;
                font-size: 13px;
              }
              .price-cell {
                text-align: right;
                font-weight: bold;
                color: #059669;
              }
              .note-cell {
                color: #6b7280;
                font-style: italic;
                font-size: 13px;
              }
              .total-section {
                background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
                padding: 25px;
                border-radius: 12px;
                border: 2px solid #2563eb;
                margin-top: 30px;
              }
              .total-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
              }
              .total-label {
                font-size: 20px;
                font-weight: bold;
                color: #1e40af;
              }
              .total-amount {
                font-size: 36px;
                font-weight: bold;
                color: #2563eb;
              }
              .footer {
                margin-top: 50px;
                padding-top: 20px;
                border-top: 2px solid #e5e7eb;
                text-align: center;
                color: #6b7280;
                font-size: 12px;
              }
              .back-button {
                position: fixed;
                top: 20px;
                left: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 12px 24px;
                border-radius: 12px;
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                z-index: 1000;
                transition: all 0.3s ease;
                border: none;
                font-size: 14px;
              }
              .back-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
              }
              .print-button {
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                padding: 12px 24px;
                border-radius: 12px;
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
                z-index: 1000;
                transition: all 0.3s ease;
                border: none;
                font-size: 14px;
              }
              .print-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
              }
              @media print {
                body { padding: 20px; }
                .info-section { break-inside: avoid; }
                table { break-inside: avoid; }
                tbody tr { break-inside: avoid; }
                .back-button, .print-button { display: none !important; }
              }
            </style>
          </head>
          <body>
            <button class="back-button" onclick="window.close()">â† è¿”å›</button>
            <button class="print-button" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
            
            <div class="header">
              <h1>å ±åƒ¹å–®</h1>
              <div class="company-info">Quotation</div>
            </div>

            <div class="info-section">
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">å®¢æˆ¶åç¨±ï¼š</span>
                  <span class="info-value">${custInfo.name}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">åƒ¹æ ¼ç­‰ç´šï¼š</span>
                  <span class="info-value">${custInfo.tier}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">çµå¸³æ–¹å¼ï¼š</span>
                  <span class="info-value">${custInfo.paymentMethod}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">æ—¥æœŸï¼š</span>
                  <span class="info-value">${custInfo.date}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">é›»è©±ï¼š</span>
                  <span class="info-value">${custInfo.phone}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">æ‰‹æ©Ÿï¼š</span>
                  <span class="info-value">${custInfo.mobile}</span>
                </div>
              </div>
              <div style="margin-top: 15px;">
                <span class="info-label">åœ°å€ï¼š</span>
                <span class="info-value">${custInfo.address}</span>
              </div>
            </div>

            <table>
              <thead>
                <tr>
                  <th>é …æ¬¡</th>
                  <th>ç”¢å“åç¨±</th>
                  <th>è¦æ ¼</th>
                  <th style="text-align: center;">æ•¸é‡</th>
                  <th style="text-align: right;">å–®åƒ¹</th>
                  <th style="text-align: right;">å°è¨ˆ</th>
                  <th>å‚™è¨»</th>
                </tr>
              </thead>
              <tbody>
                ${cart.map((p, i) => `
                  <tr>
                    <td>${i + 1}</td>
                    <td class="product-name">${p.name}</td>
                    <td class="spec-detail">${p.specDetail}</td>
                    <td style="text-align: center;">${p.qty} ${p.smallUnit}</td>
                    <td class="price-cell">$${p.price.toLocaleString()}</td>
                    <td class="price-cell">$${calculateSubtotal(p).toLocaleString()}</td>
                    <td class="note-cell">${p.note || '-'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>

            <div class="total-section">
              <div class="total-row">
                <span class="total-label">ç¸½é‡‘é¡</span>
                <span class="total-amount">NT$ ${calculateTotal().toLocaleString()}</span>
              </div>
            </div>

            <div class="footer">
              åˆ—å°æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')} | æ„Ÿè¬æ‚¨çš„æ”¯æŒ
            </div>
          </body>
          </html>
        `;
        
        const win = window.open('', '_blank');
        win.document.write(html);
        win.document.close();
      };

      const printQuoteNoPrice = () => {
        if (cart.length === 0) {
          alert('è«‹å…ˆæ–°å¢ç”¢å“');
          return;
        }
        
        let html = `
          <html>
          <head>
            <meta charset="UTF-8">
            <title>ç”¢å“æ¸…å–®</title>
            <style>
              @media print {
                @page { margin: 1.5cm; }
              }
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { 
                font-family: 'Microsoft JhengHei', Arial, sans-serif;
                padding: 40px;
                background: #fff;
                color: #333;
              }
              .header {
                text-align: center;
                margin-bottom: 40px;
                border-bottom: 3px solid #10b981;
                padding-bottom: 20px;
              }
              h1 { 
                font-size: 32px;
                color: #059669;
                margin-bottom: 10px;
                font-weight: bold;
              }
              .subtitle {
                font-size: 14px;
                color: #6b7280;
              }
              .info-section {
                background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
                padding: 20px;
                border-radius: 12px;
                margin-bottom: 30px;
                border-left: 4px solid #10b981;
              }
              .info-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
              }
              .info-item {
                display: flex;
                align-items: center;
              }
              .info-label {
                font-weight: bold;
                color: #374151;
                min-width: 90px;
              }
              .info-value {
                color: #1f2937;
              }
              table { 
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 30px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
              }
              thead {
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
              }
              th { 
                padding: 15px 12px;
                text-align: left;
                font-weight: bold;
                font-size: 14px;
                border: none;
              }
              th:first-child { border-radius: 8px 0 0 0; }
              th:last-child { border-radius: 0 8px 0 0; }
              tbody tr {
                border-bottom: 1px solid #e5e7eb;
                transition: background 0.2s;
              }
              tbody tr:hover {
                background: #f9fafb;
              }
              tbody tr:last-child {
                border-bottom: 2px solid #10b981;
              }
              td { 
                padding: 12px;
                font-size: 14px;
              }
              td:first-child {
                font-weight: bold;
                color: #10b981;
                text-align: center;
                width: 50px;
              }
              .product-name {
                font-weight: bold;
                color: #1f2937;
              }
              .spec-detail {
                color: #6b7280;
                font-size: 13px;
              }
              .note-cell {
                color: #6b7280;
                font-style: italic;
                font-size: 13px;
              }
              .footer {
                margin-top: 50px;
                padding-top: 20px;
                border-top: 2px solid #e5e7eb;
                text-align: center;
                color: #6b7280;
                font-size: 12px;
              }
              .watermark {
                text-align: center;
                color: #10b981;
                font-weight: bold;
                font-size: 16px;
                margin-top: 20px;
                padding: 15px;
                background: #f0fdf4;
                border-radius: 8px;
              }
              .back-button {
                position: fixed;
                top: 20px;
                left: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 12px 24px;
                border-radius: 12px;
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                z-index: 1000;
                transition: all 0.3s ease;
                border: none;
                font-size: 14px;
              }
              .back-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
              }
              .print-button {
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                padding: 12px 24px;
                border-radius: 12px;
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
                z-index: 1000;
                transition: all 0.3s ease;
                border: none;
                font-size: 14px;
              }
              .print-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
              }
              @media print {
                body { padding: 20px; }
                .info-section { break-inside: avoid; }
                table { break-inside: avoid; }
                tbody tr { break-inside: avoid; }
                .back-button, .print-button { display: none !important; }
              }
            </style>
          </head>
          <body>
            <button class="back-button" onclick="window.close()">â† è¿”å›</button>
            <button class="print-button" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
            
            <div class="header">
              <h1>ç”¢å“æ¸…å–®</h1>
              <div class="subtitle">Product List (å«å–®åƒ¹ä¸å«ç¸½é¡)</div>
            </div>

            <div class="info-section">
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">å®¢æˆ¶åç¨±ï¼š</span>
                  <span class="info-value">${custInfo.name}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">æ—¥æœŸï¼š</span>
                  <span class="info-value">${custInfo.date}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">é›»è©±ï¼š</span>
                  <span class="info-value">${custInfo.phone}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">æ‰‹æ©Ÿï¼š</span>
                  <span class="info-value">${custInfo.mobile}</span>
                </div>
              </div>
              <div style="margin-top: 15px;">
                <span class="info-label">åœ°å€ï¼š</span>
                <span class="info-value">${custInfo.address}</span>
              </div>
            </div>

            <table>
              <thead>
                <tr>
                  <th>é …æ¬¡</th>
                  <th>ç”¢å“åç¨±</th>
                  <th>è¦æ ¼</th>
                  <th style="text-align: center;">æ•¸é‡</th>
                  <th style="text-align: right;">å–®åƒ¹</th>
                  <th>å‚™è¨»</th>
                </tr>
              </thead>
              <tbody>
                ${cart.map((p, i) => `
                  <tr>
                    <td>${i + 1}</td>
                    <td class="product-name">${p.name}</td>
                    <td class="spec-detail">${p.specDetail}</td>
                    <td style="text-align: center;">${p.qty} ${p.smallUnit}</td>
                    <td class="price-cell">$${p.price.toLocaleString()}</td>
                    <td class="note-cell">${p.note || '-'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>

            <div class="watermark">
              âœ“ æœ¬æ¸…å–®å«å–®åƒ¹è³‡è¨Šï¼Œä¸å«å°è¨ˆèˆ‡ç¸½é‡‘é¡
            </div>

            <div class="footer">
              åˆ—å°æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}
            </div>
          </body>
          </html>
        `;
        
        const win = window.open('', '_blank');
        win.document.write(html);
        win.document.close();
      };

      const shareToLine = () => {
        if (cart.length === 0) {
          alert('è«‹å…ˆæ–°å¢ç”¢å“');
          return;
        }
        
        let message = `ã€å ±åƒ¹å–®ã€‘\nå®¢æˆ¶ï¼š${custInfo.name}\nåƒ¹æ ¼ç­‰ç´šï¼š${custInfo.tier}\nçµå¸³æ–¹å¼ï¼š${custInfo.paymentMethod}\næ—¥æœŸï¼š${custInfo.date}\n\n`;
        cart.forEach((p, i) => {
          message += `${i + 1}. ${p.name}\n   ${p.specDetail}\n   ${p.qty} ${p.smallUnit} Ã— $${p.price} = $${calculateSubtotal(p)}\n`;
          if (p.note) message += `   å‚™è¨»ï¼š${p.note}\n`;
          message += `\n`;
        });
        message += `ç¸½é‡‘é¡ï¼š$${calculateTotal().toLocaleString()}`;
        
        window.open(`https://line.me/R/msg/text/?${encodeURIComponent(message)}`, '_blank');
      };

      // æœå°‹çµæœ - åŒæ™‚æœå°‹ç”¢å“åç¨±å’Œè¦æ ¼
      const filteredProds = Object.keys(data.products || {}).filter(key => {
        if (!key) return false;
        // æœå°‹ç”¢å“åç¨±
        if (key.includes(search || '')) return true;
        // æœå°‹è¦æ ¼å…§å®¹
        const group = data.products[key];
        if (!group || !Array.isArray(group)) return false;
        return group.some(spec => {
          if (!spec || !spec.specDetail) return false;
          return spec.specDetail.includes(search || '');
        });
      });

      // ç™»å…¥é 
      if (page === 'login') {
        return (
          <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-indigo-100">
            <div className="glass card-shadow-lg p-8 rounded-3xl w-full max-w-sm animate-slide-up">
              <div className="text-center mb-8">
                <div className="w-16 h-16 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl mx-auto mb-4 flex items-center justify-center">
                  <Icons.Package className="icon-svg-lg text-white" />
                </div>
                <h1 className="text-3xl font-black text-gray-800">å…«æ–¹ç’°çƒ</h1>
                <p className="text-sm text-gray-500 mt-2">ERP å ±åƒ¹ç³»çµ± V12.0 ğŸš€</p>
              </div>
              
              <input 
                type="password" 
                placeholder="è«‹è¼¸å…¥å¯†ç¢¼" 
                className="w-full p-4 border-2 border-gray-200 rounded-xl mb-4 text-center text-xl focus:border-purple-500 focus:outline-none transition-colors" 
                value={inputPwd} 
                onChange={e => setInputPwd(e.target.value)}
                onKeyPress={e => e.key === 'Enter' && handleLogin()}
              />
              
              <button 
                onClick={handleLogin} 
                className="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition-all hover:scale-[1.02]"
              >
                ç™»å…¥ç³»çµ±
              </button>
              
              <div className="mt-8 pt-6 border-t border-gray-200 text-center">
                <p className="text-xs text-gray-400 mb-3">æ¸¬è©¦å¯†ç¢¼ï¼šAdmin(8888) / Sales(1688)</p>
              </div>
            </div>
          </div>
        );
      }

      // ç®¡ç†å“¡é 
      if (page === 'admin') {
        return (
          <div className="min-h-screen bg-gray-50">
            <div className="glass px-4 py-3 border-b border-white/30 flex justify-between items-center sticky top-0 z-20 card-shadow">
              <div>
                <h1 className="font-black text-lg">ç®¡ç†å“¡è¨­å®š</h1>
                <span className={`text-xs ${status.includes('å·²é€£ç·š')?'text-green-600':'text-gray-400'}`}>{status}</span>
              </div>
              <button onClick={() => setPage('quote')} className="bg-purple-500 text-white px-4 py-2 rounded-lg font-bold">è¿”å›å ±åƒ¹</button>
            </div>

            <div className="p-4 max-w-2xl mx-auto">
              <div className="glass card-shadow p-6 rounded-3xl mb-4 animate-slide-up">
                <h2 className="font-bold text-lg mb-4 flex items-center gap-2">
                  <Icons.Upload />
                  è³‡æ–™åŒ¯å…¥
                </h2>
                <div className="space-y-4">
                  <label className="block w-full p-6 border-2 border-dashed border-purple-300 bg-purple-50 text-center rounded-xl cursor-pointer hover:bg-blue-100 transition-colors">
                    <Icons.Package className="icon-svg-lg mx-auto mb-2 text-purple-600" />
                    <span className="text-blue-700 font-bold block">ğŸ“¦ ä¸Šå‚³åº«å­˜è¡¨ (XLSX/XLS/CSV)</span>
                    <span className="text-xs text-gray-500 block mt-2">å¿…é ˆåŒ…å«ï¼šå“è™Ÿã€å“åã€è¦æ ¼ã€åº«åˆ¥ã€åº«å­˜æ•¸é‡</span>
                    <input type="file" className="hidden" accept=".xlsx,.xls,.csv" onChange={e => handleUpload(e, 'stock')} />
                  </label>
                  
                  <label className="block w-full p-6 border-2 border-dashed border-green-300 bg-green-50 text-center rounded-xl cursor-pointer hover:bg-green-100 transition-colors">
                    <Icons.DollarSign className="icon-svg-lg mx-auto mb-2 text-green-600" />
                    <span className="text-green-700 font-bold block">ğŸ’° ä¸Šå‚³å ±åƒ¹è¡¨ (XLSX/XLS/CSV)</span>
                    <span className="text-xs text-gray-500 block mt-2">å¿…é ˆåŒ…å«ï¼šå“è™Ÿã€å“åã€è¦æ ¼ã€å„åƒ¹æ ¼ç­‰ç´šæ¬„ä½</span>
                    <input type="file" className="hidden" accept=".xlsx,.xls,.csv" onChange={e => handleUpload(e, 'quote')} />
                  </label>
                </div>
                
                <div className="mt-6 p-4 bg-yellow-50 border-2 border-yellow-200 rounded-xl">
                  <p className="font-bold text-sm mb-3 flex items-center gap-2">
                    <span className="text-lg">âš ï¸</span>
                    æª”æ¡ˆæ ¼å¼è¦æ±‚
                  </p>
                  <div className="space-y-2 text-xs text-gray-700">
                    <div>
                      <strong className="text-blue-700">åº«å­˜è¡¨æ¬„ä½ï¼š</strong>
                      <p className="ml-4 mt-1">å“è™Ÿã€å“åã€è¦æ ¼ã€åº«åˆ¥ï¼ˆæˆ–å€‰åº«ï¼‰ã€åº«å­˜ï¼ˆæˆ–æ•¸é‡ï¼‰</p>
                    </div>
                    <div>
                      <strong className="text-green-700">å ±åƒ¹è¡¨æ¬„ä½ï¼š</strong>
                      <p className="ml-4 mt-1">å“è™Ÿã€å“åã€è¦æ ¼ã€é–€å¸‚å”®åƒ¹ã€æœƒå“¡95%ã€é¤å»³90%ã€ç”Ÿæ„åƒ¹ã€æ•´ä»¶åƒ¹ã€VIPåƒ¹ã€æ¥­å‹™åº•åƒ¹</p>
                    </div>
                    <div className="pt-2 border-t border-yellow-300">
                      <strong>æ”¯æ´æ ¼å¼ï¼š</strong>
                      <p className="ml-4 mt-1">.xlsx (æ¨è–¦) / .xls / .csv (éœ€ Big5 ç·¨ç¢¼)</p>
                    </div>
                  </div>
                </div>
                
                <div className="mt-4 p-4 bg-purple-50 border-2 border-purple-200 rounded-xl">
                  <p className="font-bold text-sm mb-2 flex items-center gap-2">
                    <span className="text-lg">ğŸ’¡</span>
                    ä¸Šå‚³æç¤º
                  </p>
                  <ul className="space-y-1 text-xs text-gray-700 ml-6 list-disc">
                    <li>é¸æ“‡æª”æ¡ˆå¾Œæœƒè‡ªå‹•é–‹å§‹è™•ç†</li>
                    <li>è™•ç†éç¨‹æœƒé¡¯ç¤ºåœ¨ç€è¦½å™¨æ§åˆ¶å°ï¼ˆæŒ‰ F12 æŸ¥çœ‹ï¼‰</li>
                    <li>æˆåŠŸè§£æå¾Œæœƒå½ˆå‡ºç¢ºèªå°è©±æ¡†</li>
                    <li>ç¢ºèªå¾Œæ‰æœƒä¸Šå‚³åˆ° Firebase</li>
                    <li>å¦‚é‡å•é¡Œï¼Œè«‹æª¢æŸ¥æ¬„ä½åç¨±æ˜¯å¦æ­£ç¢º</li>
                  </ul>
                </div>
              </div>

              <div className="glass card-shadow p-6 rounded-3xl animate-slide-up">
                <h2 className="font-bold text-lg mb-4">ç³»çµ±è³‡è¨Š</h2>
                <div className="space-y-2 text-sm">
                  <p><strong>è³‡æ–™åº«ç‹€æ…‹ï¼š</strong>{status}</p>
                  <p><strong>ç”¢å“æ•¸é‡ï¼š</strong>{Object.keys(data.products).length} é …</p>
                  <p><strong>åƒ¹æ ¼ç­‰ç´šï¼š</strong>{data.tiers.join(', ')}</p>
                  {data.meta.stockDate && <p><strong>åº«å­˜æ›´æ–°ï¼š</strong>{data.meta.stockDate}</p>}
                  {data.meta.quoteDate && <p><strong>å ±åƒ¹æ›´æ–°ï¼š</strong>{data.meta.quoteDate}</p>}
                </div>
              </div>
            </div>
          </div>
        );
      }

      // å ±åƒ¹é 
      const isMobile = typeof window !== 'undefined' && window.innerWidth <= 768;
      const total = calculateTotal();

      return (
        <div className="min-h-screen bg-gray-50 pb-24">{/* ğŸ†• åŠ ä¸Š pb-24 é¿å…è¢«åº•éƒ¨å°èˆªé®æ“‹ */}
          {/* Header */}
          {!isMobile && (
            <div className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-6 py-4 shadow-lg">
              <div className="max-w-7xl mx-auto flex justify-between items-center">
                <div className="flex items-center gap-3">
                  <Icons.Package className="icon-svg-lg" />
                  <div>
                    <h1 className="text-xl font-black">å…«æ–¹ç’°çƒ ERP</h1>
                    <p className="text-xs opacity-90">{status}</p>
                  </div>
                </div>
                <div className="flex gap-2">
                  {role === 'admin' && (
                    <button onClick={() => setPage('admin')} className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-bold flex items-center gap-2">
                      <Icons.Settings className="icon-svg-sm" />
                      ç®¡ç†
                    </button>
                  )}
                  <button onClick={() => setPage('login')} className="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg font-bold">
                    ç™»å‡º
                  </button>
                </div>
              </div>
            </div>
          )}

          {isMobile && (
            <div className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-3 shadow-lg sticky top-0 z-50">
              <div className="flex justify-between items-center">
                <div className="flex items-center gap-2">
                  <Icons.Package className="icon-svg" />
                  <div>
                    <h1 className="text-base font-black">å…«æ–¹ç’°çƒ ERP V12.0</h1>
                    <p className="text-xs opacity-90">{status}</p>
                  </div>
                </div>
                <div className="flex gap-2">
                  {role === 'admin' && (
                    <button onClick={() => setPage('admin')} className="bg-white/20 p-2 rounded-lg">
                      <Icons.Settings className="icon-svg-sm" />
                    </button>
                  )}
                  <button onClick={() => setPage('login')} className="bg-red-500 px-3 py-1.5 rounded-lg text-sm font-bold">
                    ç™»å‡º
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* æ¡Œé¢ç‰ˆä½ˆå±€ */}
          {!isMobile && (
            <div className="max-w-7xl mx-auto p-6">
              <div className="grid grid-cols-[280px_1fr] gap-6">
                {/* å·¦å´æ¬„ */}
                <div className="bg-gradient-to-b from-purple-500 to-indigo-600 text-white rounded-2xl p-6 shadow-xl h-fit sticky top-24">
                  <h2 className="font-bold text-lg mb-4 flex items-center gap-2">
                    <Icons.User />
                    å®¢æˆ¶è³‡è¨Š
                  </h2>
                  
                  <div className="space-y-3 mb-6">
                    <input type="text" placeholder="å®¢æˆ¶åç¨±" className="w-full p-2.5 rounded-lg text-gray-800 text-sm" 
                      value={custInfo.name} onChange={e => setCustInfo({...custInfo, name: e.target.value})} />
                    <select className="w-full p-2.5 rounded-lg text-gray-800 text-sm font-bold bg-yellow-100"
                      value={custInfo.tier} onChange={e => setCustInfo({...custInfo, tier: e.target.value})}>
                      <option value="é–€å¸‚å”®åƒ¹">é–€å¸‚å”®åƒ¹</option>
                      <option value="æœƒå“¡95%">æœƒå“¡95%</option>
                      <option value="é¤å»³90%">é¤å»³90%</option>
                      <option value="ç”Ÿæ„åƒ¹">ç”Ÿæ„åƒ¹</option>
                      <option value="æ•´ä»¶åƒ¹">æ•´ä»¶åƒ¹</option>
                      <option value="VIPåƒ¹">VIPåƒ¹</option>
                      <option value="æ¥­å‹™åº•åƒ¹">æ¥­å‹™åº•åƒ¹</option>
                    </select>
                    <select className="w-full p-2.5 rounded-lg text-gray-800 text-sm font-bold bg-green-100"
                      value={custInfo.paymentMethod} onChange={e => setCustInfo({...custInfo, paymentMethod: e.target.value})}>
                      <option value="æœˆçµ30å¤©">æœˆçµ30å¤©</option>
                      <option value="æœˆçµ60å¤©">æœˆçµ60å¤©</option>
                      <option value="ç¾é‡‘">ç¾é‡‘</option>
                      <option value="è²¨åˆ°ä»˜æ¬¾">è²¨åˆ°ä»˜æ¬¾</option>
                      <option value="åŒ¯æ¬¾">åŒ¯æ¬¾</option>
                      <option value="æ”¯ç¥¨">æ”¯ç¥¨</option>
                    </select>
                    <input type="tel" placeholder="é›»è©±" className="w-full p-2.5 rounded-lg text-gray-800 text-sm"
                      value={custInfo.phone} onChange={e => setCustInfo({...custInfo, phone: e.target.value})} />
                    <input type="tel" placeholder="æ‰‹æ©Ÿ" className="w-full p-2.5 rounded-lg text-gray-800 text-sm"
                      value={custInfo.mobile} onChange={e => setCustInfo({...custInfo, mobile: e.target.value})} />
                    <input type="text" placeholder="åœ°å€" className="w-full p-2.5 rounded-lg text-gray-800 text-sm"
                      value={custInfo.address} onChange={e => setCustInfo({...custInfo, address: e.target.value})} />
                    <input type="date" className="w-full p-2.5 rounded-lg text-gray-800 text-sm"
                      value={custInfo.date} onChange={e => setCustInfo({...custInfo, date: e.target.value})} />
                  </div>

                  <div className="space-y-2 mb-6 pt-6 border-t border-white/20">
                    <button 
                      onClick={() => {
                        const choice = window.confirm('è«‹é¸æ“‡é è¦½æ–¹å¼ï¼š\n\nç¢ºå®š = å®Œæ•´å ±åƒ¹å–®ï¼ˆå«é‡‘é¡ï¼‰\nå–æ¶ˆ = ç´”ç”¢å“æ¸…å–®ï¼ˆå«å–®åƒ¹ï¼‰');
                        if (choice) {
                          printQuote();
                        } else {
                          printQuoteNoPrice();
                        }
                      }}
                      className="w-full bg-white/20 hover:bg-white/30 p-3 rounded-lg font-bold flex items-center gap-2 transition-colors">
                      <Icons.Eye className="icon-svg-sm" />
                      ğŸ“„ é è¦½å ±åƒ¹å–®
                    </button>
                    <button onClick={shareToLine} className="w-full bg-green-500/90 hover:bg-green-500 p-3 rounded-lg font-bold flex items-center gap-2 transition-colors">
                      <Icons.Send className="icon-svg-sm" />
                      ğŸ’š åˆ†äº« LINE
                    </button>
                    <button onClick={saveQuote} className="w-full bg-white/20 hover:bg-white/30 p-3 rounded-lg font-bold flex items-center gap-2 transition-colors">
                      <Icons.Save className="icon-svg-sm" />
                      ğŸ’¾ å„²å­˜å ±åƒ¹
                    </button>
                    <button onClick={() => setShowHistory(true)} className="w-full bg-white/20 hover:bg-white/30 p-3 rounded-lg font-bold flex items-center gap-2 transition-colors">
                      <Icons.Clock className="icon-svg-sm" />
                      ğŸ“š æ­·å²å ±åƒ¹
                    </button>
                  </div>

                  <div className="pt-6 border-t border-white/20 bg-purple-500/20 p-4 rounded-xl">
                    <div className="flex items-center justify-between">
                      <div className="flex flex-col">
                        <span className="text-sm opacity-90 mb-1">ç•¶å‰åƒ¹æ ¼ç­‰ç´š</span>
                        <span className="text-lg font-bold">{custInfo.tier}</span>
                      </div>
                      <div className="bg-purple-500 text-white w-16 h-16 rounded-xl flex items-center justify-center shadow-lg">
                        <span className="text-3xl font-black">
                          {(() => {
                            const tier = custInfo.tier;
                            if (tier.includes('é–€å¸‚')) return 'é–€';
                            if (tier.includes('æœƒå“¡')) return 'æœƒ';
                            if (tier.includes('é¤å»³')) return 'é¤';
                            if (tier.includes('ç”Ÿæ„')) return 'ç”Ÿ';
                            if (tier.includes('æ•´ä»¶')) return 'æ•´';
                            if (tier.includes('VIP')) return 'VIP';
                            if (tier.includes('åº•åƒ¹') || tier.includes('æ¥­å‹™')) return 'åº•';
                            return tier.charAt(0);
                          })()}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>

                {/* å³å´ç”¢å“å€ */}
                <div>
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-2xl font-black text-gray-800">ç”¢å“æ¸…å–®</h2>
                    <button onClick={() => setShowProductSearch(true)} className="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg hover:shadow-xl transition-all hover:scale-[1.02]">
                      <Icons.Plus />
                      æ–°å¢ç”¢å“
                    </button>
                  </div>

                  <div className="space-y-2">
                    {cart.map((item, index) => (
                      <div key={item.cartId} className="bg-white border-2 border-gray-200 rounded-xl p-4 flex items-center gap-4 hover:border-purple-400 hover:shadow-lg transition-all" style={{minHeight: '120px'}}>
                        <div className="w-11 h-11 bg-gradient-to-br from-purple-500 to-indigo-600 text-white rounded-xl flex items-center justify-center font-bold text-lg flex-shrink-0 shadow-md">
                          {index + 1}
                        </div>

                        <div className="w-28 h-28 bg-gray-100 rounded-xl flex items-center justify-center border-2 border-gray-200 cursor-pointer hover:border-purple-400 transition-colors flex-shrink-0 overflow-hidden"
                          onClick={() => uploadImage(item.cartId)}>
                          {item.image ? (
                            <img src={item.image} alt="ç”¢å“" className="w-full h-full object-cover" />
                          ) : (
                            <Icons.Camera className="icon-svg-lg text-gray-400" />
                          )}
                        </div>

                        <div className="flex-1 flex flex-col gap-2 min-w-0">
                          <div className="font-bold text-lg text-gray-800 cursor-pointer hover:text-purple-600 transition-colors" onClick={() => reSelectProduct(item.cartId)} title="é»æ“Šé‡æ–°é¸æ“‡ç”¢å“">{item.name || 'æœªå‘½åç”¢å“'}</div>
                          <div className="text-sm text-purple-600 font-semibold cursor-pointer hover:text-blue-800 transition-colors" onClick={() => { setSearch(item.name || ''); setShowProductSearch(true); }} title="é»æ“Šæœå°‹åŒå“åç”¢å“">{item.specDetail || 'ç„¡è¦æ ¼èªªæ˜'}</div>
                          
                          <div className="flex items-center gap-2 flex-wrap">
                            <div className="flex items-center gap-1">
                              <span className="text-xs text-gray-600 font-semibold">æ•¸é‡</span>
                              <input type="number" className="w-20 px-2 py-1.5 border-2 border-gray-200 rounded-lg text-center font-bold focus:border-purple-500 outline-none"
                                value={item.qty} onChange={e => updateCart(item.cartId, 'qty', parseFloat(e.target.value) || 0)} />
                              <span className="text-sm font-bold text-gray-600">{item.smallUnit}</span>
                            </div>

                            <div className="flex items-center gap-1">
                              <span className="text-xs text-gray-600 font-semibold">å–®åƒ¹ $</span>
                              <input type="number" className="w-20 px-2 py-1.5 border-2 border-gray-200 rounded-lg text-center font-bold focus:border-purple-500 outline-none"
                                value={item.price} onChange={e => updateCart(item.cartId, 'price', parseFloat(e.target.value) || 0)} />
                              <button onClick={() => showPriceSelector(item.cartId)} className="bg-purple-500 text-white px-3 py-1.5 rounded-lg font-black text-sm flex items-center justify-center hover:shadow-lg transition-all min-w-[44px]">
                                {(() => {
                                  const tier = item.selectedTier || custInfo.tier;
                                  if (tier.includes('é–€å¸‚')) return 'é–€';
                                  if (tier.includes('æœƒå“¡')) return 'æœƒ';
                                  if (tier.includes('é¤å»³')) return 'é¤';
                                  if (tier.includes('ç”Ÿæ„')) return 'ç”Ÿ';
                                  if (tier.includes('æ•´ä»¶')) return 'æ•´';
                                  if (tier.includes('VIP')) return 'VIP';
                                  if (tier.includes('åº•åƒ¹') || tier.includes('æ¥­å‹™')) return 'åº•';
                                  return tier.charAt(0);
                                })()}
                              </button>
                            </div>

                            <div className="text-xl font-bold text-purple-600 ml-auto">
                              ${calculateSubtotal(item).toLocaleString()}
                            </div>

                            <input type="text" placeholder="å‚™è¨»..." className="flex-1 px-3 py-1.5 border-2 border-yellow-300 bg-yellow-50 rounded-lg text-sm focus:border-yellow-500 outline-none min-w-[150px]"
                              value={item.note} onChange={e => updateCart(item.cartId, 'note', e.target.value)} />
                          </div>
                        </div>

                        <div className="flex flex-col gap-1.5 flex-shrink-0">
                          <button onClick={() => uploadImage(item.cartId)} className="w-10 h-10 bg-gray-100 border-2 border-gray-300 rounded-lg hover:bg-gray-200 transition-colors flex items-center justify-center">
                            <Icons.Camera className="icon-svg-sm" />
                          </button>
                          <button onClick={() => copyCartItem(item.cartId)} className="w-10 h-10 bg-blue-100 border-2 border-purple-300 rounded-lg hover:bg-blue-200 transition-colors flex items-center justify-center">
                            <Icons.Copy className="icon-svg-sm" />
                          </button>
                          <button onClick={() => deleteFromCart(item.cartId)} className="w-10 h-10 bg-red-100 border-2 border-red-300 rounded-lg hover:bg-red-200 transition-colors flex items-center justify-center">
                            <Icons.Trash className="icon-svg-sm" />
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* æ‰‹æ©Ÿç‰ˆä½ˆå±€ */}
          {isMobile && (
            <div className="pb-32">
              <div className="bg-white m-4 rounded-2xl p-4 shadow-lg">
                <div className="space-y-2.5">
                  <input type="text" placeholder="å®¢æˆ¶åç¨±" className="w-full p-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-purple-500 outline-none transition-colors text-sm"
                    value={custInfo.name} onChange={e => setCustInfo({...custInfo, name: e.target.value})} />
                  <div className="grid grid-cols-2 gap-2.5">
                    <select className="p-3 bg-yellow-100 border-2 border-yellow-300 rounded-xl focus:border-yellow-500 outline-none transition-colors text-sm font-bold"
                      value={custInfo.tier} onChange={e => setCustInfo({...custInfo, tier: e.target.value})}>
                      <option value="é–€å¸‚å”®åƒ¹">é–€å¸‚å”®åƒ¹</option>
                      <option value="æœƒå“¡95%">æœƒå“¡95%</option>
                      <option value="é¤å»³90%">é¤å»³90%</option>
                      <option value="ç”Ÿæ„åƒ¹">ç”Ÿæ„åƒ¹</option>
                      <option value="æ•´ä»¶åƒ¹">æ•´ä»¶åƒ¹</option>
                      <option value="VIPåƒ¹">VIPåƒ¹</option>
                      <option value="æ¥­å‹™åº•åƒ¹">æ¥­å‹™åº•åƒ¹</option>
                    </select>
                    <select className="p-3 bg-green-100 border-2 border-green-300 rounded-xl focus:border-green-500 outline-none transition-colors text-sm font-bold"
                      value={custInfo.paymentMethod} onChange={e => setCustInfo({...custInfo, paymentMethod: e.target.value})}>
                      <option value="æœˆçµ30å¤©">æœˆçµ30å¤©</option>
                      <option value="æœˆçµ60å¤©">æœˆçµ60å¤©</option>
                      <option value="ç¾é‡‘">ç¾é‡‘</option>
                      <option value="è²¨åˆ°ä»˜æ¬¾">è²¨åˆ°ä»˜æ¬¾</option>
                      <option value="åŒ¯æ¬¾">åŒ¯æ¬¾</option>
                      <option value="æ”¯ç¥¨">æ”¯ç¥¨</option>
                    </select>
                  </div>
                  <div className="grid grid-cols-2 gap-2.5">
                    <input type="tel" placeholder="é›»è©±" className="w-full p-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-purple-500 outline-none transition-colors text-sm min-w-0"
                      value={custInfo.phone} onChange={e => setCustInfo({...custInfo, phone: e.target.value})} />
                    <input type="tel" placeholder="æ‰‹æ©Ÿ" className="w-full p-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-purple-500 outline-none transition-colors text-sm min-w-0"
                      value={custInfo.mobile} onChange={e => setCustInfo({...custInfo, mobile: e.target.value})} />
                    <input type="text" placeholder="åœ°å€" className="w-full p-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-purple-500 outline-none transition-colors text-sm min-w-0"
                      value={custInfo.address} onChange={e => setCustInfo({...custInfo, address: e.target.value})} />
                    <input type="date" className="w-full p-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-purple-500 outline-none transition-colors text-sm min-w-0"
                      value={custInfo.date} onChange={e => setCustInfo({...custInfo, date: e.target.value})} />
                  </div>
                </div>
              </div>

              <div className="px-4">
                <div className="flex items-center justify-between mb-3">
                  <h2 className="text-base font-bold text-gray-800 flex items-center gap-2">
                    <Icons.Package className="icon-svg-sm" />
                    ç”¢å“æ¸…å–®
                  </h2>
                </div>

                <div className="space-y-2.5">
                  {cart.map((item, index) => (
                    <div key={item.cartId} className="bg-white border-2 border-gray-200 rounded-2xl p-4 shadow-sm">
                      <div className="flex items-start gap-2.5 mb-2.5">
                        <div className="w-9 h-9 bg-gradient-to-br from-purple-500 to-indigo-600 text-white rounded-xl flex items-center justify-center font-bold flex-shrink-0 shadow-md text-base">
                          {index + 1}
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className="font-bold text-base text-gray-800 mb-1 cursor-pointer active:text-purple-600" onClick={() => reSelectProduct(item.cartId)}>{item.name || 'æœªå‘½åç”¢å“'}</div>
                          <div className="text-sm text-purple-600 font-semibold cursor-pointer active:text-blue-800" onClick={() => { setSearch(item.name || ''); setShowProductSearch(true); }}>{item.specDetail || 'ç„¡è¦æ ¼èªªæ˜'}</div>
                        </div>
                        <div className="flex gap-1 flex-shrink-0">
                          <button onClick={() => uploadImage(item.cartId)} className="w-8 h-8 bg-gray-100 border-2 border-gray-300 rounded-lg flex items-center justify-center">
                            <Icons.Camera className="icon-svg-sm" />
                          </button>
                          <button onClick={() => copyCartItem(item.cartId)} className="w-8 h-8 bg-blue-100 border-2 border-purple-300 rounded-lg flex items-center justify-center">
                            <Icons.Copy className="icon-svg-sm" />
                          </button>
                          <button onClick={() => deleteFromCart(item.cartId)} className="w-8 h-8 bg-red-100 border-2 border-red-300 rounded-lg flex items-center justify-center">
                            <Icons.Trash className="icon-svg-sm" />
                          </button>
                        </div>
                      </div>

                      <div className="flex gap-2 mb-3">
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-1.5 bg-gray-50 border-2 border-gray-200 rounded-xl p-2.5">
                            <span className="text-xs text-gray-500 font-semibold flex-shrink-0">æ•¸é‡</span>
                            <input type="number" className="flex-1 bg-transparent text-base font-bold text-center outline-none min-w-0"
                              value={item.qty} onChange={e => updateCart(item.cartId, 'qty', parseFloat(e.target.value) || 0)} />
                            <span className="text-sm font-bold text-gray-600 flex-shrink-0">{item.smallUnit}</span>
                          </div>
                        </div>

                        <div className="flex-1 flex gap-1 min-w-0">
                          <div className="flex-1 flex items-center gap-1 bg-gray-50 border-2 border-gray-200 rounded-xl p-2.5 min-w-0">
                            <span className="text-xs text-gray-500 font-semibold flex-shrink-0">$</span>
                            <input type="number" className="flex-1 bg-transparent text-base font-bold text-center outline-none min-w-0" style={{width: '60px'}}
                              value={item.price} onChange={e => updateCart(item.cartId, 'price', parseFloat(e.target.value) || 0)} />
                          </div>
                          <button onClick={() => showPriceSelector(item.cartId)} className="w-10 h-10 bg-purple-500 text-white rounded-xl flex items-center justify-center shadow-md flex-shrink-0 font-black text-sm">
                            {(() => {
                              const tier = item.selectedTier || custInfo.tier;
                              if (tier.includes('é–€å¸‚')) return 'é–€';
                              if (tier.includes('æœƒå“¡')) return 'æœƒ';
                              if (tier.includes('é¤å»³')) return 'é¤';
                              if (tier.includes('ç”Ÿæ„')) return 'ç”Ÿ';
                              if (tier.includes('æ•´ä»¶')) return 'æ•´';
                              if (tier.includes('VIP')) return 'VIP';
                              if (tier.includes('åº•åƒ¹') || tier.includes('æ¥­å‹™')) return 'åº•';
                              return tier.charAt(0);
                            })()}
                          </button>
                        </div>
                      </div>

                      <div className="flex gap-2 items-center">
                        <input type="text" placeholder="å‚™è¨»..." className="px-2.5 py-2.5 border-2 border-yellow-300 bg-yellow-50 rounded-xl text-sm focus:border-yellow-500 outline-none min-w-0" style={{width: '40%'}}
                          value={item.note} onChange={e => updateCart(item.cartId, 'note', e.target.value)} />
                        <div className="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-purple-400 rounded-xl px-3 py-2 flex-shrink-0" style={{width: '60%'}}>
                          <p className="text-xs text-gray-600 font-semibold">å°è¨ˆ</p>
                          <p className="text-lg font-bold text-purple-600 whitespace-nowrap">${calculateSubtotal(item).toLocaleString()}</p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>

                <button onClick={() => setShowProductSearch(true)} className="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-2xl font-bold text-base shadow-lg mt-4 flex items-center justify-center gap-2">
                  <Icons.Plus />
                  æ–°å¢ç”¢å“
                </button>
              </div>

              <div className="fixed bottom-0 left-0 right-0 bg-white border-t-2 border-gray-200 shadow-2xl z-50">
                <div className="grid grid-cols-4 border-b border-gray-200">
                  <button onClick={printQuote} className="flex flex-col items-center justify-center py-2.5 border-r border-gray-200 text-purple-600 active:bg-gray-50">
                    <Icons.Eye className="icon-svg-lg mb-1" />
                    <span className="text-xs font-semibold">åˆ—å°</span>
                  </button>
                  <button onClick={printQuoteNoPrice} className="flex flex-col items-center justify-center py-2.5 border-r border-gray-200 text-purple-600 active:bg-gray-50">
                    <Icons.FileText className="icon-svg-lg mb-1" />
                    <span className="text-xs font-semibold">ç´”å ±åƒ¹</span>
                  </button>
                  <button onClick={shareToLine} className="flex flex-col items-center justify-center py-2.5 border-r border-gray-200 text-green-600 active:bg-gray-50">
                    <Icons.Send className="icon-svg-lg mb-1" />
                    <span className="text-xs font-semibold">LINE</span>
                  </button>
                  <div className="flex flex-col items-center justify-center py-2.5 bg-purple-500 text-white">
                    <div className="text-2xl font-black leading-none mb-0.5">
                      {(() => {
                        const tier = custInfo.tier;
                        if (tier.includes('é–€å¸‚')) return 'é–€';
                        if (tier.includes('æœƒå“¡')) return 'æœƒ';
                        if (tier.includes('é¤å»³')) return 'é¤';
                        if (tier.includes('ç”Ÿæ„')) return 'ç”Ÿ';
                        if (tier.includes('æ•´ä»¶')) return 'æ•´';
                        if (tier.includes('VIP')) return 'VIP';
                        if (tier.includes('åº•åƒ¹') || tier.includes('æ¥­å‹™')) return 'åº•';
                        return tier.charAt(0);
                      })()}
                    </div>
                    <span className="text-xs opacity-90 font-semibold">{custInfo.tier}</span>
                  </div>
                </div>

                <div className="grid grid-cols-2">
                  <button onClick={saveQuote} className="flex items-center justify-center gap-1.5 py-2 border-r border-gray-200 active:bg-gray-50">
                    <Icons.Save className="icon-svg-lg" />
                    <span className="text-xs font-semibold">å„²å­˜</span>
                  </button>
                  <button onClick={() => setShowHistory(true)} className="flex items-center justify-center gap-1.5 py-2 active:bg-gray-50">
                    <Icons.Clock className="icon-svg-lg" />
                    <span className="text-xs font-semibold">æ­·å²</span>
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* ç”¢å“æœå°‹å½ˆçª— */}
          {showProductSearch && (
            <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
              <div className="bg-white w-full max-w-2xl rounded-2xl flex flex-col overflow-hidden shadow-2xl" style={{maxHeight: '80vh'}}>
                <div className="px-6 py-4 border-b flex gap-3 bg-gradient-to-r from-purple-500 to-indigo-600 text-white">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2">
                      <Icons.Search className="icon-svg" />
                      <h3 className="font-bold text-lg">
                        {reSelectCartId ? 'é‡æ–°é¸æ“‡ç”¢å“' : 'æ–°å¢ç”¢å“'}
                      </h3>
                    </div>
                    <div className="relative">
                      <input 
                        autoFocus 
                        placeholder="æœå°‹ç”¢å“åç¨±..." 
                        className="w-full px-4 py-2.5 rounded-lg text-gray-800 outline-none" 
                        value={search} 
                        onChange={e => setSearch(e.target.value)} 
                      />
                    </div>
                  </div>
                  <button onClick={() => { setShowProductSearch(false); setSearch(''); setReSelectCartId(null); }} className="bg-white/20 hover:bg-white/30 px-6 rounded-lg font-bold text-lg h-fit">âœ•</button>
                </div>

                <div className="flex-1 overflow-auto p-4">
                  {!data.products || Object.keys(data.products).length === 0 ? (
                    <div className="text-center text-gray-400 py-20">
                      <Icons.Package className="icon-svg-lg mx-auto mb-4 opacity-50" />
                      <p>å°šç„¡ç”¢å“è³‡æ–™</p>
                      <p className="text-xs mt-2">è«‹å…ˆä¸Šå‚³ç”¢å“è³‡æ–™</p>
                    </div>
                  ) : filteredProds.length === 0 ? (
                    <div className="text-center text-gray-400 py-20">
                      <Icons.Search className="icon-svg-lg mx-auto mb-4 opacity-50" />
                      <p>ç„¡ç¬¦åˆå•†å“</p>
                    </div>
                  ) : (
                    <div className="space-y-4">
                      {filteredProds.slice(0, 50).map(key => {
                        const group = data.products[key];
                        if (!group || !Array.isArray(group)) return null;
                        return (
                          <div key={key} className="border-2 border-gray-200 rounded-xl overflow-hidden">
                            <div className="bg-gray-100 px-4 py-2 font-bold text-gray-800">{key}</div>
                            {group.map((spec, i) => {
                              if (!spec) return null;
                              const stocks = data.inventory[spec.id] || [];
                              const total = stocks.reduce((s, x) => s + (x.stock || 0), 0);
                              const price = (spec.prices && spec.prices[custInfo.tier]) || 0;
                              
                              return (
                                <div 
                                  key={i} 
                                  onClick={() => addProductFromDB(spec)}
                                  className="p-4 border-b border-gray-200 last:border-b-0 hover:bg-purple-50 cursor-pointer transition-colors"
                                >
                                  <div className="flex justify-between items-start mb-2">
                                    <div className="flex-1">
                                      <div className="font-bold text-blue-800">{spec.specDetail || '(ç„¡è¦æ ¼èªªæ˜)'}</div>
                                      <div className="text-xs text-gray-500 mt-1">å“è™Ÿ: {spec.id || 'N/A'}</div>
                                    </div>
                                    <div className="text-right flex-shrink-0 ml-4">
                                      <div className="font-black text-2xl text-purple-600">${price}</div>
                                      <span className={`inline-block text-xs px-2 py-1 rounded mt-1 ${total > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-500'}`}>
                                        åº«å­˜: {Math.floor(total)}
                                      </span>
                                    </div>
                                  </div>
                                  
                                  {stocks.length > 0 && (
                                    <div className="flex gap-2 flex-wrap mt-2">
                                      {stocks.map((s, k) => (
                                        <span key={k} className="text-xs bg-gray-100 px-2 py-1 rounded border border-gray-300">
                                          {s.warehouse}: {Math.floor(s.stock)}
                                        </span>
                                      ))}
                                    </div>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* åƒ¹æ ¼é¸æ“‡å½ˆçª— */}
          {showPriceModal && currentPriceItem && (
            <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4" onClick={() => setShowPriceModal(false)}>
              <div className="bg-white rounded-2xl max-w-lg w-full max-h-[80vh] overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                <div className="px-6 py-4 border-b flex justify-between items-center bg-gradient-to-r from-purple-500 to-indigo-600 text-white">
                  <h3 className="font-bold text-lg flex items-center gap-2">
                    <Icons.DollarSign />
                    é¸æ“‡åƒ¹æ ¼
                  </h3>
                  <button onClick={() => setShowPriceModal(false)} className="w-8 h-8 bg-white/20 hover:bg-white/30 rounded-lg flex items-center justify-center text-xl font-bold">âœ•</button>
                </div>

                <div className="p-6 overflow-y-auto max-h-[calc(80vh-80px)]">
                  {(() => {
                    const item = cart.find(i => i.cartId === currentPriceItem);
                    if (!item || !item.prices) return null;
                    
                    // å›ºå®šçš„7å€‹åƒ¹æ ¼ç­‰ç´šé †åºï¼ˆç”±é«˜åˆ°ä½ï¼‰
                    const priceOrder = [
                      'é–€å¸‚å”®åƒ¹',
                      'æœƒå“¡95%',
                      'é¤å»³90%',
                      'ç”Ÿæ„åƒ¹',
                      'æ•´ä»¶åƒ¹',
                      'VIPåƒ¹',
                      'æ¥­å‹™åº•åƒ¹'
                    ];
                    
                    return (
                      <div className="space-y-3">
                        {priceOrder.map((tier) => {
                          const price = item.prices[tier];
                          // åªæœ‰ç•¶åƒ¹æ ¼æ˜¯ undefined æˆ– null æ™‚æ‰ä¸é¡¯ç¤ºï¼Œ0 è¦é¡¯ç¤º
                          if (price === undefined || price === null) return null;
                          
                          return (
                            <button 
                              key={tier}
                              onClick={() => selectPrice(tier, price)}
                              className="w-full p-4 border-2 border-gray-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition-colors text-left"
                            >
                              <div className="flex justify-between items-center">
                                <div>
                                  <div className="text-sm text-gray-500">{tier}</div>
                                  <div className="text-2xl font-bold text-purple-600">${price.toLocaleString()}</div>
                                </div>
                                {(item.selectedTier || custInfo.tier) === tier && (
                                  <span className="bg-green-100 text-green-700 text-xs px-3 py-1 rounded-full font-bold">ç›®å‰ç­‰ç´š</span>
                                )}
                              </div>
                            </button>
                          );
                        })}
                      </div>
                    );
                  })()}
                </div>
              </div>
            </div>
          )}

          {/* æ­·å²å ±åƒ¹å½ˆçª— */}
          {showHistory && (
            <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4" onClick={() => setShowHistory(false)}>
              <div className="bg-white rounded-2xl max-w-lg w-full max-h-[80vh] overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                <div className="px-6 py-4 border-b flex justify-between items-center bg-gradient-to-r from-purple-500 to-indigo-600 text-white">
                  <h3 className="font-bold text-lg flex items-center gap-2">
                    <Icons.Clock />
                    æ­·å²å ±åƒ¹
                  </h3>
                  <button onClick={() => setShowHistory(false)} className="w-8 h-8 bg-white/20 hover:bg-white/30 rounded-lg flex items-center justify-center text-xl font-bold">âœ•</button>
                </div>

                <div className="p-6 overflow-y-auto max-h-[calc(80vh-80px)]">
                  {quotes.length === 0 ? (
                    <p className="text-center text-gray-400 py-10">å°šç„¡æ­·å²å ±åƒ¹</p>
                  ) : (
                    <div className="space-y-2">
                      {[...quotes].reverse().map(quote => {
                        const date = new Date(quote.date);
                        const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
                        return (
                          <div key={quote.id} className="p-4 border-2 border-gray-200 rounded-xl">
                            <div className="flex justify-between items-start mb-2">
                              <div>
                                <div className="font-bold">{quote.customer.name || 'æœªå‘½åå®¢æˆ¶'}</div>
                                <div className="text-xs text-gray-500">{dateStr} â€¢ {quote.customer.tier}</div>
                              </div>
                              <div className="text-right">
                                <div className="text-xl font-bold text-purple-600">${quote.total.toLocaleString()}</div>
                                <div className="text-xs text-gray-500">{quote.products.length} é …</div>
                              </div>
                            </div>
                            <div className="flex gap-2 mt-3">
                              <button onClick={() => loadQuote(quote.id)} className="flex-1 bg-purple-500 text-white py-2 rounded-lg font-bold">è¼‰å…¥</button>
                              <button onClick={() => deleteQuote(quote.id)} className="px-4 bg-red-100 text-red-600 py-2 rounded-lg font-bold">åˆªé™¤</button>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* ğŸ†• V12.0 åº•éƒ¨å°èˆª */}
          {page !== 'login' && page !== 'admin' && (
            <div className="no-print fixed bottom-0 left-0 right-0 glass border-t border-white/30 z-50 card-shadow">
              <div className="flex justify-around items-center h-16 max-w-2xl mx-auto">
                {/* é¦–é  */}
                <button 
                  onClick={() => alert('ğŸ  é¦–é åŠŸèƒ½é–‹ç™¼ä¸­\n\nå°‡åŒ…å«ï¼š\nâ€¢ å¿«é€Ÿé–‹å§‹\nâ€¢ æœ€è¿‘å ±åƒ¹\nâ€¢ çµ±è¨ˆè³‡è¨Š')}
                  className="flex flex-col items-center justify-center flex-1 h-full text-gray-500 hover:text-purple-600 transition-colors">
                  <div className="relative">
                    <Icons.Home className="w-6 h-6" />
                  </div>
                  <span className="text-xs mt-1">é¦–é </span>
                </button>
                
                {/* ç”¢å“ */}
                <button 
                  onClick={() => {
                    setShowProductSearch(true);
                    setReSelectCartId(null);
                  }}
                  className="flex flex-col items-center justify-center flex-1 h-full text-gray-500 hover:text-purple-600 transition-colors">
                  <div className="relative">
                    <Icons.Search className="w-6 h-6" />
                  </div>
                  <span className="text-xs mt-1">ç”¢å“</span>
                </button>
                
                {/* å ±åƒ¹ï¼ˆç•¶å‰é é¢ï¼Œé«˜äº®ï¼‰*/}
                <button className="flex flex-col items-center justify-center flex-1 h-full text-purple-600 relative">
                  <div className="absolute top-0 left-1/2 transform -translate-x-1/2 w-10 h-1 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-b-full"></div>
                  <div className="relative">
                    <Icons.ShoppingCart className="w-6 h-6" />
                    {cart.length > 0 && (
                      <span className="absolute -top-2 -right-2 cart-badge text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center animate-pulse">
                        {cart.length}
                      </span>
                    )}
                  </div>
                  <span className="text-xs mt-1 font-bold">å ±åƒ¹</span>
                </button>
                
                {/* æ­·å² */}
                <button 
                  onClick={() => setShowHistory(true)}
                  className="flex flex-col items-center justify-center flex-1 h-full text-gray-500 hover:text-purple-600 transition-colors">
                  <div className="relative">
                    <Icons.History className="w-6 h-6" />
                    {quotes.length > 0 && (
                      <span className="absolute -top-1 -right-1 bg-blue-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center" style={{fontSize: '10px'}}>
                        {quotes.length}
                      </span>
                    )}
                  </div>
                  <span className="text-xs mt-1">æ­·å²</span>
                </button>
                
                {/* ç®¡ç† */}
                <button 
                  onClick={() => {
                    if (role === 'admin') {
                      setPage('admin');
                    } else {
                      alert('âš ï¸ åƒ…ç®¡ç†å“¡å¯è¨ªå•\n\nè«‹ä½¿ç”¨ç®¡ç†å“¡å¸³è™Ÿç™»å…¥\nå¯†ç¢¼ï¼š8888');
                    }
                  }}
                  className="flex flex-col items-center justify-center flex-1 h-full text-gray-500 hover:text-purple-600 transition-colors">
                  <div className="relative">
                    <Icons.Settings className="w-6 h-6" />
                    {role === 'admin' && (
                      <span className="absolute -top-1 -right-1 bg-gradient-to-r from-yellow-400 to-orange-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center" style={{fontSize: '10px'}}>
                        âš¡
                      </span>
                    )}
                  </div>
                  <span className="text-xs mt-1">ç®¡ç†</span>
                </button>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>