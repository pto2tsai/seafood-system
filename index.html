<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>訂單報價系統 Pro</title>
  
  <!-- 1. 引入 React 和 Tailwind -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 2. 設定樣式 -->
  <style>
    body { -webkit-tap-highlight-color: transparent; -webkit-font-smoothing: antialiased; }
    @media print { .no-print { display: none !important; } }
    
    /* 全域字體設定 */
    body, input, select, textarea { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      font-size: 16px; 
      color: #000000;
    }
    
    /* 隱藏數字輸入框箭頭 */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    
    /* 隱藏捲軸 */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* 輸入框聚焦效果 */
    .input-corporate:focus {
      border-bottom-color: #1d4ed8; /* Blue-700 */
      background-color: #eff6ff; /* Blue-50 */
    }
    /* A4 品名專用樣式 */
    .A4-product-name {
        font-weight: 700; 
        font-size: 14px; 
        word-break: break-words;
        white-space: normal;
        line-height: 1.3; 
    }
    /* 數字輸入框精確調整 */
    .number-input-lg {
      padding-top: 0.25rem !important;
      padding-bottom: 0.25rem !important;
      height: auto;
    }
  </style>
</head>
<body class="bg-white text-black">

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // --- 圖標組件 ---
    const Icon = ({ path, size = 24, className = "text-blue-700" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{ __html: path }} />
    );

    const icons = {
      Plus: '<line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>',
      Trash2: '<polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line>',
      Send: '<line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>',
      Printer: '<polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect>',
      Anchor: '<circle cx="12" cy="5" r="3"></circle><line x1="12" y1="22" x2="12" y2="8"></line><path d="M5 12H2a10 10 0 0 0 20 0h-3"></path>',
      Package: '<line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line>',
      Copy: '<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>',
      ChevronLeft: '<polyline points="15 18 9 12 15 6"></polyline>',
      ArrowRight: '<line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline>',
      Smartphone: '<rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line>',
      FileText: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline>',
      Save: '<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline>',
      FolderOpen: '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>',
      X: '<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>',
      Image: '<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="M21 15l-3.37-3.37a.91.91 0 0 0-1.28 0L9 17"></path>',
      Search: '<circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>',
      Database: '<ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M3 12a9 3 0 0 0 18 0v-1a9 3 0 0 0-18 0z"></path><path d="M3 5v14a9 3 0 0 0 18 0V5"></path>',
      Warehouse: '<path d="M22 8.35V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8.35A2 2 0 0 1 3.26 6.5l8-3.2a2 2 0 0 1 1.48 0l8 3.2A2 2 0 0 1 22 8.35Z"></path><path d="M6 18h12"></path><path d="M6 14h12"></path><rect x="10" y="6" width="4" height="16"></rect>',
      Upload: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line>'
    };

    const LucideIcon = ({ name, ...props }) => <Icon path={icons[name]} {...props} />;

    // --- 常用產品列表 ---
    const COMMON_PRODUCTS = [
        "生白蝦", "熟白蝦", "生留尾蝦", "蝦仁", "魷魚圈", 
        "魷魚冰卷", "鮭魚切片", "土魠切片", "單凍小卷"
    ];

    // --- 規格預設列表 (分離數據庫) ---
    const INITIAL_PRODUCT_SPECS = {
        '生白蝦': [
            { id: 1, specDetail: '40/50 850G (紅太陽)', pack: 12, smallUnit: '盒', bigUnit: '件', prices: { "生意價": 300, "整件價": 280, "VIP價": 270, "業務底價": 250 } },
            { id: 2, specDetail: '30/40 1KG (厄瓜多)', pack: 10, smallUnit: 'KG', bigUnit: '箱', prices: { "生意價": 380, "整件價": 360, "VIP價": 350, "業務底價": 330 } },
        ],
        '鮭魚切片': [
            { id: 3, specDetail: '智利厚切 200g/片', pack: 50, smallUnit: '片', bigUnit: '箱', prices: { "生意價": 200, "整件價": 190, "VIP價": 180, "業務底價": 170 } },
        ],
    };

    // --- 庫存數據庫 (含批號) ---
    // Key: SKU_ID (對應 INITIAL_PRODUCT_SPECS 中的 id)
    const INITIAL_INVENTORY_DB = {
        1: [
            { warehouse: "本館", lot: "L2301", expiry: "2024-12", stock: 50 },
            { warehouse: "二庫", lot: "L2302", expiry: "2025-01", stock: 25 }
        ],
        2: [
            { warehouse: "本館", lot: "E1001", expiry: "2024-11", stock: 12 }
        ],
        3: [
            { warehouse: "冷凍倉", lot: "S9901", expiry: "2025-06", stock: 120 }
        ]
    };

    // --- 主程式 ---
    const SeafoodCorporateApp = () => {
      const [viewMode, setViewMode] = useState('edit'); 
      const [previewFormat, setPreviewFormat] = useState('mobile'); 
      const [showTemplates, setShowTemplates] = useState(false);
      const [isQuoteOnly, setIsQuoteOnly] = useState(false); 
      const [showProductSelector, setShowProductSelector] = useState(false);
      const [showSpecLookup, setShowSpecLookup] = useState(false); 
      const [editingItemId, setEditingItemId] = useState(null); 
      
      const [productDatabase, setProductDatabase] = useState(INITIAL_PRODUCT_SPECS);
      const [inventoryDatabase, setInventoryDatabase] = useState(INITIAL_INVENTORY_DB);
      
      const [csvData, setCsvData] = useState('');
      
      const priceTiers = ['生意價', '整件價', 'VIP價', '業務底價'];
      const [customerPriceTier, setCustomerPriceTier] = useState('生意價');

      const smallUnits = ['盒', '包', 'KG', '箱', '片', '塊'];
      const bigUnits = ['件', '箱', '籃', '保麗龍', '捆'];
      const paymentMethods = ['現金結帳', '月結30天', '月結60天', '次月結', '匯款/轉帳', '貨到付款', '支票'];

      const [companyInfo, setCompanyInfo] = useState({
        name: '', phone: '', address: '', bankInfo: '',
        note: '1. 價格以出貨當日為準。\n2. 規格與重量請於收貨時確認。'
      });

      const [customerInfo, setCustomerInfo] = useState({
        name: '', taxId: '', contact: '', phone: '', address: '',
        paymentMethod: '現金結帳',
        date: new Date().toISOString().split('T')[0],
        quoteNo: `Q${new Date().toISOString().slice(2,10).replace(/-/g,'')}-01`
      });

      const [items, setItems] = useState([
        { id: 1, name: '生白蝦', specDetail: '40/50 850G(厄瓜多紅太陽)', qty: 5, bigUnit: '件', packingContent: 12, smallUnit: '盒', price: 280, imageBase64: '' },
      ]);

      const [templates, setTemplates] = useState([]);

      useEffect(() => {
        const savedCompany = localStorage.getItem('seafood_corp_company');
        if (savedCompany) setCompanyInfo(JSON.parse(savedCompany));
        const savedTemplates = localStorage.getItem('seafood_corp_templates');
        if (savedTemplates) setTemplates(JSON.parse(savedTemplates));
        
        const savedDatabase = localStorage.getItem('seafood_product_db');
        if (savedDatabase) setProductDatabase(JSON.parse(savedDatabase));
        const savedInventory = localStorage.getItem('seafood_inventory_db');
        if (savedInventory) setInventoryDatabase(JSON.parse(savedInventory));
      }, []);

      const saveCompanyInfo = () => {
        localStorage.setItem('seafood_corp_company', JSON.stringify(companyInfo));
        alert('資料已儲存');
      };
      
      const handleDatabaseUpdate = (newJson) => {
        try {
            const newDb = JSON.parse(newJson);
            setProductDatabase(newDb);
            localStorage.setItem('seafood_product_db', newJson);
            alert("數據庫更新成功！");
        } catch (e) {
            alert("JSON 格式錯誤，請檢查。");
        }
      };

      const parseAndSaveCSV = (csvText, updateType) => {
          const separator = csvText.includes('\t') ? '\t' : (csvText.includes(',') ? ',' : null);
          if (!separator) {
             alert("無法識別分隔符，請確保貼上的是 Excel 複製的數據。");
             return;
          }

          const lines = csvText.trim().split('\n');
          if (lines.length < 2) {
              alert("請貼上包含標題和至少一行數據的表格內容。");
              return;
          }
          
          const headers = lines[0].split(separator).map(h => h.trim());
          const newDB = JSON.parse(JSON.stringify(productDatabase));
          const newInventoryDB = JSON.parse(JSON.stringify(inventoryDatabase));

          let nextId = Math.max(...Object.values(newDB).flat().map(i => i.id || 0)) + 1 || 1000;
          let successCount = 0;

          // 扁平化以便查找 ID
          const allSpecsFlat = Object.values(newDB).flat();

          for (let i = 1; i < lines.length; i++) {
              const row = lines[i].split(separator).map(c => c.trim());
              if (row.length !== headers.length) continue;

              const item = {};
              headers.forEach((header, index) => { item[header] = row[index]; });
              
              const productName = item['品名'] || '未分類產品';
              const specDetail = item['規格'] || '';

              let existingItem = newDB[productName] ? newDB[productName].find(p => p.specDetail === specDetail) : null;
              
              // 模式 1: 更新價格和規格
              if (updateType === 'price_spec') {
                  const priceObject = {};
                  priceTiers.forEach(tier => {
                      const priceKey = `價格_${tier}`;
                      const priceValue = parseFloat(item[priceKey]) || 0;
                      if (priceValue > 0) priceObject[tier] = priceValue;
                  });
                  
                  const baseData = {
                      specDetail: specDetail,
                      pack: parseFloat(item['箱容']) || 1,
                      smallUnit: item['小單位'],
                      bigUnit: item['大單位'],
                      prices: priceObject 
                  };

                  if (!productName || !item['規格']) continue;

                  if (existingItem) {
                       Object.assign(existingItem, baseData);
                  } else {
                       const newItem = { ...baseData, id: nextId++ };
                       if (!newDB[productName]) newDB[productName] = [];
                       newDB[productName].push(newItem);
                  }
                  successCount++;

              // 模式 2: 更新庫存 (含批號)
              } else if (updateType === 'inventory') {
                  const warehouse = item['倉庫'] || '總倉';
                  const lot = item['批號'] || '';
                  const expiry = item['到期日'] || '';
                  const stock = parseFloat(item['庫存']) || 0;
                  
                  const priceItem = allSpecsFlat.find(p => p.productName === productName && p.specDetail === specDetail); // 注意：這裡需配合 productDatabase 結構調整查找邏輯，簡化起見假設 name 存在

                  // 實際上需要重新遍歷 productDatabase 找到對應 ID
                  let targetId = null;
                  Object.keys(newDB).forEach(pName => {
                      if(pName === productName) {
                          newDB[pName].forEach(spec => {
                              if(spec.specDetail === specDetail) targetId = spec.id;
                          });
                      }
                  });

                  if (targetId) {
                      if (!newInventoryDB[targetId]) newInventoryDB[targetId] = [];
                      // 簡單處理：直接新增一筆庫存紀錄
                      newInventoryDB[targetId].push({ warehouse, lot, expiry, stock });
                      successCount++;
                  }
              }
          }

          if (successCount > 0) {
              setProductDatabase(newDB);
              setInventoryDatabase(newInventoryDB); 
              localStorage.setItem('seafood_product_db', JSON.stringify(newDB));
              localStorage.setItem('seafood_inventory_db', JSON.stringify(newInventoryDB));
              alert(`數據庫更新成功！已處理 ${successCount} 條數據。`);
              setShowTemplates(false);
          } else {
              alert("未找到可更新的數據。");
          }
      };

      // ... (省略 saveAsTemplate, loadTemplate, deleteTemplate, calcItemTotal, calcTotal 等函式，保持不變)
      const saveAsTemplate = () => {
        const name = prompt("請輸入模板名稱:");
        if (!name) return;
        const newTemplates = [...templates, { id: Date.now(), name, items }];
        setTemplates(newTemplates);
        localStorage.setItem('seafood_corp_templates', JSON.stringify(newTemplates));
        alert(`已儲存: ${name}`);
      };

      const loadTemplate = (templateItems) => {
        if(confirm("確定載入？")) {
          const newItems = templateItems.map((item, idx) => ({ ...item, id: Date.now() + idx }));
          setItems(newItems);
          setShowTemplates(false);
        }
      };

      const deleteTemplate = (id) => {
        if(confirm("確定刪除？")) {
          const newTemplates = templates.filter(t => t.id !== id);
          setTemplates(newTemplates);
          localStorage.setItem('seafood_corp_templates', JSON.stringify(newTemplates));
        }
      };

      const calcItemTotal = (item) => (item.qty * item.packingContent) * item.price;
      const calcTotal = () => items.reduce((sum, item) => sum + calcItemTotal(item), 0);
      const calcTotalQty = () => items.reduce((sum, item) => sum + Number(item.qty), 0);
      const formatMoney = (n) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(n);

      const addItem = () => {
        const newId = Date.now();
        setItems([...items, { id: newId, name: '', specDetail: '', qty: 1, bigUnit: '件', packingContent: 1, smallUnit: 'KG', price: 0, imageBase64: '' }]);
      };
      const duplicateItem = (item) => setItems([...items, { ...item, id: Date.now() }]);
      const removeItem = (id) => {
        if(items.length > 1 && !confirm("刪除？")) return;
        setItems(items.filter(item => item.id !== id));
      };

      const handleNumericChange = (e) => {
          const value = e.target.value.trim();
          if (value === '') return 0;
          return parseFloat(value);
      };

      const updateItem = (id, field, value) => {
          setItems(items.map(item => item.id === id ? { ...item, [field]: value } : item));
          if (field === 'name' && showProductSelector) {
            setShowProductSelector(false);
            setEditingItemId(null);
          }
      };

      const handleNameFocus = (itemId) => {
          setEditingItemId(itemId);
          setShowProductSelector(true);
      };
      
      const getFullItemName = (item) => {
        const parts = [item.name, item.specDetail].filter(p => p && p.trim() !== '');
        return parts.join(' ');
      };
      
      const handleImageChange = (e, itemId) => {
          const file = e.target.files[0];
          if (file) {
              if (file.size > 512000) { alert("圖片過大"); return; }
              const reader = new FileReader();
              reader.onloadend = () => updateItem(itemId, 'imageBase64', reader.result);
              reader.readAsDataURL(file);
              e.target.value = null; 
          }
      };
      const clearImage = (itemId) => updateItem(itemId, 'imageBase64', '');
      const triggerFileInput = (itemId) => {
          const fileInput = document.getElementById(`file-input-${itemId}`);
          if (fileInput) fileInput.click();
      };

      const ProductSelectorModal = () => {
          const [search, setSearch] = useState('');
          const filteredProducts = COMMON_PRODUCTS.filter(p => p.includes(search));
          const selectProduct = (productName) => {
              updateItem(editingItemId, 'name', productName);
              setShowProductSelector(false);
              setTimeout(() => {
                  const specInput = document.querySelector(`#specDetail-${editingItemId}`);
                  if (specInput) specInput.focus();
              }, 100);
          };
          return (
              <div className="fixed inset-0 bg-black/30 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in fade-in">
                  <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl border border-gray-200 max-h-[80vh] overflow-y-auto">
                     <div className="flex justify-between items-center mb-4">
                        <h3 className="text-xl font-black text-black">選擇品項</h3>
                        <button onClick={() => setShowProductSelector(false)} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200"><LucideIcon name="X" size={20} className="text-black"/></button>
                     </div>
                     <input type="text" placeholder="搜尋..." value={search} onChange={(e) => setSearch(e.target.value)} className="w-full p-3 mb-4 border-b-2 border-blue-200 outline-none focus:border-blue-700 bg-gray-50 rounded-lg text-lg font-medium"/>
                     <div className="grid grid-cols-2 gap-2">
                       {filteredProducts.map(p => <button key={p} onClick={() => selectProduct(p)} className="text-base font-bold text-center py-3 bg-blue-50 text-blue-800 rounded-xl border border-blue-200 hover:bg-blue-100 active:scale-95">{p}</button>)}
                     </div>
                  </div>
              </div>
          );
      };
      
      const openSpecLookup = (itemId) => {
          const currentItem = items.find(i => i.id === itemId);
          if (!currentItem || !currentItem.name) {
              alert("請先在上方選擇主品名。");
              return;
          }
          setEditingItemId(itemId);
          setShowSpecLookup(true);
      };

      const applySpecPreset = (spec) => {
          let appliedPrice = 0;
          if (typeof spec.prices === 'object') {
              appliedPrice = spec.prices[customerPriceTier] || Object.values(spec.prices)[0];
          } else {
              appliedPrice = spec.prices;
          }

          const updatedItem = {
              specDetail: spec.specDetail,
              packingContent: spec.pack,
              smallUnit: spec.smallUnit,
              bigUnit: spec.bigUnit || '件',
              price: appliedPrice,
          };
          setItems(items.map(item => item.id === editingItemId ? { ...item, ...updatedItem } : item));
          setShowSpecLookup(false);
          setEditingItemId(null);
      };

      const SpecLookupModal = () => {
          const currentItem = items.find(i => i.id === editingItemId);
          const [search, setSearch] = useState(currentItem?.name || '');
          
          const allSpecs = Object.keys(productDatabase).flatMap(productName => 
              productDatabase[productName].map(spec => ({ ...spec, productName }))
          );
          const filteredSpecs = allSpecs.filter(spec => 
              spec.productName.includes(search) || spec.specDetail.includes(search)
          );

          const getDisplayPrice = (spec) => {
             if (typeof spec.prices === 'object') {
                 return spec.prices[customerPriceTier] || 'N/A';
             }
             return spec.prices;
          };

          return (
              <div className="fixed inset-0 bg-black/30 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in fade-in">
                  <div className="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl border border-gray-200 max-h-[90vh] overflow-y-auto">
                     <div className="flex justify-between items-center mb-6 border-b pb-3">
                        <div>
                            <h3 className="text-xl font-black text-black">規格查詢與庫存</h3>
                            <p className="text-xs text-blue-600 font-bold">當前報價等級: {customerPriceTier}</p>
                        </div>
                        <button onClick={() => setShowSpecLookup(false)} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition"><LucideIcon name="X" size={20} className="text-black"/></button>
                     </div>
                     
                     <input type="text" placeholder="搜尋..." value={search} onChange={(e) => setSearch(e.target.value)} className="w-full p-3 mb-4 border-b-2 border-blue-200 outline-none focus:border-blue-700 bg-gray-50 rounded-lg text-lg font-medium"/>
                     
                     <div className="space-y-3">
                       {filteredSpecs.map((spec, idx) => {
                           const inventoryList = inventoryDatabase[spec.id] || [];
                           const totalStock = inventoryList.reduce((sum, item) => sum + (parseFloat(item.stock) || 0), 0);
                           
                           return (
                               <div key={idx} onClick={() => applySpecPreset(spec)} className="bg-blue-50/50 p-4 rounded-xl border border-blue-200 hover:bg-blue-100 active:scale-[0.99] cursor-pointer">
                                  <div className="flex justify-between items-start mb-2">
                                     <div className="font-black text-lg text-blue-900 leading-tight">
                                         {spec.productName} <span className="text-base font-bold text-black ml-1">({spec.specDetail})</span>
                                     </div>
                                     <div className="text-right">
                                        <span className={`text-sm font-bold ${totalStock > 0 ? 'text-emerald-600' : 'text-red-500'}`}>
                                            總庫存: {totalStock}
                                        </span>
                                     </div>
                                  </div>
                                  
                                  {/* 顯示詳細分倉庫存與批號 */}
                                  {inventoryList.length > 0 && (
                                      <div className="mb-2 p-2 bg-white rounded-lg text-xs text-gray-600 space-y-1">
                                          {inventoryList.map((inv, i) => (
                                              <div key={i} className="flex justify-between">
                                                  <span>{inv.warehouse} {inv.lot ? `(批:${inv.lot})` : ''} {inv.expiry ? `(效:${inv.expiry})` : ''}</span>
                                                  <span className="font-bold">{inv.stock}</span>
                                              </div>
                                          ))}
                                      </div>
                                  )}

                                  <div className="flex justify-between items-center border-t border-blue-100 pt-2 text-sm text-gray-700">
                                     <span>
                                         箱容: {spec.pack}{spec.smallUnit}/{spec.bigUnit}
                                     </span>
                                     <span className="font-black text-xl text-black">
                                         ${getDisplayPrice(spec)} <span className="text-xs font-normal text-gray-500">/{spec.smallUnit}</span>
                                     </span>
                                  </div>
                               </div>
                           );
                       })}
                     </div>
                     {filteredSpecs.length === 0 && (
                        <div className="text-center text-gray-500 py-8">找不到符合的規格。請手動輸入。</div>
                     )}
                  </div>
              </div>
          );
      };

      const DataManagementModal = () => {
          const [jsonInput, setJsonInput] = useState(JSON.stringify(productDatabase, null, 2));
          const [csvInput, setCsvInput] = useState('');

          const handleTabularUpdate = (updateType) => {
              parseAndSaveCSV(csvInput, updateType);
          };

          return (
              <div className="fixed inset-0 bg-black/30 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in fade-in">
                  <div className="bg-white w-full max-w-xl rounded-2xl p-6 shadow-2xl border border-gray-200 max-h-[90vh] overflow-y-auto">
                     <div className="flex justify-between items-center mb-6">
                        <h3 className="text-xl font-black text-black flex items-center gap-2">
                            <LucideIcon name="Database" size={20} /> 數據管理中心
                        </h3>
                        <button onClick={() => setShowTemplates(false)} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition"><LucideIcon name="X" size={20} className="text-black"/></button>
                     </div>

                     <h4 className="text-lg font-black text-blue-700 mb-3 border-b pb-2">1. 更新報價與規格</h4>
                     <p className="text-sm text-gray-700 mb-3">請貼上包含**價格**的報價總表：(Excel 複製)</p>
                     <div className='bg-gray-100 p-3 rounded-lg border border-gray-300 mb-4'>
                        <p className='text-xs text-black font-mono break-all leading-tight'>
                            品名 | 規格 | 箱容 | 小單位 | 大單位 | 價格_生意價 | ...
                        </p>
                     </div>
                     <textarea className="w-full h-24 p-3 border border-gray-300 rounded-lg font-mono text-sm focus:ring-blue-500 focus:border-blue-500 mb-2" value={csvInput} onChange={(e) => setCsvInput(e.target.value)} placeholder="貼上報價表..."/>
                     <div className='mt-2 flex justify-end'>
                         <button onClick={() => handleTabularUpdate('price_spec')} className="bg-blue-700 text-white px-5 py-2 rounded-full font-bold shadow-md hover:bg-blue-800 active:scale-95 transition flex items-center gap-1"><LucideIcon name="Upload" size={18} className="text-white"/> 更新報價</button>
                     </div>

                     <h4 className="text-lg font-black text-blue-700 mt-8 mb-3 border-t pt-4 border-gray-100">2. 更新庫存與批號</h4>
                     <p className="text-sm text-gray-700 mb-3">請貼上包含**庫存、倉庫、批號**的表格：</p>
                     <div className='bg-gray-100 p-3 rounded-lg border border-gray-300 mb-4'>
                        <p className='text-xs text-black font-mono break-all leading-tight'>
                            品名 | 規格 | 倉庫 | 批號 | 到期日 | 庫存
                        </p>
                     </div>
                     <textarea className="w-full h-24 p-3 border border-gray-300 rounded-lg font-mono text-sm focus:ring-blue-500 focus:border-blue-500 mb-2" value={csvInput} onChange={(e) => setCsvInput(e.target.value)} placeholder="貼上庫存表..."/>
                     <div className='mt-4 flex justify-end'>
                         <button onClick={() => handleTabularUpdate('inventory')} className="bg-green-600 text-white px-5 py-2 rounded-full font-bold shadow-md hover:bg-green-700 active:scale-95 transition flex items-center gap-1"><LucideIcon name="Warehouse" size={18} className="text-white"/> 更新庫存</button>
                      </div>
                  </div>
              </div>
          );
      };

      const shareToLine = () => {
        let msg = `【報價】 ${customerInfo.date}\n\n`;
        msg += `客戶: ${customerInfo.name}\n`;
        msg += `單號: ${customerInfo.quoteNo}\n`;
        msg += `------------------\n`;
        items.forEach((item, idx) => {
          if (item.name) {
            const fullSpec = getFullItemName(item);
            msg += `${idx+1}.${fullSpec} [${item.packingContent}${item.smallUnit}/${item.bigUnit}]\n`;
            if(!isQuoteOnly){
              msg += `  ${item.qty}${item.bigUnit} x $${item.price} = $${calcItemTotal(item).toLocaleString()}\n`;
            } else {
               msg += `  單價: $${item.price}/${item.smallUnit}\n`;
            }
          }
        });
        msg += `------------------\n`;
        if(!isQuoteOnly) {
             msg += `總計: ${formatMoney(calcTotal())}\n`;
        } else {
             msg += `總計: (請詢價)\n`;
        }
        msg += `結帳: ${customerPriceTier} / ${customerInfo.paymentMethod}\n`;
        if(companyInfo.name) msg += `\n廠商: ${companyInfo.name}`;
        window.open(`https://line.me/R/msg/text/?${encodeURIComponent(msg)}`, '_blank');
      };
      
      const getA4HeaderTitle = () => isQuoteOnly ? '純報價單 (不含數量與金額)' : (companyInfo.name || '報價單');

      return (
        <div className="min-h-screen pb-24 font-sans bg-white">
          
          {showProductSelector && <ProductSelectorModal />}
          {showSpecLookup && <SpecLookupModal />}
          {showTemplates && <DataManagementModal />}

          {/* 導航 */}
          <div className="bg-white border-b border-gray-200 p-4 sticky top-0 z-30 flex justify-between items-center no-print">
            <div className="flex items-center gap-3">
              {viewMode === 'preview' ? (
                 <button onClick={() => setViewMode('edit')} className="p-2 hover:bg-blue-50 rounded-full transition"><LucideIcon name="ChevronLeft" size={24}/></button>
              ) : (
                 <LucideIcon name="Anchor" size={28} className="text-blue-700" />
              )}
              <h1 className="text-lg font-black text-black tracking-wide">
                {viewMode === 'edit' ? '訂單報價系統 Pro' : (previewFormat === 'mobile' ? '手機預覽' : 'A4 預覽')}
              </h1>
            </div>
            
            {viewMode === 'edit' ? (
              <button onClick={() => { setViewMode('preview'); setPreviewFormat('mobile'); }} className="px-5 py-2 bg-white text-blue-700 border-2 border-blue-700 rounded-full text-sm flex items-center gap-2 shadow-sm hover:bg-blue-50 active:scale-95 transition font-bold">
                預覽 <LucideIcon name="ArrowRight" size={18} className="text-blue-700"/>
              </button>
            ) : (
              <div className="flex bg-gray-100 rounded-lg p-1 border border-gray-200">
                <button onClick={() => setPreviewFormat('mobile')} className={`px-3 py-1.5 rounded-md text-sm font-bold transition ${previewFormat === 'mobile' ? 'bg-white text-blue-700 shadow' : 'text-gray-500'}`}>手機</button>
                <button onClick={() => setPreviewFormat('a4')} className={`px-3 py-1.5 rounded-md text-sm font-bold transition ${previewFormat === 'a4' ? 'bg-white text-blue-700 shadow' : 'text-gray-500'}`}>A4</button>
              </div>
            )}
          </div>

          <div className="max-w-3xl mx-auto p-3 md:p-6 print:p-0 print:max-w-none">
            
            {/* === 編輯模式 === */}
            {viewMode === 'edit' && (
              <div className="space-y-6 animate-in fade-in duration-300">
                
                {/* 模板按鈕 */}
                <div className="flex gap-3 overflow-x-auto pb-1 no-scrollbar">
                   <button onClick={() => setShowTemplates(true)} className="flex-1 flex justify-center items-center gap-2 bg-white text-blue-700 px-4 py-3 rounded-xl border-2 border-red-300 font-bold active:bg-blue-50 transition whitespace-nowrap">
                      <LucideIcon name="Database" size={20} className="text-red-500"/> 數據管理
                   </button>
                   <button onClick={saveAsTemplate} className="flex-1 flex justify-center items-center gap-2 bg-white text-blue-700 px-4 py-3 rounded-xl border-2 border-blue-100 font-bold active:bg-blue-50 transition whitespace-nowrap">
                      <LucideIcon name="Save" size={20}/> 存為模板
                   </button>
                </div>

                {/* 1. 訂單資訊 (純報價開關在日期右側) */}
                <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
                  <div className="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
                    
                    <div className="flex items-center gap-4">
                       <h2 className="text-sm font-black text-blue-700 uppercase tracking-wider flex items-center gap-2">
                           <LucideIcon name="Package" size={18}/> 訂單資訊
                       </h2>
                    </div>

                    {/* 日期和純報價開關 */}
                    <div className='flex items-center gap-4'>
                       <span className="text-sm font-bold text-black bg-gray-100 px-2 py-1 rounded">
                           {customerInfo.date}
                       </span>
                       {/* PURE QUOTE TOGGLE (最右側) */}
                       <div className="flex items-center gap-1 bg-gray-100 p-1.5 rounded-xl border border-gray-200 shrink-0">
                         <label htmlFor="quoteOnly" className="text-sm font-black text-gray-700 whitespace-nowrap">純報價</label>
                         <input 
                           type="checkbox" 
                           id="quoteOnly"
                           checked={isQuoteOnly} 
                           onChange={(e) => setIsQuoteOnly(e.target.checked)}
                           className="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                         />
                       </div>
                    </div>

                  </div>
                  <div className="space-y-5">
                    <div className="flex gap-4">
                       <div className="flex-1">
                          <label className="text-sm font-bold text-gray-500 block mb-1">客戶名稱</label>
                          <input type="text" className="input-corporate w-full py-2 border-b-2 border-gray-300 outline-none font-black text-xl bg-transparent placeholder:text-gray-300"
                           value={customerInfo.name} onChange={(e) => setCustomerInfo({...customerInfo, name: e.target.value})} placeholder="輸入名稱..." />
                       </div>
                       <div className="w-1/3">
                          <label className="text-sm font-bold text-blue-600 block mb-1">價格等級</label>
                          <select className="input-corporate w-full py-2 border-b-2 border-blue-200 outline-none bg-transparent text-lg font-black text-blue-800 text-center"
                             value={customerPriceTier} onChange={(e) => setCustomerPriceTier(e.target.value)}>
                             {priceTiers.map(t => <option key={t} value={t}>{t}</option>)}
                          </select>
                       </div>
                    </div>
                    
                    <div className="w-full">
                          <label className="text-sm font-bold text-gray-500 block mb-1">結帳方式</label>
                          <select className="input-corporate w-full py-2 border-b-2 border-gray-300 outline-none bg-transparent text-lg font-bold"
                             value={customerInfo.paymentMethod} onChange={(e) => setCustomerInfo({...customerInfo, paymentMethod: e.target.value})}>
                             {paymentMethods.map(m => <option key={m} value={m}>{m}</option>)}
                          </select>
                       </div>

                    <div className="grid grid-cols-3 gap-4">
                        <div className="col-span-1">
                           <label className="text-xs font-bold text-gray-500 block mb-1">單號</label>
                           <input type="text" className="input-corporate w-full py-1 border-b-2 border-gray-300 outline-none text-base font-medium"
                            value={customerInfo.quoteNo} onChange={(e) => setCustomerInfo({...customerInfo, quoteNo: e.target.value})} />
                        </div>
                        <div className="col-span-1">
                           <label className="text-xs font-bold text-gray-500 block mb-1">統編</label>
                           <input type="text" className="input-corporate w-full py-1 border-b-2 border-gray-300 outline-none text-base font-medium"
                            value={customerInfo.taxId} onChange={(e) => setCustomerInfo({...customerInfo, taxId: e.target.value})} />
                        </div>
                        <div className="col-span-1">
                           <label className="text-xs font-bold text-gray-500 block mb-1">電話</label>
                           <input type="text" className="input-corporate w-full py-1 border-b-2 border-gray-300 outline-none text-base font-medium"
                            value={customerInfo.contact} onChange={(e) => setCustomerInfo({...customerInfo, contact: e.target.value})} />
                        </div>
                    </div>
                    <div>
                        <label className="text-xs font-bold text-gray-500 block mb-1">地址</label>
                        <input type="text" className="input-corporate w-full py-1 border-b-2 border-gray-300 outline-none text-base font-medium"
                          value={customerInfo.address} onChange={(e) => setCustomerInfo({...customerInfo, address: e.target.value})} placeholder="送貨地址 (選填)" />
                    </div>
                  </div>
                </div>

                {/* 2. 報價明細 */}
                <div className="space-y-4">
                    {items.map((item, index) => (
                      <div key={item.id} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-200 relative">
                        
                        <button onClick={() => removeItem(item.id)} className="absolute top-4 right-4 text-gray-300 hover:text-red-600 p-2">
                           <LucideIcon name="Trash2" size={20} className="text-gray-300 hover:text-red-600"/>
                        </button>

                        {/* 品名 + 規格細節輸入 (優化結構) */}
                        <div className="mb-6 pr-10 space-y-2">
                           {/* 主品名 (點擊觸發選單) */}
                           <div className="flex items-end">
                              <label className="text-sm font-black text-gray-400 mr-2 shrink-0">{index+1}.</label>
                              <div className='flex-1'>
                                 <label className="text-xs font-bold text-gray-500 block">品項名稱 (點擊選單)</label>
                                 <input 
                                    type="text" 
                                    className="input-corporate w-full py-2 border-b-2 border-gray-300 outline-none font-black text-xl bg-transparent placeholder:text-gray-300 cursor-pointer"
                                    value={item.name} 
                                    onChange={(e) => updateItem(item.id, 'name', e.target.value)}
                                    onFocus={() => handleNameFocus(item.id)}
                                    placeholder="點擊選擇或登打品項名稱" 
                                 />
                              </div>
                           </div>
                           {/* 規格細節 (手動登打 - 輔助資訊) */}
                           <div className='pl-6'>
                              <label className="text-xs font-bold text-gray-500 block mt-1">規格細節 (40/50, 紅太陽, 等級)</label>
                              <div className="flex items-center gap-4">
                                 <input 
                                    type="text" 
                                    id={`specDetail-${item.id}`} // 用於聚焦
                                    className="w-full py-1 border-b border-gray-200 outline-none focus:border-blue-500 text-base font-medium bg-transparent"
                                    value={item.specDetail} 
                                    onChange={(e) => updateItem(item.id, 'specDetail', e.target.value)}
                                    placeholder="輸入規格、品牌、等級..."
                                 />
                                 <button onClick={() => openSpecLookup(item.id)} className="text-xs font-bold text-blue-700 flex items-center gap-1 transition py-1 px-3 rounded-full border border-blue-200 hover:bg-blue-50 whitespace-nowrap">
                                    <LucideIcon name="Search" size={14} className="text-blue-700"/> 查詢規格
                                 </button>
                              </div>
                           </div>
                        </div>

                        {/* 輸入區塊 (Grid Layout) */}
                        <div className="grid grid-cols-12 gap-4 mb-2">
                           
                           {/* 1. 叫貨數量 (3/12 = 25%) */}
                           <div className="flex flex-col col-span-3">
                              <label className="text-xs font-black text-blue-700 uppercase tracking-wide mb-1">叫貨數量</label>
                              <div className="flex items-baseline border-b-4 border-blue-200 focus-within:border-blue-700 transition-colors pb-1">
                                 <input 
                                    type="number" 
                                    inputMode="numeric"
                                    className="w-full text-xl font-black outline-none bg-transparent text-center text-blue-900 number-input-lg" 
                                    value={item.qty === 0 ? '' : item.qty} 
                                    onChange={(e) => updateItem(item.id, 'qty', handleNumericChange(e))} 
                                    min="0"
                                 />
                                 <span className="text-sm font-bold text-blue-700 ml-1">
                                    <select className="bg-transparent outline-none appearance-none" 
                                       value={item.bigUnit} onChange={(e) => updateItem(item.id, 'bigUnit', e.target.value)}>
                                       {bigUnits.map(u => <option key={u} value={u}>{u}</option>)}
                                    </select>
                                 </span>
                              </div>
                           </div>

                           {/* 2. 箱容規格 (3/12 = 25%) */}
                           <div className="flex flex-col col-span-3">
                              <label className="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">箱容規格</label>
                              <div className="flex items-baseline border-b-2 border-gray-300 focus-within:border-blue-700 transition-colors pb-1">
                                 <input 
                                    type="number" 
                                    inputMode="numeric"
                                    className="w-full text-xl font-bold outline-none bg-transparent text-center number-input-lg" 
                                    placeholder="12"
                                    value={item.packingContent === 0 ? '' : item.packingContent} 
                                    onChange={(e) => updateItem(item.id, 'packingContent', handleNumericChange(e))} 
                                    min="0"
                                 />
                                 <span className="text-sm font-bold text-gray-500 mx-1 whitespace-nowrap">{item.smallUnit}/</span>
                                 <span className="text-sm font-bold text-gray-500">{item.bigUnit}</span>
                              </div>
                           </div>

                           {/* 3. 單價 (6/12 = 50%) */}
                           <div className="flex flex-col col-span-6">
                              <label className="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">單價</label>
                              <div className="flex items-baseline border-b-2 border-gray-300 focus-within:border-blue-700 transition-colors pb-1">
                                 <span className="text-gray-400 mr-1 font-bold">$</span>
                                 <input 
                                    type="number" 
                                    inputMode="numeric"
                                    className="w-full text-xl font-bold outline-none bg-transparent text-right number-input-lg" 
                                    value={item.price === 0 ? '' : item.price} 
                                    onChange={(e) => updateItem(item.id, 'price', handleNumericChange(e))} 
                                    min="0"
                                 />
                                 <select className="text-sm font-bold bg-transparent outline-none text-gray-600 ml-1 w-14 text-right" 
                                    value={item.smallUnit} onChange={(e) => updateItem(item.id, 'smallUnit', e.target.value)}>
                                    {smallUnits.map(u => <option key={u} value={u}>/{u}</option>)}
                                 </select>
                              </div>
                           </div>
                        </div>

                        {/* 底部資訊 + 圖片功能 */}
                        <div className="flex justify-between items-center mt-5 pt-4 border-t border-gray-100">
                           <div className='flex gap-4 items-center'>
                               {/* 新增圖片按鈕 (使用 onClick 触发) */}
                               <button 
                                  onClick={() => triggerFileInput(item.id)} 
                                  className="text-xs font-bold text-blue-700 hover:text-blue-500 flex items-center gap-1 transition py-2 px-2 rounded-lg bg-blue-50 cursor-pointer"
                               >
                                  <LucideIcon name="Image" size={16} className="text-blue-700"/> 新增圖片
                               </button>
                               {/* 隱藏的檔案輸入框 - 保持 hidden */}
                               <input 
                                   id={`file-input-${item.id}`}
                                   type="file" 
                                   accept="image/jpeg, image/png"
                                   onChange={(e) => handleImageChange(e, item.id)}
                                   className="hidden" 
                               />

                               {/* 圖片縮圖和刪除 */}
                               {item.imageBase64 && (
                                   <div className='flex items-center gap-2'>
                                       <img src={item.imageBase64} className='w-12 h-12 object-cover rounded-md border border-gray-300 shadow-sm' alt="產品縮圖"/>
                                       <button onClick={() => clearImage(item.id)} className="p-1 text-red-500 hover:text-red-700">
                                           <LucideIcon name="X" size={16} className="text-red-500"/>
                                       </button>
                                   </div>
                               )}
                           </div>
                           
                           <div className="text-right">
                              <div className="text-xs font-bold text-gray-400 mb-1">共 {item.qty * item.packingContent} {item.smallUnit}</div>
                              <div className="text-xl font-black text-black">${calcItemTotal(item).toLocaleString()}</div>
                           </div>
                        </div>
                      </div>
                    ))}

                  <button onClick={addItem} className="w-full py-5 bg-white border-2 border-dashed border-blue-200 rounded-2xl text-blue-700 hover:border-blue-500 hover:bg-blue-50 transition flex justify-center items-center gap-2 font-black text-lg shadow-sm active:scale-[0.99]">
                    <LucideIcon name="Plus" size={22}/> 新增品項
                  </button>
                </div>

                {/* 賣方設定 */}
                <div className="bg-white px-5 py-4 rounded-xl border border-gray-200 shadow-sm">
                  <div className="flex justify-between items-center">
                     <span className="text-xs font-black text-gray-400 uppercase tracking-widest">SELLER INFO</span>
                     <button onClick={saveCompanyInfo} className="text-xs font-bold bg-gray-100 text-gray-600 px-3 py-1.5 rounded hover:bg-gray-200">儲存設定</button>
                  </div>
                  <div className="mt-4 grid grid-cols-2 gap-4">
                    <input type="text" placeholder="公司名" className="p-2 border-b border-gray-200 text-base font-medium outline-none focus:border-blue-700" value={companyInfo.name} onChange={(e) => setCompanyInfo({...companyInfo, name: e.target.value})} />
                    <input type="text" placeholder="電話" className="p-2 border-b border-gray-200 text-base font-medium outline-none focus:border-blue-700" value={companyInfo.phone} onChange={(e) => setCompanyInfo({...companyInfo, phone: e.target.value})} />
                    <input type="text" placeholder="地址" className="col-span-2 p-2 border-b border-gray-200 text-base font-medium outline-none focus:border-blue-700" value={companyInfo.address} onChange={(e) => setCompanyInfo({...companyInfo, address: e.target.value})} />
                    <textarea placeholder="備註/匯款" className="col-span-2 p-2 border-b border-gray-200 text-base font-medium outline-none focus:border-blue-700 h-20 resize-none" value={companyInfo.bankInfo} onChange={(e) => setCompanyInfo({...companyInfo, bankInfo: e.target.value})}></textarea>
                  </div>
                </div>
              </div>
            )}

            {/* === 模板 Modal === */}
            {showTemplates && (
              <div className="fixed inset-0 bg-black/20 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in fade-in">
                <div className="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl border border-gray-200 max-h-[80vh] overflow-y-auto">
                   <div className="flex justify-between items-center mb-6">
                      <h3 className="text-xl font-black text-black">選擇模板</h3>
                      <button onClick={() => setShowTemplates(false)} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition"><LucideIcon name="X" size={20} className="text-black"/></button>
                   </div>
                   
                   {templates.length === 0 ? (
                     <div className="text-center text-gray-400 py-10 font-medium">暫無模板</div>
                   ) : (
                     <div className="space-y-3">
                       {templates.map(t => (
                         <div key={t.id} className="flex justify-between items-center bg-gray-50 p-4 rounded-2xl border-2 border-transparent hover:border-blue-500 transition cursor-pointer group">
                            <div onClick={() => loadTemplate(t.items)} className="flex-1">
                               <div className="font-bold text-lg text-black">{t.name}</div>
                               <div className="text-sm font-medium text-gray-500">{t.items.length} 品項</div>
                            </div>
                            <button onClick={() => deleteTemplate(t.id)} className="p-3 text-gray-400 hover:text-red-600 transition">
                               <LucideIcon name="Trash2" size={20} className="text-gray-400 hover:text-red-600"/>
                            </button>
                         </div>
                       ))}
                     </div>
                   )}
                </div>
              </div>
            )}

            {/* === 預覽模式 === */}
            {viewMode === 'preview' && (
              <div className="animate-in fade-in duration-300">
                {previewFormat === 'mobile' && (
                  <div className="max-w-md mx-auto bg-white min-h-[80vh] shadow-lg rounded-xl overflow-hidden border border-gray-200">
                    <div className="bg-blue-700 text-white p-6">
                       <div className="flex justify-between items-start">
                         <div>
                           <h2 className="text-2xl font-black">{customerInfo.name || '客戶名稱'}</h2>
                           <p className="text-blue-100 text-sm mt-1 font-medium">{customerInfo.date} | {customerInfo.quoteNo}</p>
                         </div>
                         <div className="text-right">
                           {/* 純報價模式隱藏總金額 */}
                           {!isQuoteOnly && <span className="text-3xl font-black block">${calcTotal().toLocaleString()}</span>}
                           <span className="text-xs font-bold bg-blue-600 px-3 py-1 rounded-full text-white">{customerInfo.paymentMethod}</span>
                         </div>
                       </div>
                    </div>

                    <div className="divide-y divide-gray-100">
                       {items.map((item, i) => (
                         <div key={i} className="p-5 hover:bg-gray-50">
                            <div className="flex justify-between mb-2">
                               <span className="font-black text-lg text-black">{getFullItemName(item)}</span>
                               {/* 純報價模式隱藏小計金額 */}
                               {!isQuoteOnly && <span className="font-black text-lg text-black">${calcItemTotal(item).toLocaleString()}</span>}
                            </div>
                            <div className="flex justify-between items-center text-sm font-medium text-gray-500">
                               <div className="flex gap-2 items-center">
                                  {item.imageBase64 && <img src={item.imageBase64} className='w-12 h-12 object-cover rounded-md border border-gray-300 shadow-sm' alt="產品縮圖"/>}
                                  <span className="bg-gray-100 px-2 py-1 rounded text-xs text-gray-600 font-bold">規格: {item.packingContent}{item.smallUnit}/{item.bigUnit}</span>
                                  <span className="font-bold text-black">${item.price}/{item.smallUnit}</span>
                               </div>
                               {/* 純報價模式隱藏訂購量 */}
                               {!isQuoteOnly && (
                                   <span className="font-bold text-blue-700 bg-blue-50 px-3 py-1 rounded-full">
                                     {item.qty}{item.bigUnit} (共{item.qty * item.packingContent}{item.smallUnit})
                                   </span>
                               )}
                            </div>
                         </div>
                       ))}
                    </div>

                    <div className="p-6 bg-gray-50 text-sm text-gray-600 border-t border-gray-200 mt-4">
                       <p className="font-black text-black mb-2 text-base">備註 / 匯款資訊:</p>
                       <p className="whitespace-pre-wrap leading-relaxed font-medium">{companyInfo.bankInfo}</p>
                       <p className="mt-4 whitespace-pre-wrap text-xs">{companyInfo.note}</p>
                       <div className="mt-6 pt-4 border-t border-gray-200 text-center">
                          <div className="font-black text-black text-lg">{companyInfo.name}</div>
                          <div className="font-medium">{companyInfo.phone}</div>
                       </div>
                    </div>
                  </div>
                )}

                {previewFormat === 'a4' && (
                  <div className="bg-white shadow-xl p-8 min-h-[297mm] mx-auto print:shadow-none print:p-0 text-black text-sm leading-tight">
                    <div className="border-b-4 border-blue-700 pb-4 mb-6 flex justify-between items-end">
                       <div>
                          <h1 className="text-4xl font-black text-blue-800 mb-2">{getA4HeaderTitle()}</h1>
                          <p className="text-gray-600 font-bold">{companyInfo.address} {companyInfo.phone && `| ${companyInfo.phone}`}</p>
                       </div>
                       <div className="text-right">
                          <p className="text-gray-500 mb-1 font-bold">單號: <span className="font-black text-black text-lg">{customerInfo.quoteNo}</span></p>
                          <p className="text-gray-500 font-bold">日期: <span className="font-black text-black">{customerInfo.date}</span></p>
                       </div>
                    </div>

                    <div className="grid grid-cols-2 gap-6 mb-6 border-2 border-gray-200 p-4 bg-gray-50 rounded-lg">
                       <div>
                          <p className="text-xs text-gray-500 mb-1 font-bold">客戶名稱 / 統編</p>
                          <p className="font-black text-xl text-black mb-2">{customerInfo.name} <span className="font-bold text-base ml-2 text-gray-600">{customerInfo.taxId}</span></p>
                          <p className="text-xs text-gray-500 mb-1 font-bold">送貨地址</p>
                          <p className="font-bold text-black">{customerInfo.address}</p>
                       </div>
                       <div className="text-right border-l-2 border-gray-200 pl-6">
                          <p className="text-xs text-gray-500 mb-1 font-bold">結帳方式</p>
                          <p className="font-black text-lg text-blue-800 mb-2">{customerInfo.paymentMethod}</p>
                          <p className="text-xs text-gray-500 mb-1 font-bold">聯絡人</p>
                          <p className="font-bold text-black">{customerInfo.contact} {customerInfo.phone}</p>
                       </div>
                    </div>

                    <table className="w-full mb-8 border-collapse border border-black text-sm table-fixed">
                      <thead>
                        <tr className="bg-gray-100 text-black">
                          <th className="border border-gray-400 py-2 px-1 w-10 text-center font-bold">No.</th>
                          <th className="border border-gray-400 py-2 px-3 text-left font-bold w-auto">品名規格</th>
                          {/* 訂購量 (Hidden if QuoteOnly) */}
                          <th className={`border border-gray-400 py-2 px-1 w-20 text-center font-bold whitespace-nowrap ${isQuoteOnly && 'hidden'}`}>訂購量</th>
                          {/* 箱容 */}
                          <th className="border border-gray-400 py-2 px-1 w-16 text-center font-bold whitespace-nowrap text-sm">箱容</th>
                          {/* 總數量 (Hidden if QuoteOnly) */}
                          <th className={`border border-gray-400 py-2 px-1 w-24 text-center font-bold whitespace-nowrap ${isQuoteOnly && 'hidden'}`}>總數量</th>
                          {/* 單價 (Wider) */}
                          <th className="border border-gray-400 py-2 px-2 w-32 text-right font-bold whitespace-nowrap">單價</th>
                          {/* 金額 (Hidden if QuoteOnly) */}
                          <th className={`border border-gray-400 py-2 px-2 w-36 text-right font-bold whitespace-nowrap ${isQuoteOnly && 'hidden'}`}>金額</th>
                        </tr>
                      </thead>
                      <tbody>
                        {items.map((item, index) => (
                          <tr key={index} className="hover:bg-gray-50">
                            <td className="border border-gray-300 py-3 px-1 text-center text-xs font-bold align-top">{index + 1}</td>
                            <td className="border border-gray-300 py-3 px-3 align-top">
                               {/* 圖片顯示 (僅在有圖片時) */}
                               {item.imageBase64 && (
                                   <div className='mb-2'>
                                       <img src={item.imageBase64} className='w-20 h-20 object-cover rounded-md border border-gray-300 shadow-sm float-left mr-3 print:w-16 print:h-16' alt="產品圖"/>
                                   </div>
                               )}
                               <div className="A4-product-name">{getFullItemName(item)}</div>
                            </td>
                            {/* 訂購量 */}
                            <td className={`border border-gray-300 py-3 px-1 text-center font-black text-base text-black align-top whitespace-nowrap ${isQuoteOnly && 'hidden'}`}>{item.qty}{item.bigUnit}</td>
                            {/* 箱容 - 修正為 text-sm (與內容字體一致) */}
                            <td className="border border-gray-300 py-3 px-1 text-center text-sm font-bold text-black align-top whitespace-nowrap">{item.packingContent}{item.smallUnit}/{item.bigUnit}</td>
                            {/* 總數量 */}
                            <td className={`border border-gray-300 py-3 px-1 text-center text-sm bg-gray-50 font-bold print:bg-transparent align-top whitespace-nowrap ${isQuoteOnly && 'hidden'}`}>{item.qty * item.packingContent}{item.smallUnit}</td>
                            {/* 單價 */}
                            <td className="border border-gray-300 py-3 px-2 text-right text-sm font-bold text-black align-top whitespace-nowrap">${item.price}/{item.smallUnit}</td>
                            {/* 金額 */}
                            <td className={`border border-gray-300 py-3 px-2 text-right font-black text-base text-black align-top whitespace-nowrap ${isQuoteOnly && 'hidden'}`}>{formatMoney(calcItemTotal(item))}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>

                    {/* 總計區塊 (純報價模式下隱藏) */}
                    {!isQuoteOnly && (
                        <div className="flex justify-end mb-8">
                           <div className="w-1/3">
                              <div className="flex justify-between border-b-2 border-black py-2 text-sm font-bold">
                                 <span className="text-gray-600">總件數</span> <span className="text-black">{calcTotalQty()} 件</span>
                              </div>
                              <div className="flex justify-between py-3 text-3xl font-black text-black border-b-4 border-black">
                                 <span>總計</span> <span>{formatMoney(calcTotal())}</span>
                              </div>
                           </div>
                        </div>
                    )}

                    <div className="grid grid-cols-2 gap-10 mt-auto pt-8">
                       <div className="border-2 border-gray-200 rounded-lg p-4 text-sm bg-gray-50 print:bg-white">
                          <span className="font-black underline mb-2 block text-black">備註 / 匯款資訊:</span>
                          <p className="whitespace-pre-wrap leading-relaxed font-bold text-gray-700">{companyInfo.bankInfo}</p>
                          <p className="whitespace-pre-wrap mt-4 text-gray-500 text-xs">{companyInfo.note}</p>
                       </div>
                       <div className="flex flex-col justify-end gap-10 text-base pb-4">
                          <div className="flex justify-between items-end border-b-2 border-black pb-2"><span className="font-bold">賣方簽章:</span><div className="w-32"></div></div>
                          <div className="flex justify-between items-end border-b-2 border-black pb-2"><span className="font-bold">客戶簽收:</span><div className="w-32"></div></div>
                       </div>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>

          <div className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-gray-200 p-3 px-6 flex items-center justify-between z-40 print:hidden shadow-[0_-4px_20px_rgba(0,0,0,0.1)] safe-area-bottom">
             <div className="flex flex-col">
                <span className="text-[10px] text-slate-500 uppercase tracking-wider font-bold">Total Amount</span>
                <span className="text-2xl font-black text-blue-700">
                   {isQuoteOnly ? '---' : formatMoney(calcTotal())}
                </span>
             </div>
             <div className="flex gap-3">
                <button onClick={shareToLine} className="bg-green-600 text-white px-6 py-3 rounded-full font-bold text-sm flex items-center gap-2 shadow-lg shadow-green-100 active:scale-95 transition"><LucideIcon name="Send" size={18} className="text-white"/> LINE</button>
                {viewMode === 'preview' && <button onClick={() => window.print()} className="bg-blue-800 text-white px-4 py-3 rounded-full font-bold text-sm flex items-center gap-2 shadow-lg active:scale-95 transition"><LucideIcon name="Printer" size={18} className="text-white"/></button>}
             </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<SeafoodCorporateApp />);
  </script>
</body>
</html>