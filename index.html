<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>八方環球報價 V9.0 (大字體版)</title>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    window.firebaseModules = { initializeApp, getDatabase, ref, set, onValue };
  </script>

  <style>
    * { 
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", sans-serif;
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: none;
      background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);
    }
    
    /* 字體優化 - 手機版適中字體，確保一屏2個卡片 */
    input, select, textarea {
      font-size: 16px !important;
      -webkit-user-select: text;
      user-select: text;
    }
    
    /* 按鈕優化 - 手機版 */
    button {
      min-height: 46px;
      touch-action: manipulation;
      -webkit-user-select: none;
      user-select: none;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 16px;
    }
    
    button:active {
      transform: scale(0.96);
    }
    
    /* 手機版緊湊優化 - 確保一屏2個產品卡片 */
    @media (max-width: 1023px) {
      /* 產品卡片緊湊 */
      .gradient-card.product-item-card {
        padding: 16px !important;
      }
      
      .product-list-space {
        gap: 12px !important;
      }
      
      /* 序號適中 */
      .item-number {
        width: 44px !important;
        height: 44px !important;
        font-size: 20px !important;
      }
      
      /* 產品名稱適中 */
      .product-name-desktop {
        font-size: 19px !important;
        line-height: 1.3 !important;
      }
      
      .product-spec-desktop {
        font-size: 15px !important;
      }
      
      /* 數字輸入適中 */
      .number-input-large {
        font-size: 26px !important;
      }
      
      /* 小計適中 */
      .subtotal-desktop {
        font-size: 24px !important;
      }
      
      /* 標籤適中 */
      .label-desktop {
        font-size: 11px !important;
      }
      
      /* 總額適中 */
      .total-desktop {
        font-size: 36px !important;
      }
      
      /* 客戶資訊緊湊 */
      .customer-info-card {
        padding: 20px !important;
      }
      
      .customer-info-card .grid {
        gap: 14px !important;
      }
      
      /* 客戶名稱輸入 */
      .customer-info-card .text-2xl,
      .customer-info-card input[style*="24px"] {
        font-size: 20px !important;
      }
      
      /* 其他輸入框 */
      .customer-info-card .text-lg,
      .customer-info-card .p-4 {
        padding: 12px 14px !important;
        font-size: 15px !important;
      }
      
      /* 圖片上傳區緊湊 */
      .image-upload-section {
        padding-top: 12px !important;
        margin-top: 12px !important;
      }
      
      .product-image-desktop {
        width: 52px !important;
        height: 52px !important;
      }
      
      /* 底部固定列緊湊 */
      .fixed.bottom-0 {
        padding: 14px 16px !important;
      }
      
      /* 主容器緊湊 */
      .max-w-4xl {
        padding: 14px !important;
      }
      
      /* 頂部導航緊湊 */
      .sticky.top-0 {
        padding: 12px 16px !important;
      }
      
      .sticky.top-0 h1 {
        font-size: 20px !important;
      }
      
      .sticky.top-0 .p-3,
      .sticky.top-0 .p-4 {
        padding: 10px !important;
      }
      
      /* 新增按鈕緊湊 */
      .add-item-button-desktop {
        padding-top: 14px !important;
        padding-bottom: 14px !important;
        font-size: 15px !important;
      }
      
      .add-item-button-desktop svg {
        width: 24px !important;
        height: 24px !important;
      }
      
      /* 產品項目間距 */
      .product-item-gap {
        gap: 10px !important;
        margin-bottom: 10px !important;
      }
      
      /* Grid間距 */
      .grid.grid-cols-12 {
        gap: 14px !important;
      }
      
      /* 刪除按鈕 */
      .delete-button-desktop {
        padding: 10px !important;
      }
      
      .delete-button-desktop svg {
        width: 18px !important;
        height: 18px !important;
      }
      
      /* 圓角適中 */
      .rounded-3xl {
        border-radius: 20px !important;
      }
      
      /* 客戶資訊標題區 */
      .customer-info-card .flex.justify-between {
        margin-bottom: 14px !important;
        padding-bottom: 14px !important;
      }
      
      .customer-info-card .text-sm.font-black {
        font-size: 11px !important;
      }
      
      /* checkbox 和 label */
      .customer-info-card input[type="checkbox"] {
        width: 18px !important;
        height: 18px !important;
      }
      
      .customer-info-card label.flex {
        padding: 10px 12px !important;
        font-size: 14px !important;
      }
      
      /* date input */
      .customer-info-card input[type="date"] {
        padding: 10px 12px !important;
        font-size: 14px !important;
      }
    }
    
    /* === 電腦版響應式優化 - 確保一屏6項 === */
    @media (min-width: 1024px) {
      /* 電腦版緊湊佈局 */
      input, select, textarea {
        font-size: 14px !important;
      }
      
      button {
        min-height: 38px;
        font-size: 14px;
      }
      
      /* 產品卡片超緊湊 - 目標每個120px */
      .product-item-card {
        padding: 8px 12px !important;
      }
      
      .product-item-gap {
        gap: 6px !important;
        margin-bottom: 6px !important;
      }
      
      .product-list-space {
        gap: 8px !important;
      }
      
      /* 客戶資訊卡片超緊湊 */
      .customer-info-card {
        padding: 10px 14px !important;
      }
      
      .customer-info-card .flex.justify-between {
        margin-bottom: 10px !important;
        padding-bottom: 10px !important;
      }
      
      .customer-info-card .grid {
        gap: 8px !important;
      }
      
      .customer-info-card input,
      .customer-info-card select {
        padding: 6px 8px !important;
        font-size: 14px !important;
      }
      
      .customer-info-card input[type="date"] {
        padding: 5px 8px !important;
        font-size: 13px !important;
      }
      
      /* 客戶名稱輸入 */
      .customer-info-card .text-2xl {
        font-size: 18px !important;
        padding-top: 8px !important;
        padding-bottom: 8px !important;
      }
      
      /* 序號超小 */
      .item-number {
        width: 28px !important;
        height: 28px !important;
        font-size: 13px !important;
        margin-top: 0 !important;
      }
      
      /* 產品名稱緊湊 */
      .product-name-desktop {
        font-size: 15px !important;
        line-height: 1.2 !important;
      }
      
      .product-spec-desktop {
        font-size: 12px !important;
        margin-top: 2px !important;
      }
      
      /* 數字輸入緊湊 */
      .number-input-desktop {
        font-size: 17px !important;
        padding-top: 3px !important;
        padding-bottom: 3px !important;
      }
      
      /* 小計字體 */
      .subtotal-desktop {
        font-size: 17px !important;
      }
      
      /* 標籤文字 */
      .label-desktop {
        font-size: 10px !important;
        margin-bottom: 2px !important;
      }
      
      /* 底部總額 */
      .total-desktop {
        font-size: 26px !important;
      }
      
      /* 按鈕組緊湊 */
      .button-group-desktop {
        gap: 8px !important;
      }
      
      .button-group-desktop button {
        padding-left: 14px !important;
        padding-right: 14px !important;
        padding-top: 7px !important;
        padding-bottom: 7px !important;
        font-size: 13px !important;
      }
      
      /* 圖片上傳區超緊湊 */
      .image-upload-section {
        padding-top: 6px !important;
        margin-top: 6px !important;
        border-top-width: 1px !important;
      }
      
      .image-upload-section label {
        padding: 5px 10px !important;
        font-size: 12px !important;
      }
      
      /* 底部固定列超緊湊 */
      .fixed.bottom-0 {
        padding: 8px 14px !important;
      }
      
      /* 主容器優化 - 最小padding */
      .max-w-4xl {
        padding-left: 8px !important;
        padding-right: 8px !important;
        padding-top: 8px !important;
        padding-bottom: 100px !important;
      }
      
      /* 頂部導航超緊湊 */
      .sticky.top-0 {
        padding-top: 6px !important;
        padding-bottom: 6px !important;
        padding-left: 10px !important;
        padding-right: 10px !important;
      }
      
      .sticky.top-0 h1 {
        font-size: 17px !important;
      }
      
      .sticky.top-0 .p-3,
      .sticky.top-0 .p-4 {
        padding: 7px !important;
      }
      
      .sticky.top-0 svg {
        width: 22px !important;
        height: 22px !important;
      }
      
      /* 新增按鈕超緊湊 */
      .add-item-button-desktop {
        padding-top: 8px !important;
        padding-bottom: 8px !important;
        font-size: 13px !important;
        border-width: 2px !important;
      }
      
      .add-item-button-desktop svg {
        width: 20px !important;
        height: 20px !important;
      }
      
      /* 刪除按鈕緊湊 */
      .delete-button-desktop {
        padding: 5px !important;
      }
      
      .delete-button-desktop svg {
        width: 15px !important;
        height: 15px !important;
      }
      
      /* 圖片預覽縮小 */
      .product-image-desktop {
        width: 36px !important;
        height: 36px !important;
      }
      
      /* 箱容文字 */
      .image-upload-section .text-base {
        font-size: 12px !important;
      }
      
      /* 單位選擇器 */
      select.text-xl {
        font-size: 15px !important;
      }
      
      /* 價格選擇按鈕 */
      .product-item-card button svg {
        width: 16px !important;
        height: 16px !important;
      }
      
      /* Grid 間距調整 */
      .grid.grid-cols-12 {
        gap: 10px !important;
      }
      
      /* 客戶資訊標題區 */
      .customer-info-card .text-sm.font-black {
        font-size: 10px !important;
      }
      
      /* 純報價 checkbox */
      .customer-info-card input[type="checkbox"] {
        width: 15px !important;
        height: 15px !important;
      }
      
      .customer-info-card label.flex {
        padding: 5px 8px !important;
        font-size: 12px !important;
        gap: 5px !important;
      }
      
      /* border 寬度調整 */
      .border-b-4 {
        border-bottom-width: 2px !important;
      }
      
      .border-t-4 {
        border-top-width: 2px !important;
      }
      
      /* 圓角調整 */
      .rounded-3xl {
        border-radius: 16px !important;
      }
      
      .rounded-2xl {
        border-radius: 12px !important;
      }
    }
    
    /* 保留原有樣式 */
    @media print { .no-print { display: none !important; } }
    
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    .loader { 
      border: 4px solid #f3f3f3; 
      border-top: 4px solid #1d4ed8; 
      border-radius: 50%; 
      width: 28px; 
      height: 28px; 
      animation: spin 1s linear infinite; 
    }
    
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    
    .A4-product-name { 
      font-weight: 700; 
      font-size: 16px; 
      word-break: break-all; 
      line-height: 1.6; 
      margin-bottom: 6px; 
    }
    
    .login-bg { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    /* 視覺優化 */
    .card-shadow {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    .card-shadow:hover {
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }
    
    .smooth-scroll {
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }
    
    .safe-area-bottom {
      padding-bottom: max(env(safe-area-inset-bottom), 16px);
    }
    
    .product-card {
      transition: all 0.2s ease;
    }
    
    .product-card:active {
      background: #eff6ff !important;
      transform: scale(0.98);
    }
    
    /* 數字輸入優化 - 手機版 */
    .number-input-large {
      font-size: 32px !important;
      font-weight: 900;
      line-height: 1.2;
    }
    
    /* 漸層背景 */
    .gradient-blue {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .gradient-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    }
  </style>
</head>
<body class="text-slate-900">

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const firebaseConfig = {
        apiKey: "AIzaSyD59OwEnbcLZShhTTJJMu1VjJxrvzIcG_g",
        authDomain: "seafoodq-11b9d.firebaseapp.com",
        databaseURL: "https://seafoodq-11b9d-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "seafoodq-11b9d",
        storageBucket: "seafoodq-11b9d.firebasestorage.app",
        messagingSenderId: "454420146806",
        appId: "1:454420146806:web:802e6bd5e8e90aab21cd57"
    };

    const PASSWORDS = { SALES: "1688", ADMIN: "8888" };

    let db, dbRef, dbSet, dbOnValue;

    const initFirebase = () => {
        if (window.firebaseModules && !db) {
            const { initializeApp, getDatabase, ref, set, onValue } = window.firebaseModules;
            try {
                const app = initializeApp(firebaseConfig);
                db = getDatabase(app);
                dbRef = ref;
                dbSet = set;
                dbOnValue = onValue;
                return true;
            } catch (e) { 
              console.error("Firebase初始化錯誤:", e); 
              return false; 
            }
        }
        return !!db;
    };

    // Icon組件
    const Icon = ({ path, size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{ __html: path }} />
    );
    
    const icons = {
      Plus: '<line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>',
      Trash2: '<polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line>',
      Send: '<line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>',
      Database: '<ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M3 12a9 3 0 0 0 18 0v-1a9 3 0 0 0-18 0z"></path><path d="M3 5v14a9 3 0 0 0 18 0V5"></path>',
      Search: '<circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>',
      X: '<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>',
      Image: '<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="M21 15l-3.37-3.37a.91.91 0 0 0-1.28 0L9 17"></path>',
      Cloud: '<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>',
      Lock: '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path>',
      Unlock: '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path>',
      Printer: '<polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect>',
      LogOut: '<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line>',
      ChevronLeft: '<polyline points="15 18 9 12 15 6"></polyline>',
      ArrowRight: '<line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline>',
      DollarSign: '<line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>',
      Download: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line>',
      Upload: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line>'
    };
    
    const LucideIcon = ({ name, ...props }) => <Icon path={icons[name]} {...props} />;

    // 圖片壓縮
    const compressImage = (file, maxWidth=800, quality=0.6) => {
        return new Promise((resolve, reject) => {
            if (!file.type.match('image.*')) { 
              reject(new Error("非圖片檔案")); 
              return; 
            }
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > maxWidth) {
                        h = (h * maxWidth) / w;
                        w = maxWidth;
                    }
                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = () => reject(new Error("圖片載入失敗"));
            };
            reader.onerror = () => reject(new Error("讀取檔案失敗"));
        });
    };

    const App = () => {
      // 基本狀態
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [userRole, setUserRole] = useState('');
      const [loginInput, setLoginInput] = useState('');
      
      const [viewMode, setViewMode] = useState('edit');
      const [showSpecLookup, setShowSpecLookup] = useState(false);
      const [showAdmin, setShowAdmin] = useState(false);
      const [showPricePicker, setShowPricePicker] = useState(false);
      const [pickingPriceId, setPickingPriceId] = useState(null);
      const [isSyncing, setIsSyncing] = useState(true);
      const [uploadingImageId, setUploadingImageId] = useState(null);

      // 資料庫狀態
      const [productDB, setProductDB] = useState({});
      const [inventoryDB, setInventoryDB] = useState({});
      const [priceTiers, setPriceTiers] = useState(['生意價', '整件價', 'VIP價', '業務底價']);
      const [dbMeta, setDbMeta] = useState({ quoteDate: '', stockDate: '' });

      // 報價單狀態
      const [customerPriceTier, setCustomerPriceTier] = useState('生意價');
      const [items, setItems] = useState([
        { 
          id: 1, 
          name: '', 
          specDetail: '', 
          qty: 1, 
          bigUnit: '件', 
          packingContent: 1, 
          smallUnit: 'KG', 
          price: 0, 
          imageBase64: '' 
        }
      ]);
      
      const [companyInfo, setCompanyInfo] = useState({ 
          name: '八方環球', 
          phone: '', 
          address: '', 
          bankInfo: '1. 價格以出貨當日為準。\n2. 規格與重量請於收貨時確認。', 
          note: '' 
      });
      
      const [customerInfo, setCustomerInfo] = useState({
        name: '', 
        taxId: '', 
        contact: '', 
        phone: '', 
        address: '',
        paymentMethod: '現金', 
        date: new Date().toISOString().split('T')[0],
        quoteNo: `Q${new Date().toISOString().slice(2,10).replace(/-/g,'')}-01`
      });
      
      const [editingItemId, setEditingItemId] = useState(null);
      const [isQuoteOnly, setIsQuoteOnly] = useState(false);
      const [previewFormat, setPreviewFormat] = useState('mobile');
      
      const previewRef = useRef(null);

      // 初始化
      useEffect(() => {
          const sessionRole = sessionStorage.getItem('seafood_role');
          if (sessionRole) {
              setUserRole(sessionRole);
              setIsAuthenticated(true);
              connectDB();
          }
          
          const loadCompanyInfo = () => {
            try {
              const saved = localStorage.getItem('v6_company');
              if (saved) setCompanyInfo(JSON.parse(saved));
            } catch(e) {
              console.error("載入公司資訊失敗:", e);
            }
          };
          loadCompanyInfo();
      }, []);

      // Firebase 連線
      const connectDB = () => {
          const tryConnect = () => {
              if (initFirebase()) {
                  try {
                      const dataRef = dbRef(db, 'seafoodData');
                      dbOnValue(dataRef, (snapshot) => {
                          const data = snapshot.val();
                          if (data) {
                              if (data.productDB) setProductDB(data.productDB);
                              if (data.inventoryDB) setInventoryDB(data.inventoryDB);
                              if (data.priceTiers) setPriceTiers(data.priceTiers);
                              if (data.dbMeta) setDbMeta(data.dbMeta);
                          }
                          setIsSyncing(false);
                      }, (error) => {
                          console.error("資料庫讀取錯誤:", error);
                          setIsSyncing(false);
                      });
                  } catch(e) {
                      console.error("連線錯誤:", e);
                      setTimeout(tryConnect, 1000);
                  }
              } else { 
                  setTimeout(tryConnect, 500); 
              }
          };
          tryConnect();
      };

      // 登入/登出
      const handleLogin = (e) => {
          e.preventDefault();
          if (loginInput === PASSWORDS.ADMIN) {
              setUserRole('admin');
              setIsAuthenticated(true);
              sessionStorage.setItem('seafood_role', 'admin');
              connectDB();
          } else if (loginInput === PASSWORDS.SALES) {
              setUserRole('sales');
              setIsAuthenticated(true);
              sessionStorage.setItem('seafood_role', 'sales');
              connectDB();
          } else {
              alert("❌ 密碼錯誤");
          }
      };

      const handleLogout = () => {
          if (confirm("確定要登出嗎？")) {
              setIsAuthenticated(false);
              setUserRole('');
              sessionStorage.removeItem('seafood_role');
              setLoginInput('');
          }
      };

      // 雲端上傳
      const uploadToCloud = (newProductDB, newInventoryDB, newTiers, newMeta) => {
          if (!db || !dbSet) { 
            alert("❌ 尚未連接雲端資料庫"); 
            return; 
          }
          
          const finalProductDB = newProductDB || productDB;
          const finalInventoryDB = newInventoryDB || inventoryDB;
          const finalTiers = newTiers || priceTiers;
          const finalMeta = { ...dbMeta, ...newMeta };
          
          dbSet(dbRef(db, 'seafoodData'), {
              productDB: finalProductDB,
              inventoryDB: finalInventoryDB,
              priceTiers: finalTiers,
              dbMeta: finalMeta
          })
          .then(() => alert("✅ 雲端同步成功！"))
          .catch(err => alert("❌ 上傳失敗: " + err.message));
      };

      // Excel 上傳處理
      const handleFileUpload = (e, type) => {
          if (userRole !== 'admin') {
            alert("❌ 僅管理員可上傳資料");
            return;
          }
          
          const file = e.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = (evt) => {
              try {
                  const wb = XLSX.read(evt.target.result, { type: 'binary' });
                  const ws = wb.Sheets[wb.SheetNames[0]];
                  const rawData = XLSX.utils.sheet_to_json(ws, { header: 1 });
                  
                  if (type === 'quote') processQuoteData(rawData);
                  else if (type === 'stock') processStockData(rawData);
              } catch(err) {
                  alert("❌ 讀取失敗: " + err.message);
              }
          };
          reader.readAsBinaryString(file);
          e.target.value = null;
      };

      // 尋找標題行
      const findHeaderRow = (rows, keywords) => {
          for (let i = 0; i < Math.min(rows.length, 10); i++) {
              const rowStr = JSON.stringify(rows[i]).toLowerCase();
              if (keywords.every(k => rowStr.includes(k.toLowerCase()))) {
                  return i;
              }
          }
          return -1;
      };

      // 報價單處理
      const processQuoteData = (rawData) => {
          const headerRowIdx = findHeaderRow(rawData, ['品號', '品名']);
          if (headerRowIdx === -1) {
              alert("❌ 格式錯誤：找不到「品號」或「品名」欄位");
              return;
          }

          const headers = rawData[headerRowIdx];
          const data = rawData.slice(headerRowIdx + 1).map(row => {
              let obj = {};
              headers.forEach((h, i) => {
                  if (h) obj[h] = row[i];
              });
              return obj;
          }).filter(row => row['品號'] || row['ID'] || row['品名']);

          const newDB = {};
          const foundTiers = new Set();
          let count = 0;

          const parseCleanFloat = (val) => {
              if (!val) return 0;
              if (typeof val === 'number') return val;
              const cleaned = String(val).replace(/[,]/g, '');
              const num = parseFloat(cleaned);
              return isNaN(num) ? 0 : num;
          };

          data.forEach((row) => {
              const pid = String(row['品號'] || row['ID'] || '').trim();
              const name = String(row['品名'] || '').trim();
              const spec = String(row['規格'] || row['包裝'] || '').trim();

              if (!pid || !name) return;

              const prices = {};
              Object.keys(row).forEach(key => {
                  if (key.includes('價') && !key.includes('售價') && !key.includes('牌價')) {
                      const price = parseCleanFloat(row[key]);
                      if (price > 0) {
                          prices[key] = price;
                          foundTiers.add(key);
                      }
                  }
              });

              let packNum = 1;
              const matches = [...spec.matchAll(/(\d+(\.\d+)?)\s*(盒|包|塊|片|KG|公斤)/gi)];
              if (matches.length > 0) {
                  packNum = parseFloat(matches[matches.length - 1][1]);
              }

              if (!newDB[name]) newDB[name] = [];
              
              const existing = newDB[name].find(s => s.id === pid);
              if (!existing) {
                  newDB[name].push({
                      id: pid,
                      name: name,
                      specDetail: spec,
                      pack: packNum || 1,
                      smallUnit: 'KG',
                      bigUnit: '件',
                      prices: Object.keys(prices).length > 0 ? prices : { '生意價': 0 },
                      note: ''
                  });
                  count++;
              }
          });

          if (count > 0) {
              const tiersArray = Array.from(foundTiers);
              const msg = `報價單匯入完成！\n解析了 ${count} 筆產品資料。\n價格等級: ${tiersArray.join(', ')}`;
              
              if (confirm(msg + "\n\n要上傳到雲端嗎？")) {
                  uploadToCloud(
                      newDB,
                      null,
                      tiersArray.length > 0 ? tiersArray : priceTiers,
                      { quoteDate: new Date().toLocaleString() }
                  );
              }
          } else {
              alert("❌ 匯入失敗: 無有效報價資料");
          }
      };

      // 庫存處理 (簡化版，保留核心邏輯)
      const processStockData = (rawData) => {
          const headerRowIdx = findHeaderRow(rawData, ['品號']);
          if (headerRowIdx === -1) {
              alert("❌ 格式錯誤：找不到「品號」欄位");
              return;
          }

          const headers = rawData[headerRowIdx];
          const hasWhCol = headers.some(h => 
              String(h).includes('庫別') || 
              String(h).includes('倉庫') ||
              String(h).includes('庫位')
          );

          const data = rawData.slice(headerRowIdx + 1).map(row => {
              let obj = {};
              headers.forEach((h, i) => {
                  if (h) obj[h] = row[i];
              });
              return obj;
          }).filter(row => row['品號'] || row['ID']);

          const newInv = {};
          let count = 0;

          const parseCleanFloat = (val) => {
              if (!val) return 0;
              if (typeof val === 'number') return val;
              const cleaned = String(val).replace(/[,]/g, '');
              const num = parseFloat(cleaned);
              return isNaN(num) ? 0 : num;
          };

          const processItem = (pid, name, spec, warehouse, qty) => {
              if (!pid || !warehouse || qty <= 0) return;
              
              pid = String(pid).trim();
              warehouse = String(warehouse).trim();
              
              if (pid.includes('小計') || pid.includes('合計') || 
                  warehouse.includes('小計') || warehouse.includes('合計')) {
                  return;
              }

              if (!newInv[pid]) newInv[pid] = [];
              
              const existing = newInv[pid].find(s => s.warehouse === warehouse);
              if (existing) {
                  existing.stock += qty;
              } else {
                  newInv[pid].push({ warehouse, stock: qty });
              }
              count++;
          };

          if (hasWhCol) {
              data.forEach(row => {
                  const pidKey = Object.keys(row).find(k => k.includes('品號') || k === 'ID');
                  const nameKey = Object.keys(row).find(k => k.includes('品名'));
                  const specKey = Object.keys(row).find(k => k.includes('規格'));
                  const whKey = Object.keys(row).find(k => k.includes('庫別') || k.includes('倉庫'));
                  const qtyKey = Object.keys(row).find(k => k.includes('庫存') || k.includes('數量') || k.includes('包裝數量'));

                  processItem(
                      row[pidKey],
                      row[nameKey],
                      row[specKey],
                      row[whKey],
                      parseCleanFloat(row[qtyKey])
                  );
              });
          } else {
              data.forEach(row => {
                  const pidKey = Object.keys(row).find(k => k.includes('品號') || k === 'ID');
                  const nameKey = Object.keys(row).find(k => k.includes('品名'));
                  const specKey = Object.keys(row).find(k => k.includes('規格'));
                  const pid = row[pidKey];
                  const name = row[nameKey];
                  const spec = row[specKey];

                  if (!pid) return;
                  
                  Object.keys(row).forEach(k => {
                      const val = row[k];
                      if (!['品號', '品名', '規格', 'ID'].some(ex => k.includes(ex))) {
                          const numVal = parseCleanFloat(val);
                          if (numVal > 0) {
                              processItem(pid, name, spec, k, numVal);
                          }
                      }
                  });
              });
          }

          if (count > 0) {
              const msg = `庫存匯入完成！\n更新了 ${count} 筆庫存紀錄。`;
              
              if (confirm(msg + "\n\n要上傳到雲端嗎？")) {
                  uploadToCloud(
                      null,
                      newInv,
                      null,
                      { stockDate: new Date().toLocaleString() }
                  );
              }
          } else {
              alert("❌ 匯入失敗: 無有效庫存資料");
          }
      };

      // 項目操作
      const updateItem = (id, field, value) => {
          setItems(prev => prev.map(i => i.id === id ? { ...i, [field]: value } : i));
      };

      const addItem = () => {
          setItems([...items, {
              id: Date.now(),
              name: '',
              specDetail: '',
              qty: 1,
              bigUnit: '件',
              packingContent: 1,
              smallUnit: 'KG',
              price: 0,
              imageBase64: ''
          }]);
      };

      const removeItem = (id) => {
          if (items.length === 1) {
              alert("⚠️ 至少要保留一個項目");
              return;
          }
          if (confirm("確定要刪除這個項目嗎？")) {
              setItems(prev => prev.filter(i => i.id !== id));
          }
      };

      const handleNumeric = (e) => {
          const val = parseFloat(e.target.value);
          return isNaN(val) || val < 0 ? 0 : val;
      };

      const calcTotal = () => {
          return items.reduce((sum, i) => sum + (i.qty * i.packingContent * i.price), 0);
      };

      const fmtMoney = (n) => {
          return new Intl.NumberFormat('zh-TW', {
              style: 'currency',
              currency: 'TWD',
              minimumFractionDigits: 0
          }).format(n);
      };

      // 產品選擇
      const openSpecLookup = (id) => {
          setEditingItemId(id);
          setShowSpecLookup(true);
      };

      const applySpec = (spec) => {
          updateItem(editingItemId, 'originalSpec', spec);
          updateItem(editingItemId, 'name', spec.name);
          updateItem(editingItemId, 'specDetail', spec.specDetail);
          updateItem(editingItemId, 'packingContent', spec.pack);
          updateItem(editingItemId, 'smallUnit', spec.smallUnit);
          updateItem(editingItemId, 'bigUnit', spec.bigUnit);
          updateItem(editingItemId, 'price', spec.prices[customerPriceTier] || 0);
          setShowSpecLookup(false);
      };

      // 圖片上傳
      const handleImageUpload = async (e, id) => {
          const file = e.target.files[0];
          if (file) {
              setUploadingImageId(id);
              try {
                  const b64 = await compressImage(file, 800, 0.6);
                  updateItem(id, 'imageBase64', b64);
              } catch (err) {
                  alert("❌ 圖片上傳失敗：" + err.message);
              } finally {
                  setUploadingImageId(null);
                  e.target.value = null;
              }
          }
      };

      // 價格選擇器
      const openPricePicker = (itemId) => {
          const item = items.find(i => i.id === itemId);
          if (!item || !item.name) {
              alert("⚠️ 請先選擇產品");
              return;
          }
          setPickingPriceId(itemId);
          setShowPricePicker(true);
      };

      const selectPrice = (price) => {
          updateItem(pickingPriceId, 'price', price);
          setShowPricePicker(false);
          setPickingPriceId(null);
      };

      // 轉圖片
      const handleDownloadImage = async () => {
          if (!previewRef.current) return;
          try {
              const canvas = await html2canvas(previewRef.current, {
                  useCORS: true,
                  scale: 2,
                  backgroundColor: '#ffffff'
              });
              const link = document.createElement('a');
              link.download = `報價單_${customerInfo.name}_${customerInfo.date}.jpg`;
              link.href = canvas.toDataURL('image/jpeg', 0.9);
              link.click();
          } catch (err) {
              alert("❌ 轉存失敗: " + err.message);
          }
      };

      // ===== 價格選擇器組件 =====
      const PricePickerModal = () => {
          const item = items.find(i => i.id === pickingPriceId);
          if (!item) return null;

          let pricesObj = {};
          if (item.originalSpec && item.originalSpec.prices) {
              pricesObj = item.originalSpec.prices;
          } else {
              const group = productDB[item.name];
              if (group) {
                  const found = group.find(s => s.specDetail === item.specDetail);
                  if (found && found.prices) pricesObj = found.prices;
              }
          }

          const priceEntries = Object.entries(pricesObj);

          return (
              <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-5" onClick={() => setShowPricePicker(false)}>
                  <div className="bg-white rounded-3xl p-8 w-full max-w-lg shadow-2xl" onClick={e => e.stopPropagation()}>
                      <h3 className="text-2xl font-black mb-3">選擇價格等級</h3>
                      <div className="text-lg text-gray-600 mb-6">{item.name} {item.specDetail}</div>
                      <div className="space-y-3 mb-8">
                          {priceEntries.length > 0 ? (
                              priceEntries.map(([tier, price]) => (
                                  <button
                                      key={tier}
                                      onClick={() => selectPrice(price)}
                                      className="w-full p-5 rounded-2xl border-3 border-gray-200 hover:border-blue-500 hover:bg-blue-50 flex justify-between items-center text-left transition card-shadow"
                                  >
                                      <span className="font-bold text-xl text-gray-700">{tier}</span>
                                      <span className="text-3xl font-black text-blue-600">${price.toLocaleString()}</span>
                                  </button>
                              ))
                          ) : (
                              <div className="text-center text-gray-400 py-8 text-lg">
                                  此產品尚無價格資料
                              </div>
                          )}
                      </div>
                      <button
                          onClick={() => setShowPricePicker(false)}
                          className="w-full py-4 bg-gray-100 rounded-2xl font-bold text-lg text-gray-700 hover:bg-gray-200"
                      >
                          關閉
                      </button>
                  </div>
              </div>
          );
      };

      // ===== 管理面板組件 =====
      const AdminPanel = () => (
          <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-5 no-scrollbar overflow-auto" onClick={() => setShowAdmin(false)}>
              <div className="bg-white rounded-3xl w-full max-w-2xl my-auto card-shadow" onClick={e => e.stopPropagation()}>
                  <div className="sticky top-0 bg-white border-b p-6 rounded-t-3xl flex justify-between items-center">
                      <h2 className="text-2xl font-black">資料管理</h2>
                      <button onClick={() => setShowAdmin(false)} className="p-3 hover:bg-gray-100 rounded-full">
                          <LucideIcon name="X" size={28} />
                      </button>
                  </div>

                  <div className="p-8 space-y-8 max-h-[80vh] overflow-auto">
                      {/* 資料庫狀態 */}
                      <div className="gradient-blue text-white p-6 rounded-3xl card-shadow">
                          <div className="flex items-center gap-4 mb-5">
                              <LucideIcon name="Database" size={40} />
                              <div>
                                  <h3 className="font-black text-xl">資料庫狀態</h3>
                                  <p className="text-sm opacity-90 mt-1">Firebase 即時同步</p>
                              </div>
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                              <div className="bg-white/20 backdrop-blur-sm p-4 rounded-2xl">
                                  <div className="text-3xl font-black">{Object.keys(productDB).length}</div>
                                  <div className="text-sm opacity-90 mt-1">產品分類</div>
                              </div>
                              <div className="bg-white/20 backdrop-blur-sm p-4 rounded-2xl">
                                  <div className="text-3xl font-black">{Object.keys(inventoryDB).length}</div>
                                  <div className="text-sm opacity-90 mt-1">庫存品項</div>
                              </div>
                          </div>
                          {dbMeta.quoteDate && (
                              <div className="mt-4 text-sm opacity-80">
                                  報價單更新: {dbMeta.quoteDate}
                              </div>
                          )}
                          {dbMeta.stockDate && (
                              <div className="text-sm opacity-80">
                                  庫存更新: {dbMeta.stockDate}
                              </div>
                          )}
                      </div>

                      {/* 上傳按鈕 */}
                      {userRole === 'admin' && (
                          <div className="space-y-4">
                              <label className="block">
                                  <div className="w-full bg-blue-50 border-4 border-dashed border-blue-300 text-blue-700 font-bold p-8 rounded-3xl text-center hover:bg-blue-100 cursor-pointer transition card-shadow">
                                      <LucideIcon name="Upload" size={40} className="mx-auto mb-3" />
                                      <div className="text-xl mb-2">上傳報價單</div>
                                      <div className="text-base opacity-75">支援 Excel / CSV</div>
                                  </div>
                                  <input
                                      type="file"
                                      className="hidden"
                                      accept=".xlsx,.xls,.csv"
                                      onChange={e => handleFileUpload(e, 'quote')}
                                  />
                              </label>

                              <label className="block">
                                  <div className="w-full bg-green-50 border-4 border-dashed border-green-300 text-green-700 font-bold p-8 rounded-3xl text-center hover:bg-green-100 cursor-pointer transition card-shadow">
                                      <LucideIcon name="Database" size={40} className="mx-auto mb-3" />
                                      <div className="text-xl mb-2">上傳庫存表</div>
                                      <div className="text-base opacity-75">支援 Excel / CSV</div>
                                  </div>
                                  <input
                                      type="file"
                                      className="hidden"
                                      accept=".xlsx,.xls,.csv"
                                      onChange={e => handleFileUpload(e, 'stock')}
                                  />
                              </label>
                          </div>
                      )}

                      {/* 價格等級 */}
                      <div className="bg-gray-50 p-6 rounded-3xl">
                          <h4 className="font-bold text-lg mb-3">價格等級</h4>
                          <div className="flex flex-wrap gap-3">
                              {priceTiers.map(tier => (
                                  <span key={tier} className="px-5 py-2 bg-blue-100 text-blue-700 rounded-full text-base font-bold">
                                      {tier}
                                  </span>
                              ))}
                          </div>
                      </div>

                      {/* 公司資訊設定 */}
                      <div className="border-t pt-8">
                          <h4 className="font-bold text-lg mb-4">公司資訊</h4>
                          <div className="space-y-4">
                              <input
                                  type="text"
                                  placeholder="公司名稱"
                                  className="w-full p-4 border-2 border-gray-200 rounded-2xl text-lg"
                                  value={companyInfo.name}
                                  onChange={e => setCompanyInfo({ ...companyInfo, name: e.target.value })}
                              />
                              <input
                                  type="text"
                                  placeholder="電話"
                                  className="w-full p-4 border-2 border-gray-200 rounded-2xl text-lg"
                                  value={companyInfo.phone}
                                  onChange={e => setCompanyInfo({ ...companyInfo, phone: e.target.value })}
                              />
                              <textarea
                                  placeholder="匯款資訊 / 備註"
                                  className="w-full p-4 border-2 border-gray-200 rounded-2xl h-32 text-lg"
                                  value={companyInfo.bankInfo}
                                  onChange={e => setCompanyInfo({ ...companyInfo, bankInfo: e.target.value })}
                              />
                              <button
                                  onClick={() => {
                                      localStorage.setItem('v6_company', JSON.stringify(companyInfo));
                                      alert("✅ 公司資訊已儲存");
                                  }}
                                  className="w-full bg-blue-600 text-white p-5 rounded-2xl font-bold text-lg hover:bg-blue-700"
                              >
                                  儲存公司資訊
                              </button>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      );

      // ===== 產品選擇組件 =====
      const SpecModal = () => {
          const [searchTerm, setSearchTerm] = useState('');

          const allSpecs = Object.entries(productDB).flatMap(([name, specs]) =>
              specs.map(spec => ({ ...spec, groupName: name }))
          );

          const filtered = allSpecs.filter(spec => {
              const term = searchTerm.toLowerCase();
              return (
                  spec.name.toLowerCase().includes(term) ||
                  spec.specDetail.toLowerCase().includes(term) ||
                  spec.id.toLowerCase().includes(term)
              );
          });

          return (
              <div className="fixed inset-0 bg-black/60 z-50 flex flex-col">
                  {/* 搜尋列 */}
                  <div className="bg-white border-b p-5 safe-area-top">
                      <div className="flex gap-3 mb-3">
                          <div className="flex-1 relative">
                              <LucideIcon name="Search" size={24} className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" />
                              <input
                                  type="text"
                                  placeholder="搜尋產品名稱、規格或品號..."
                                  className="w-full pl-12 pr-5 py-4 border-2 border-gray-200 rounded-2xl focus:border-blue-500 outline-none text-lg"
                                  value={searchTerm}
                                  onChange={e => setSearchTerm(e.target.value)}
                                  autoFocus
                              />
                          </div>
                          <button
                              onClick={() => {
                                  setShowSpecLookup(false);
                                  setSearchTerm('');
                              }}
                              className="px-8 bg-gray-100 rounded-2xl font-bold hover:bg-gray-200 text-lg"
                          >
                              關閉
                          </button>
                      </div>
                      <div className="text-base text-gray-600">
                          找到 <span className="font-bold text-blue-600">{filtered.length}</span> 個產品
                      </div>
                  </div>

                  {/* 產品列表 */}
                  <div className="flex-1 overflow-auto bg-gray-50 smooth-scroll">
                      {filtered.length === 0 && (
                          <div className="text-center py-16 text-gray-400">
                              <LucideIcon name="Search" size={80} className="mx-auto mb-4 opacity-50" />
                              <p className="text-xl font-bold">查無資料</p>
                              <p className="text-base mt-2">試試其他關鍵字</p>
                          </div>
                      )}

                      <div className="p-5 space-y-4">
                          {Object.entries(
                              filtered.reduce((groups, spec) => {
                                  if (!groups[spec.groupName]) groups[spec.groupName] = [];
                                  groups[spec.groupName].push(spec);
                                  return groups;
                              }, {})
                          ).map(([groupName, specs]) => (
                              <div key={groupName} className="bg-white rounded-3xl overflow-hidden card-shadow">
                                  <div className="bg-gradient-to-r from-gray-700 to-gray-600 text-white px-6 py-4 font-black text-lg">
                                      {groupName}
                                  </div>
                                  {specs.map((spec) => {
                                      const stocks = inventoryDB[spec.id] || [];
                                      const totalStock = stocks.reduce((sum, s) => sum + s.stock, 0);

                                      return (
                                          <div
                                              key={spec.id}
                                              onClick={() => applySpec(spec)}
                                              className="product-card p-6 border-b last:border-b-0 cursor-pointer hover:bg-blue-50"
                                          >
                                              <div className="flex justify-between items-start mb-3">
                                                  <div className="flex-1 pr-4">
                                                      <div className="font-black text-blue-800 text-xl mb-2">
                                                          {spec.specDetail}
                                                      </div>
                                                      <div className="text-base text-gray-600">
                                                          品號: {spec.id} | 箱容: {spec.pack}{spec.smallUnit}
                                                      </div>
                                                      {spec.note && (
                                                          <div className="text-sm text-orange-500 mt-2">{spec.note}</div>
                                                      )}
                                                  </div>
                                                  <div className="text-right">
                                                      <div className="text-3xl font-black text-gray-800">
                                                          ${(spec.prices[customerPriceTier] || 0).toLocaleString()}
                                                      </div>
                                                      <div className={`text-sm px-3 py-1.5 rounded-full mt-2 font-bold ${
                                                          totalStock > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-600'
                                                      }`}>
                                                          庫存: {totalStock}
                                                      </div>
                                                  </div>
                                              </div>

                                              {/* 多倉位庫存 - 優化排版 */}
                                              {stocks.length > 0 && (
                                                  <div className="mt-4 pt-3 border-t border-gray-100">
                                                      <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2">
                                                          {stocks.map((s, k) => (
                                                              <div
                                                                  key={k}
                                                                  className="bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200 px-3 py-2 rounded-xl text-sm"
                                                              >
                                                                  <div className="text-gray-600 text-xs font-medium mb-0.5">
                                                                      {s.warehouse}
                                                                  </div>
                                                                  <div className="text-gray-900 font-black text-base">
                                                                      {s.stock}
                                                                  </div>
                                                              </div>
                                                          ))}
                                                      </div>
                                                  </div>
                                              )}
                                          </div>
                                      );
                                  })}
                              </div>
                          ))}
                      </div>
                  </div>
              </div>
          );
      };

      // ===== 登入頁 =====
      if (!isAuthenticated) {
          return (
              <div className="min-h-screen login-bg flex items-center justify-center p-6">
                  <div className="bg-white/95 backdrop-blur-xl rounded-[40px] p-10 shadow-2xl w-full max-w-md text-center">
                      <div className="mb-10 flex justify-center">
                          <div className="gradient-blue p-6 rounded-full text-white shadow-2xl">
                              <LucideIcon name="Cloud" size={56} />
                          </div>
                      </div>
                      <h1 className="text-4xl font-black text-slate-800 mb-3">八方環球報價</h1>
                      <p className="text-lg text-gray-500 mb-10">V9.0 大字體版</p>
                      
                      <form onSubmit={handleLogin} className="space-y-5">
                          <input
                              type="password"
                              className="w-full text-center text-4xl font-black p-5 border-b-4 border-blue-600 bg-slate-100 rounded-2xl focus:bg-white transition outline-none"
                              placeholder="密碼"
                              maxLength={4}
                              value={loginInput}
                              onChange={e => setLoginInput(e.target.value)}
                              autoFocus
                              style={{fontSize: '32px'}}
                          />
                          <button
                              type="submit"
                              className="w-full py-5 gradient-blue text-white rounded-2xl font-black text-2xl shadow-2xl"
                          >
                              登 入
                          </button>
                      </form>
                      
                      <div className="mt-8 text-base text-gray-500">
                          <div>管理員: 8888 | 業務: 1688</div>
                      </div>
                  </div>
              </div>
          );
      }

      // ===== 預覽模式 (簡化版) =====
      if (viewMode === 'preview') {
          return (
              <div className="min-h-screen bg-white pb-12">
                  <div className="gradient-blue text-white p-5 sticky top-0 z-50 flex justify-between items-center no-print shadow-2xl">
                      <div className="flex items-center gap-4">
                          <button
                              onClick={() => setViewMode('edit')}
                              className="flex items-center gap-2 font-bold text-lg bg-white/20 px-6 py-3 rounded-2xl hover:bg-white/30"
                          >
                              <LucideIcon name="ChevronLeft" size={24} />
                              返回
                          </button>
                          
                          <div className="flex bg-white/20 rounded-2xl p-1.5 gap-2">
                              <button
                                  onClick={() => setPreviewFormat('mobile')}
                                  className={`px-6 py-3 rounded-xl text-base font-bold transition ${
                                      previewFormat === 'mobile' ? 'bg-white text-blue-900' : 'text-white/80 hover:text-white'
                                  }`}
                              >
                                  📱 手機
                              </button>
                              <button
                                  onClick={() => setPreviewFormat('a4')}
                                  className={`px-6 py-3 rounded-xl text-base font-bold transition ${
                                      previewFormat === 'a4' ? 'bg-white text-blue-900' : 'text-white/80 hover:text-white'
                                  }`}
                              >
                                  📄 A4
                              </button>
                          </div>
                      </div>

                      <div className="flex gap-3">
                          <button
                              onClick={handleDownloadImage}
                              className="bg-yellow-500 text-white px-6 py-3 rounded-2xl font-bold text-lg flex items-center gap-2 hover:bg-yellow-600"
                          >
                              <LucideIcon name="Image" size={20} />
                              轉圖片
                          </button>
                          <button
                              onClick={() => window.print()}
                              className="bg-white text-blue-900 px-6 py-3 rounded-2xl font-bold text-lg flex items-center gap-2 hover:bg-gray-100"
                          >
                              <LucideIcon name="Printer" size={20} />
                              列印
                          </button>
                      </div>
                  </div>

                  <div ref={previewRef} className="bg-white">
                      {previewFormat === 'mobile' ? (
                          <div className="max-w-md mx-auto shadow-2xl my-8 rounded-3xl overflow-hidden border-2 border-gray-200">
                              <div className="gradient-blue text-white p-8">
                                  <h2 className="text-3xl font-black mb-2">{customerInfo.name || '客戶名稱'}</h2>
                                  <p className="text-lg opacity-90">{customerInfo.quoteNo}</p>
                                  {!isQuoteOnly && (
                                      <div className="mt-6 text-5xl font-black text-right">
                                          {fmtMoney(calcTotal())}
                                      </div>
                                  )}
                              </div>

                              <div className="divide-y divide-gray-100">
                                  {items.filter(item => item.name).map((item, i) => (
                                      <div key={i} className="p-6">
                                          <div className="flex justify-between font-black text-xl mb-3">
                                              <span className="flex-1">{item.name} {item.specDetail}</span>
                                              {!isQuoteOnly && (
                                                  <span className="ml-5 text-blue-600">
                                                      {fmtMoney(item.qty * item.packingContent * item.price)}
                                                  </span>
                                              )}
                                          </div>

                                          <div className="text-lg text-gray-600 flex justify-between items-center">
                                              <div className="flex items-center gap-4">
                                                  {item.imageBase64 && (
                                                      <img
                                                          src={item.imageBase64}
                                                          className="w-16 h-16 object-cover rounded-xl border-2 border-gray-200"
                                                          alt=""
                                                      />
                                                  )}
                                                  <span className="font-bold text-xl">
                                                      ${item.price}/{item.smallUnit}
                                                  </span>
                                              </div>
                                              {!isQuoteOnly && (
                                                  <span className="bg-blue-50 text-blue-700 px-5 py-2 rounded-xl font-black text-lg">
                                                      {item.qty} {item.bigUnit}
                                                  </span>
                                              )}
                                          </div>
                                      </div>
                                  ))}
                              </div>

                              <div className="p-8 bg-gray-50 text-base text-gray-600">
                                  <div className="font-bold text-black mb-3 text-lg">備註:</div>
                                  <pre className="whitespace-pre-wrap font-sans leading-relaxed">
                                      {companyInfo.bankInfo}
                                  </pre>
                              </div>
                          </div>
                      ) : (
                          <div className="max-w-[210mm] mx-auto p-12 shadow-2xl my-8 bg-white print:shadow-none print:my-0 print:p-0">
                              <div className="flex justify-between items-end border-b-4 border-black pb-6 mb-8">
                                  <div>
                                      <h1 className="text-5xl font-black mb-3">
                                          {isQuoteOnly ? '報 價 單' : '銷 貨 單'}
                                      </h1>
                                      <p className="text-lg text-gray-600">
                                          {companyInfo.name} {companyInfo.phone && `| ${companyInfo.phone}`}
                                      </p>
                                  </div>
                                  <div className="text-right text-lg">
                                      <p className="mb-2">
                                          單號: <b className="text-xl">{customerInfo.quoteNo}</b>
                                      </p>
                                      <p>
                                          日期: <b className="text-xl">{customerInfo.date}</b>
                                      </p>
                                  </div>
                              </div>

                              <div className="mb-8 p-5 border-2 rounded-2xl bg-gray-50">
                                  <div className="grid grid-cols-2 gap-3 text-base">
                                      <p>
                                          客戶: <b className="text-lg">{customerInfo.name}</b>
                                      </p>
                                      <p>
                                          聯絡人: <b className="text-lg">{customerInfo.contact}</b>
                                      </p>
                                      <p className="col-span-2">
                                          地址: {customerInfo.address}
                                      </p>
                                  </div>
                              </div>

                              <table className="w-full text-base border-collapse border-2 border-black mb-8">
                                  <thead>
                                      <tr className="bg-gray-800 text-white">
                                          <th className="border border-black p-4 w-16">No.</th>
                                          <th className="border border-black p-4 text-left">品名規格</th>
                                          {!isQuoteOnly && <th className="border border-black p-4">數量</th>}
                                          <th className="border border-black p-4 text-right">單價</th>
                                          {!isQuoteOnly && <th className="border border-black p-4 text-right">金額</th>}
                                      </tr>
                                  </thead>
                                  <tbody>
                                      {items.filter(item => item.name).map((item, i) => (
                                          <tr key={i} className="hover:bg-gray-50">
                                              <td className="border border-black p-4 text-center font-bold text-lg">
                                                  {i + 1}
                                              </td>
                                              <td className="border border-black p-4">
                                                  <div className="flex items-center gap-4">
                                                      {item.imageBase64 && (
                                                          <img
                                                              src={item.imageBase64}
                                                              className="w-20 h-20 object-cover rounded border-2 border-gray-200"
                                                              alt=""
                                                          />
                                                      )}
                                                      <div className="A4-product-name text-lg">
                                                          {item.name} {item.specDetail}
                                                      </div>
                                                  </div>
                                              </td>
                                              {!isQuoteOnly && (
                                                  <td className="border border-black p-4 text-center font-black text-lg">
                                                      {item.qty} {item.bigUnit}
                                                  </td>
                                              )}
                                              <td className="border border-black p-4 text-right font-bold text-lg">
                                                  ${item.price.toLocaleString()}
                                              </td>
                                              {!isQuoteOnly && (
                                                  <td className="border border-black p-4 text-right font-black text-blue-600 text-lg">
                                                      {fmtMoney(item.qty * item.packingContent * item.price)}
                                                  </td>
                                              )}
                                          </tr>
                                      ))}
                                  </tbody>
                              </table>

                              {!isQuoteOnly && (
                                  <div className="text-right text-4xl font-black mb-10 text-blue-600">
                                      總計: {fmtMoney(calcTotal())}
                                  </div>
                              )}

                              <div className="border-2 p-6 text-base bg-gray-50 rounded-2xl">
                                  <p className="font-black mb-3 text-gray-800 text-lg">匯款資訊 / 備註:</p>
                                  <pre className="whitespace-pre-wrap font-sans text-gray-600 leading-relaxed">
                                      {companyInfo.bankInfo}
                                  </pre>
                              </div>
                          </div>
                      )}
                  </div>
              </div>
          );
      }

      // ===== 編輯模式（主畫面） - 大字體優化版 =====
      return (
          <div className="min-h-screen pb-40 font-sans">
              {showAdmin && <AdminPanel />}
              {showSpecLookup && <SpecModal />}
              {showPricePicker && <PricePickerModal />}

              {/* 頂部導航列 - 放大 */}
              <div className="bg-white border-b-2 px-5 py-4 sticky top-0 z-30 flex justify-between items-center shadow-lg">
                  <div className="flex items-center gap-4">
                      <div className={`text-white p-3 rounded-2xl shadow-lg ${
                          isSyncing ? 'bg-gray-400' : 'gradient-blue'
                      }`}>
                          <LucideIcon name="Cloud" size={28} />
                      </div>
                      <div>
                          <h1 className="text-2xl font-black text-slate-800">八方環球 V9.0</h1>
                          {isSyncing ? (
                              <span className="text-base text-blue-500">連線中...</span>
                          ) : (
                              <span className="text-sm text-green-600 font-bold">● 已連線</span>
                          )}
                      </div>
                  </div>

                  <div className="flex gap-3">
                      <button
                          onClick={() => setShowAdmin(true)}
                          className="p-4 bg-gray-100 rounded-2xl hover:bg-gray-200 relative shadow-md"
                      >
                          <LucideIcon name="Database" size={26} />
                          {userRole === 'admin' && (
                              <span className="absolute top-0 right-0 w-3 h-3 bg-green-500 rounded-full"></span>
                          )}
                      </button>
                      <button
                          onClick={handleLogout}
                          className="p-4 bg-red-50 text-red-500 rounded-2xl hover:bg-red-100 shadow-md"
                      >
                          <LucideIcon name="LogOut" size={26} />
                      </button>
                  </div>
              </div>

              {/* 主要內容區 - 字體放大 */}
              <div className="max-w-4xl mx-auto p-5 space-y-5">
                  {/* 客戶資訊卡片 - 響應式優化 */}
                  <div className="gradient-card p-7 customer-info-card rounded-3xl card-shadow border border-gray-100">
                      <div className="flex justify-between mb-5 border-b-2 pb-4">
                          <span className="text-sm font-black text-blue-600 tracking-wider">
                              訂單資訊
                          </span>
                          <div className="flex items-center gap-4">
                              <input
                                  type="date"
                                  value={customerInfo.date}
                                  onChange={e => setCustomerInfo({ ...customerInfo, date: e.target.value })}
                                  className="bg-gray-100 px-4 py-3 rounded-2xl outline-none focus:bg-white transition text-base"
                              />
                              <label className="flex items-center gap-3 text-base font-bold bg-gray-50 px-4 py-3 rounded-2xl cursor-pointer hover:bg-gray-100 transition">
                                  <input
                                      type="checkbox"
                                      checked={isQuoteOnly}
                                      onChange={e => setIsQuoteOnly(e.target.checked)}
                                      className="w-5 h-5"
                                  />
                                  純報價
                              </label>
                          </div>
                      </div>

                      <div className="grid grid-cols-3 gap-5">
                          <div className="col-span-2">
                              <input
                                  type="text"
                                  placeholder="客戶名稱"
                                  className="w-full text-2xl font-black border-b-4 py-3 outline-none focus:border-blue-600 transition bg-transparent"
                                  value={customerInfo.name}
                                  onChange={e => setCustomerInfo({ ...customerInfo, name: e.target.value })}
                                  style={{fontSize: '24px'}}
                              />
                          </div>
                          <div className="col-span-1">
                              <select
                                  value={customerPriceTier}
                                  onChange={e => setCustomerPriceTier(e.target.value)}
                                  className="w-full h-full font-bold text-blue-700 bg-blue-50 rounded-2xl text-center outline-none cursor-pointer hover:bg-blue-100 transition text-xl"
                                  style={{fontSize: '18px'}}
                              >
                                  {priceTiers.map(t => (
                                      <option key={t} value={t}>{t}</option>
                                  ))}
                              </select>
                          </div>

                          <input
                              type="text"
                              placeholder="統編"
                              className="p-4 bg-gray-50 rounded-2xl text-lg outline-none focus:bg-white transition"
                              value={customerInfo.taxId}
                              onChange={e => setCustomerInfo({ ...customerInfo, taxId: e.target.value })}
                          />
                          <input
                              type="text"
                              placeholder="聯絡人"
                              className="p-4 bg-gray-50 rounded-2xl text-lg outline-none focus:bg-white transition"
                              value={customerInfo.contact}
                              onChange={e => setCustomerInfo({ ...customerInfo, contact: e.target.value })}
                          />
                          <select
                              value={customerInfo.paymentMethod}
                              onChange={e => setCustomerInfo({ ...customerInfo, paymentMethod: e.target.value })}
                              className="p-4 bg-gray-50 rounded-2xl font-bold text-lg cursor-pointer outline-none hover:bg-gray-100 transition"
                          >
                              {['現金', '月結30', '月結60', '匯款'].map(m => (
                                  <option key={m} value={m}>{m}</option>
                              ))}
                          </select>
                      </div>
                  </div>

                  {/* 產品項目列表 - 響應式優化 */}
                  <div className="space-y-4 product-list-space">
                      {items.map((item, index) => (
                          <div
                              key={item.id}
                              className="gradient-card p-7 product-item-card rounded-3xl card-shadow border border-gray-100 relative group hover:shadow-xl transition"
                          >
                              {/* 刪除按鈕 - 響應式 */}
                              <div className="absolute top-5 right-5 z-10">
                                  <button
                                      onClick={() => removeItem(item.id)}
                                      className="p-3 delete-button-desktop bg-red-50 rounded-2xl text-red-500 hover:bg-red-100 shadow-md"
                                  >
                                      <LucideIcon name="Trash2" size={22} />
                                  </button>
                              </div>

                              {/* 產品資訊 - 響應式 */}
                              <div className="flex gap-4 product-item-gap mb-5 pr-16" onClick={() => openSpecLookup(item.id)}>
                                  <div className="w-14 h-14 item-number rounded-full bg-gradient-to-br from-blue-100 to-blue-200 text-blue-700 flex items-center justify-center font-black text-2xl shrink-0 shadow-md">
                                      {index + 1}
                                  </div>
                                  <div className="cursor-pointer flex-1">
                                      <div className={`text-2xl product-name-desktop font-black leading-tight ${
                                          !item.name ? 'text-gray-300' : 'text-gray-800'
                                      }`}>
                                          {item.name || '點擊選擇產品...'}
                                      </div>
                                      {item.specDetail && (
                                          <div className="text-lg product-spec-desktop font-bold text-blue-600 mt-2">
                                              {item.specDetail}
                                          </div>
                                      )}
                                  </div>
                              </div>

                              {/* 數量/價格輸入 - 響應式 */}
                              <div className="grid grid-cols-12 gap-5 product-item-gap items-end mb-5">
                                  {/* 數量 */}
                                  <div className="col-span-4">
                                      <label className="text-sm label-desktop font-bold text-gray-500 uppercase tracking-wide block mb-2">
                                          數量
                                      </label>
                                      <div className="flex items-center border-b-4 border-gray-200 focus-within:border-blue-500 transition">
                                          <input
                                              type="number"
                                              className="w-full number-input-large number-input-desktop text-center outline-none py-3 bg-transparent"
                                              value={item.qty || ''}
                                              onChange={e => updateItem(item.id, 'qty', handleNumeric(e))}
                                              min="0"
                                              step="1"
                                          />
                                          <select
                                              value={item.bigUnit}
                                              onChange={e => updateItem(item.id, 'bigUnit', e.target.value)}
                                              className="text-xl font-bold bg-transparent outline-none cursor-pointer pr-2"
                                              style={{fontSize: '20px'}}
                                          >
                                              {['件', '箱', '籃', '保'].map(u => (
                                                  <option key={u} value={u}>{u}</option>
                                              ))}
                                          </select>
                                      </div>
                                  </div>

                                  {/* 單價 */}
                                  <div className="col-span-4">
                                      <label className="text-sm label-desktop font-bold text-gray-500 uppercase tracking-wide block mb-2">
                                          單價
                                      </label>
                                      <div className="flex items-center border-b-4 border-gray-200 focus-within:border-blue-500 transition">
                                          <input
                                              type="number"
                                              className="w-full number-input-large number-input-desktop text-center outline-none py-3 bg-transparent"
                                              value={item.price || ''}
                                              onChange={e => updateItem(item.id, 'price', handleNumeric(e))}
                                              min="0"
                                              step="1"
                                          />
                                          <button
                                              onClick={() => openPricePicker(item.id)}
                                              className="text-blue-500 hover:text-blue-700 p-2"
                                          >
                                              <LucideIcon name="DollarSign" size={24} />
                                          </button>
                                      </div>
                                  </div>

                                  {/* 小計 */}
                                  <div className="col-span-4 text-right">
                                      <div className="text-3xl subtotal-desktop font-black text-gray-900">
                                          {fmtMoney(item.qty * item.packingContent * item.price)}
                                      </div>
                                      <div className="text-sm label-desktop font-bold text-gray-500 uppercase tracking-wide mt-1">
                                          小計
                                      </div>
                                  </div>
                              </div>

                              {/* 圖片上傳 - 響應式 */}
                              <div className="pt-5 mt-3 image-upload-section border-t-2 border-dashed border-gray-200 flex justify-between items-center">
                                  <label className={`flex items-center gap-3 text-base font-bold px-5 py-3 rounded-2xl cursor-pointer transition ${
                                      uploadingImageId === item.id
                                          ? 'text-gray-400 bg-gray-100 cursor-not-allowed'
                                          : 'text-blue-600 bg-blue-50 hover:bg-blue-100 shadow-md'
                                  }`}>
                                      {uploadingImageId === item.id ? (
                                          <>
                                              <div className="loader"></div>
                                              處理中...
                                          </>
                                      ) : (
                                          <>
                                              <LucideIcon name="Image" size={20} />
                                              {item.imageBase64 ? '更換圖片' : '新增圖片'}
                                          </>
                                      )}
                                      <input
                                          type="file"
                                          className="hidden"
                                          accept="image/*"
                                          disabled={uploadingImageId === item.id}
                                          onChange={e => handleImageUpload(e, item.id)}
                                      />
                                  </label>

                                  <div className="flex items-center gap-4">
                                      {item.imageBase64 && (
                                          <img
                                              src={item.imageBase64}
                                              className="w-16 h-16 product-image-desktop rounded-2xl object-cover border-2 border-gray-200 shadow-md"
                                              alt=""
                                          />
                                      )}
                                      <div className="text-base text-gray-500 font-medium">
                                          箱容: <span className="font-bold text-gray-700">{item.packingContent}{item.smallUnit}</span>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      ))}

                      {/* 新增項目按鈕 - 響應式 */}
                      <button
                          onClick={addItem}
                          className="w-full py-6 add-item-button-desktop rounded-3xl border-4 border-dashed border-gray-300 text-gray-400 font-bold hover:border-blue-500 hover:text-blue-600 hover:bg-blue-50 transition flex items-center justify-center gap-3 shadow-md text-xl"
                      >
                          <LucideIcon name="Plus" size={28} />
                          新增產品項目
                      </button>
                  </div>
              </div>

              {/* 底部固定列 - 響應式優化 */}
              <div className="fixed bottom-0 left-0 right-0 bg-white border-t-4 border-gray-200 p-6 flex justify-between items-center z-40 safe-area-bottom shadow-2xl">
                  <div>
                      <div className="text-sm label-desktop font-bold text-gray-500 uppercase tracking-wide mb-1">
                          訂單總額
                      </div>
                      <div className="text-5xl total-desktop font-black bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                          {isQuoteOnly ? '---' : fmtMoney(calcTotal())}
                      </div>
                  </div>

                  <div className="flex gap-3 button-group-desktop">
                      {/* 預覽按鈕 */}
                      <button
                          onClick={() => setViewMode('preview')}
                          className="gradient-blue text-white px-8 py-4 rounded-2xl font-bold shadow-xl hover:shadow-2xl flex items-center gap-3 text-xl"
                      >
                          預覽
                          <LucideIcon name="ArrowRight" size={24} />
                      </button>

                      {/* LINE分享按鈕 */}
                      <button
                          onClick={() => {
                              let msg = `【${customerInfo.name}】${customerInfo.quoteNo}\n${'='.repeat(25)}\n`;
                              items.filter(i => i.name).forEach(i => {
                                  msg += `${i.name} ${i.specDetail}\n`;
                                  msg += `數量: ${i.qty}${i.bigUnit} × $${i.price}\n`;
                                  if (!isQuoteOnly) {
                                      msg += `小計: ${fmtMoney(i.qty * i.packingContent * i.price)}\n`;
                                  }
                                  msg += '\n';
                              });
                              if (!isQuoteOnly) {
                                  msg += `${'='.repeat(25)}\n總計: ${fmtMoney(calcTotal())}\n`;
                              }
                              msg += `\n備註:\n${companyInfo.bankInfo}`;
                              window.open(`https://line.me/R/msg/text/?${encodeURIComponent(msg)}`);
                          }}
                          className="bg-green-600 text-white px-8 py-4 rounded-2xl font-bold shadow-xl hover:shadow-2xl hover:bg-green-700 flex items-center gap-3 text-xl"
                      >
                          LINE
                          <LucideIcon name="Send" size={24} />
                      </button>
                  </div>
              </div>
          </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
