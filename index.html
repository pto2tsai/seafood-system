<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>å…«æ–¹ç’°çƒå ±åƒ¹ V9.0 (å¤§å­—é«”ç‰ˆ)</title>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    window.firebaseModules = { initializeApp, getDatabase, ref, set, onValue };
  </script>

  <style>
    * { 
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", sans-serif;
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: none;
      background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);
    }
    
    /* å­—é«”å„ªåŒ– - ç¢ºä¿æ¸…æ™°å¯è®€ */
    input, select, textarea {
      font-size: 18px !important;
      -webkit-user-select: text;
      user-select: text;
    }
    
    /* æŒ‰éˆ•å„ªåŒ– */
    button {
      min-height: 52px;
      touch-action: manipulation;
      -webkit-user-select: none;
      user-select: none;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 18px;
    }
    
    button:active {
      transform: scale(0.96);
    }
    
    /* ä¿ç•™åŸæœ‰æ¨£å¼ */
    @media print { .no-print { display: none !important; } }
    
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    .loader { 
      border: 4px solid #f3f3f3; 
      border-top: 4px solid #1d4ed8; 
      border-radius: 50%; 
      width: 28px; 
      height: 28px; 
      animation: spin 1s linear infinite; 
    }
    
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    
    .A4-product-name { 
      font-weight: 700; 
      font-size: 16px; 
      word-break: break-all; 
      line-height: 1.6; 
      margin-bottom: 6px; 
    }
    
    .login-bg { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    /* è¦–è¦ºå„ªåŒ– */
    .card-shadow {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    .card-shadow:hover {
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }
    
    .smooth-scroll {
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }
    
    .safe-area-bottom {
      padding-bottom: max(env(safe-area-inset-bottom), 16px);
    }
    
    .product-card {
      transition: all 0.2s ease;
    }
    
    .product-card:active {
      background: #eff6ff !important;
      transform: scale(0.98);
    }
    
    /* æ•¸å­—è¼¸å…¥å„ªåŒ– */
    .number-input-large {
      font-size: 32px !important;
      font-weight: 900;
      line-height: 1.2;
    }
    
    /* æ¼¸å±¤èƒŒæ™¯ */
    .gradient-blue {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .gradient-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    }
  </style>
</head>
<body class="text-slate-900">

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const firebaseConfig = {
        apiKey: "AIzaSyD59OwEnbcLZShhTTJJMu1VjJxrvzIcG_g",
        authDomain: "seafoodq-11b9d.firebaseapp.com",
        databaseURL: "https://seafoodq-11b9d-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "seafoodq-11b9d",
        storageBucket: "seafoodq-11b9d.firebasestorage.app",
        messagingSenderId: "454420146806",
        appId: "1:454420146806:web:802e6bd5e8e90aab21cd57"
    };

    const PASSWORDS = { SALES: "1688", ADMIN: "8888" };

    let db, dbRef, dbSet, dbOnValue;

    const initFirebase = () => {
        if (window.firebaseModules && !db) {
            const { initializeApp, getDatabase, ref, set, onValue } = window.firebaseModules;
            try {
                const app = initializeApp(firebaseConfig);
                db = getDatabase(app);
                dbRef = ref;
                dbSet = set;
                dbOnValue = onValue;
                return true;
            } catch (e) { 
              console.error("Firebaseåˆå§‹åŒ–éŒ¯èª¤:", e); 
              return false; 
            }
        }
        return !!db;
    };

    // Iconçµ„ä»¶
    const Icon = ({ path, size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{ __html: path }} />
    );
    
    const icons = {
      Plus: '<line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>',
      Trash2: '<polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line>',
      Send: '<line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>',
      Database: '<ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M3 12a9 3 0 0 0 18 0v-1a9 3 0 0 0-18 0z"></path><path d="M3 5v14a9 3 0 0 0 18 0V5"></path>',
      Search: '<circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>',
      X: '<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>',
      Image: '<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="M21 15l-3.37-3.37a.91.91 0 0 0-1.28 0L9 17"></path>',
      Cloud: '<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>',
      Lock: '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path>',
      Unlock: '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path>',
      Printer: '<polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect>',
      LogOut: '<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line>',
      ChevronLeft: '<polyline points="15 18 9 12 15 6"></polyline>',
      ArrowRight: '<line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline>',
      DollarSign: '<line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>',
      Download: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line>',
      Upload: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line>'
    };
    
    const LucideIcon = ({ name, ...props }) => <Icon path={icons[name]} {...props} />;

    // åœ–ç‰‡å£“ç¸®
    const compressImage = (file, maxWidth=800, quality=0.6) => {
        return new Promise((resolve, reject) => {
            if (!file.type.match('image.*')) { 
              reject(new Error("éåœ–ç‰‡æª”æ¡ˆ")); 
              return; 
            }
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > maxWidth) {
                        h = (h * maxWidth) / w;
                        w = maxWidth;
                    }
                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = () => reject(new Error("åœ–ç‰‡è¼‰å…¥å¤±æ•—"));
            };
            reader.onerror = () => reject(new Error("è®€å–æª”æ¡ˆå¤±æ•—"));
        });
    };

    const App = () => {
      // åŸºæœ¬ç‹€æ…‹
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [userRole, setUserRole] = useState('');
      const [loginInput, setLoginInput] = useState('');
      
      const [viewMode, setViewMode] = useState('edit');
      const [showSpecLookup, setShowSpecLookup] = useState(false);
      const [showAdmin, setShowAdmin] = useState(false);
      const [showPricePicker, setShowPricePicker] = useState(false);
      const [pickingPriceId, setPickingPriceId] = useState(null);
      const [isSyncing, setIsSyncing] = useState(true);
      const [uploadingImageId, setUploadingImageId] = useState(null);

      // è³‡æ–™åº«ç‹€æ…‹
      const [productDB, setProductDB] = useState({});
      const [inventoryDB, setInventoryDB] = useState({});
      const [priceTiers, setPriceTiers] = useState(['ç”Ÿæ„åƒ¹', 'æ•´ä»¶åƒ¹', 'VIPåƒ¹', 'æ¥­å‹™åº•åƒ¹']);
      const [dbMeta, setDbMeta] = useState({ quoteDate: '', stockDate: '' });

      // å ±åƒ¹å–®ç‹€æ…‹
      const [customerPriceTier, setCustomerPriceTier] = useState('ç”Ÿæ„åƒ¹');
      const [items, setItems] = useState([
        { 
          id: 1, 
          name: '', 
          specDetail: '', 
          qty: 1, 
          bigUnit: 'ä»¶', 
          packingContent: 1, 
          smallUnit: 'KG', 
          price: 0, 
          imageBase64: '' 
        }
      ]);
      
      const [companyInfo, setCompanyInfo] = useState({ 
          name: 'å…«æ–¹ç’°çƒ', 
          phone: '', 
          address: '', 
          bankInfo: '1. åƒ¹æ ¼ä»¥å‡ºè²¨ç•¶æ—¥ç‚ºæº–ã€‚\n2. è¦æ ¼èˆ‡é‡é‡è«‹æ–¼æ”¶è²¨æ™‚ç¢ºèªã€‚', 
          note: '' 
      });
      
      const [customerInfo, setCustomerInfo] = useState({
        name: '', 
        taxId: '', 
        contact: '', 
        phone: '', 
        address: '',
        paymentMethod: 'ç¾é‡‘', 
        date: new Date().toISOString().split('T')[0],
        quoteNo: `Q${new Date().toISOString().slice(2,10).replace(/-/g,'')}-01`
      });
      
      const [editingItemId, setEditingItemId] = useState(null);
      const [isQuoteOnly, setIsQuoteOnly] = useState(false);
      const [previewFormat, setPreviewFormat] = useState('mobile');
      
      const previewRef = useRef(null);

      // åˆå§‹åŒ–
      useEffect(() => {
          const sessionRole = sessionStorage.getItem('seafood_role');
          if (sessionRole) {
              setUserRole(sessionRole);
              setIsAuthenticated(true);
              connectDB();
          }
          
          const loadCompanyInfo = () => {
            try {
              const saved = localStorage.getItem('v6_company');
              if (saved) setCompanyInfo(JSON.parse(saved));
            } catch(e) {
              console.error("è¼‰å…¥å…¬å¸è³‡è¨Šå¤±æ•—:", e);
            }
          };
          loadCompanyInfo();
      }, []);

      // Firebase é€£ç·š
      const connectDB = () => {
          const tryConnect = () => {
              if (initFirebase()) {
                  try {
                      const dataRef = dbRef(db, 'seafoodData');
                      dbOnValue(dataRef, (snapshot) => {
                          const data = snapshot.val();
                          if (data) {
                              if (data.productDB) setProductDB(data.productDB);
                              if (data.inventoryDB) setInventoryDB(data.inventoryDB);
                              if (data.priceTiers) setPriceTiers(data.priceTiers);
                              if (data.dbMeta) setDbMeta(data.dbMeta);
                          }
                          setIsSyncing(false);
                      }, (error) => {
                          console.error("è³‡æ–™åº«è®€å–éŒ¯èª¤:", error);
                          setIsSyncing(false);
                      });
                  } catch(e) {
                      console.error("é€£ç·šéŒ¯èª¤:", e);
                      setTimeout(tryConnect, 1000);
                  }
              } else { 
                  setTimeout(tryConnect, 500); 
              }
          };
          tryConnect();
      };

      // ç™»å…¥/ç™»å‡º
      const handleLogin = (e) => {
          e.preventDefault();
          if (loginInput === PASSWORDS.ADMIN) {
              setUserRole('admin');
              setIsAuthenticated(true);
              sessionStorage.setItem('seafood_role', 'admin');
              connectDB();
          } else if (loginInput === PASSWORDS.SALES) {
              setUserRole('sales');
              setIsAuthenticated(true);
              sessionStorage.setItem('seafood_role', 'sales');
              connectDB();
          } else {
              alert("âŒ å¯†ç¢¼éŒ¯èª¤");
          }
      };

      const handleLogout = () => {
          if (confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
              setIsAuthenticated(false);
              setUserRole('');
              sessionStorage.removeItem('seafood_role');
              setLoginInput('');
          }
      };

      // é›²ç«¯ä¸Šå‚³
      const uploadToCloud = (newProductDB, newInventoryDB, newTiers, newMeta) => {
          if (!db || !dbSet) { 
            alert("âŒ å°šæœªé€£æ¥é›²ç«¯è³‡æ–™åº«"); 
            return; 
          }
          
          const finalProductDB = newProductDB || productDB;
          const finalInventoryDB = newInventoryDB || inventoryDB;
          const finalTiers = newTiers || priceTiers;
          const finalMeta = { ...dbMeta, ...newMeta };
          
          dbSet(dbRef(db, 'seafoodData'), {
              productDB: finalProductDB,
              inventoryDB: finalInventoryDB,
              priceTiers: finalTiers,
              dbMeta: finalMeta
          })
          .then(() => alert("âœ… é›²ç«¯åŒæ­¥æˆåŠŸï¼"))
          .catch(err => alert("âŒ ä¸Šå‚³å¤±æ•—: " + err.message));
      };

      // Excel ä¸Šå‚³è™•ç†
      const handleFileUpload = (e, type) => {
          if (userRole !== 'admin') {
            alert("âŒ åƒ…ç®¡ç†å“¡å¯ä¸Šå‚³è³‡æ–™");
            return;
          }
          
          const file = e.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = (evt) => {
              try {
                  const wb = XLSX.read(evt.target.result, { type: 'binary' });
                  const ws = wb.Sheets[wb.SheetNames[0]];
                  const rawData = XLSX.utils.sheet_to_json(ws, { header: 1 });
                  
                  if (type === 'quote') processQuoteData(rawData);
                  else if (type === 'stock') processStockData(rawData);
              } catch(err) {
                  alert("âŒ è®€å–å¤±æ•—: " + err.message);
              }
          };
          reader.readAsBinaryString(file);
          e.target.value = null;
      };

      // å°‹æ‰¾æ¨™é¡Œè¡Œ
      const findHeaderRow = (rows, keywords) => {
          for (let i = 0; i < Math.min(rows.length, 10); i++) {
              const rowStr = JSON.stringify(rows[i]).toLowerCase();
              if (keywords.every(k => rowStr.includes(k.toLowerCase()))) {
                  return i;
              }
          }
          return -1;
      };

      // å ±åƒ¹å–®è™•ç†
      const processQuoteData = (rawData) => {
          const headerRowIdx = findHeaderRow(rawData, ['å“è™Ÿ', 'å“å']);
          if (headerRowIdx === -1) {
              alert("âŒ æ ¼å¼éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ã€Œå“è™Ÿã€æˆ–ã€Œå“åã€æ¬„ä½");
              return;
          }

          const headers = rawData[headerRowIdx];
          const data = rawData.slice(headerRowIdx + 1).map(row => {
              let obj = {};
              headers.forEach((h, i) => {
                  if (h) obj[h] = row[i];
              });
              return obj;
          }).filter(row => row['å“è™Ÿ'] || row['ID'] || row['å“å']);

          const newDB = {};
          const foundTiers = new Set();
          let count = 0;

          const parseCleanFloat = (val) => {
              if (!val) return 0;
              if (typeof val === 'number') return val;
              const cleaned = String(val).replace(/[,]/g, '');
              const num = parseFloat(cleaned);
              return isNaN(num) ? 0 : num;
          };

          data.forEach((row) => {
              const pid = String(row['å“è™Ÿ'] || row['ID'] || '').trim();
              const name = String(row['å“å'] || '').trim();
              const spec = String(row['è¦æ ¼'] || row['åŒ…è£'] || '').trim();

              if (!pid || !name) return;

              const prices = {};
              Object.keys(row).forEach(key => {
                  if (key.includes('åƒ¹') && !key.includes('å”®åƒ¹') && !key.includes('ç‰Œåƒ¹')) {
                      const price = parseCleanFloat(row[key]);
                      if (price > 0) {
                          prices[key] = price;
                          foundTiers.add(key);
                      }
                  }
              });

              let packNum = 1;
              const matches = [...spec.matchAll(/(\d+(\.\d+)?)\s*(ç›’|åŒ…|å¡Š|ç‰‡|KG|å…¬æ–¤)/gi)];
              if (matches.length > 0) {
                  packNum = parseFloat(matches[matches.length - 1][1]);
              }

              if (!newDB[name]) newDB[name] = [];
              
              const existing = newDB[name].find(s => s.id === pid);
              if (!existing) {
                  newDB[name].push({
                      id: pid,
                      name: name,
                      specDetail: spec,
                      pack: packNum || 1,
                      smallUnit: 'KG',
                      bigUnit: 'ä»¶',
                      prices: Object.keys(prices).length > 0 ? prices : { 'ç”Ÿæ„åƒ¹': 0 },
                      note: ''
                  });
                  count++;
              }
          });

          if (count > 0) {
              const tiersArray = Array.from(foundTiers);
              const msg = `å ±åƒ¹å–®åŒ¯å…¥å®Œæˆï¼\nè§£æäº† ${count} ç­†ç”¢å“è³‡æ–™ã€‚\nåƒ¹æ ¼ç­‰ç´š: ${tiersArray.join(', ')}`;
              
              if (confirm(msg + "\n\nè¦ä¸Šå‚³åˆ°é›²ç«¯å—ï¼Ÿ")) {
                  uploadToCloud(
                      newDB,
                      null,
                      tiersArray.length > 0 ? tiersArray : priceTiers,
                      { quoteDate: new Date().toLocaleString() }
                  );
              }
          } else {
              alert("âŒ åŒ¯å…¥å¤±æ•—: ç„¡æœ‰æ•ˆå ±åƒ¹è³‡æ–™");
          }
      };

      // åº«å­˜è™•ç† (ç°¡åŒ–ç‰ˆï¼Œä¿ç•™æ ¸å¿ƒé‚è¼¯)
      const processStockData = (rawData) => {
          const headerRowIdx = findHeaderRow(rawData, ['å“è™Ÿ']);
          if (headerRowIdx === -1) {
              alert("âŒ æ ¼å¼éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ã€Œå“è™Ÿã€æ¬„ä½");
              return;
          }

          const headers = rawData[headerRowIdx];
          const hasWhCol = headers.some(h => 
              String(h).includes('åº«åˆ¥') || 
              String(h).includes('å€‰åº«') ||
              String(h).includes('åº«ä½')
          );

          const data = rawData.slice(headerRowIdx + 1).map(row => {
              let obj = {};
              headers.forEach((h, i) => {
                  if (h) obj[h] = row[i];
              });
              return obj;
          }).filter(row => row['å“è™Ÿ'] || row['ID']);

          const newInv = {};
          let count = 0;

          const parseCleanFloat = (val) => {
              if (!val) return 0;
              if (typeof val === 'number') return val;
              const cleaned = String(val).replace(/[,]/g, '');
              const num = parseFloat(cleaned);
              return isNaN(num) ? 0 : num;
          };

          const processItem = (pid, name, spec, warehouse, qty) => {
              if (!pid || !warehouse || qty <= 0) return;
              
              pid = String(pid).trim();
              warehouse = String(warehouse).trim();
              
              if (pid.includes('å°è¨ˆ') || pid.includes('åˆè¨ˆ') || 
                  warehouse.includes('å°è¨ˆ') || warehouse.includes('åˆè¨ˆ')) {
                  return;
              }

              if (!newInv[pid]) newInv[pid] = [];
              
              const existing = newInv[pid].find(s => s.warehouse === warehouse);
              if (existing) {
                  existing.stock += qty;
              } else {
                  newInv[pid].push({ warehouse, stock: qty });
              }
              count++;
          };

          if (hasWhCol) {
              data.forEach(row => {
                  const pidKey = Object.keys(row).find(k => k.includes('å“è™Ÿ') || k === 'ID');
                  const nameKey = Object.keys(row).find(k => k.includes('å“å'));
                  const specKey = Object.keys(row).find(k => k.includes('è¦æ ¼'));
                  const whKey = Object.keys(row).find(k => k.includes('åº«åˆ¥') || k.includes('å€‰åº«'));
                  const qtyKey = Object.keys(row).find(k => k.includes('åº«å­˜') || k.includes('æ•¸é‡') || k.includes('åŒ…è£æ•¸é‡'));

                  processItem(
                      row[pidKey],
                      row[nameKey],
                      row[specKey],
                      row[whKey],
                      parseCleanFloat(row[qtyKey])
                  );
              });
          } else {
              data.forEach(row => {
                  const pidKey = Object.keys(row).find(k => k.includes('å“è™Ÿ') || k === 'ID');
                  const nameKey = Object.keys(row).find(k => k.includes('å“å'));
                  const specKey = Object.keys(row).find(k => k.includes('è¦æ ¼'));
                  const pid = row[pidKey];
                  const name = row[nameKey];
                  const spec = row[specKey];

                  if (!pid) return;
                  
                  Object.keys(row).forEach(k => {
                      const val = row[k];
                      if (!['å“è™Ÿ', 'å“å', 'è¦æ ¼', 'ID'].some(ex => k.includes(ex))) {
                          const numVal = parseCleanFloat(val);
                          if (numVal > 0) {
                              processItem(pid, name, spec, k, numVal);
                          }
                      }
                  });
              });
          }

          if (count > 0) {
              const msg = `åº«å­˜åŒ¯å…¥å®Œæˆï¼\næ›´æ–°äº† ${count} ç­†åº«å­˜ç´€éŒ„ã€‚`;
              
              if (confirm(msg + "\n\nè¦ä¸Šå‚³åˆ°é›²ç«¯å—ï¼Ÿ")) {
                  uploadToCloud(
                      null,
                      newInv,
                      null,
                      { stockDate: new Date().toLocaleString() }
                  );
              }
          } else {
              alert("âŒ åŒ¯å…¥å¤±æ•—: ç„¡æœ‰æ•ˆåº«å­˜è³‡æ–™");
          }
      };

      // é …ç›®æ“ä½œ
      const updateItem = (id, field, value) => {
          setItems(prev => prev.map(i => i.id === id ? { ...i, [field]: value } : i));
      };

      const addItem = () => {
          setItems([...items, {
              id: Date.now(),
              name: '',
              specDetail: '',
              qty: 1,
              bigUnit: 'ä»¶',
              packingContent: 1,
              smallUnit: 'KG',
              price: 0,
              imageBase64: ''
          }]);
      };

      const removeItem = (id) => {
          if (items.length === 1) {
              alert("âš ï¸ è‡³å°‘è¦ä¿ç•™ä¸€å€‹é …ç›®");
              return;
          }
          if (confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹é …ç›®å—ï¼Ÿ")) {
              setItems(prev => prev.filter(i => i.id !== id));
          }
      };

      const handleNumeric = (e) => {
          const val = parseFloat(e.target.value);
          return isNaN(val) || val < 0 ? 0 : val;
      };

      const calcTotal = () => {
          return items.reduce((sum, i) => sum + (i.qty * i.packingContent * i.price), 0);
      };

      const fmtMoney = (n) => {
          return new Intl.NumberFormat('zh-TW', {
              style: 'currency',
              currency: 'TWD',
              minimumFractionDigits: 0
          }).format(n);
      };

      // ç”¢å“é¸æ“‡
      const openSpecLookup = (id) => {
          setEditingItemId(id);
          setShowSpecLookup(true);
      };

      const applySpec = (spec) => {
          updateItem(editingItemId, 'originalSpec', spec);
          updateItem(editingItemId, 'name', spec.name);
          updateItem(editingItemId, 'specDetail', spec.specDetail);
          updateItem(editingItemId, 'packingContent', spec.pack);
          updateItem(editingItemId, 'smallUnit', spec.smallUnit);
          updateItem(editingItemId, 'bigUnit', spec.bigUnit);
          updateItem(editingItemId, 'price', spec.prices[customerPriceTier] || 0);
          setShowSpecLookup(false);
      };

      // åœ–ç‰‡ä¸Šå‚³
      const handleImageUpload = async (e, id) => {
          const file = e.target.files[0];
          if (file) {
              setUploadingImageId(id);
              try {
                  const b64 = await compressImage(file, 800, 0.6);
                  updateItem(id, 'imageBase64', b64);
              } catch (err) {
                  alert("âŒ åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼š" + err.message);
              } finally {
                  setUploadingImageId(null);
                  e.target.value = null;
              }
          }
      };

      // åƒ¹æ ¼é¸æ“‡å™¨
      const openPricePicker = (itemId) => {
          const item = items.find(i => i.id === itemId);
          if (!item || !item.name) {
              alert("âš ï¸ è«‹å…ˆé¸æ“‡ç”¢å“");
              return;
          }
          setPickingPriceId(itemId);
          setShowPricePicker(true);
      };

      const selectPrice = (price) => {
          updateItem(pickingPriceId, 'price', price);
          setShowPricePicker(false);
          setPickingPriceId(null);
      };

      // è½‰åœ–ç‰‡
      const handleDownloadImage = async () => {
          if (!previewRef.current) return;
          try {
              const canvas = await html2canvas(previewRef.current, {
                  useCORS: true,
                  scale: 2,
                  backgroundColor: '#ffffff'
              });
              const link = document.createElement('a');
              link.download = `å ±åƒ¹å–®_${customerInfo.name}_${customerInfo.date}.jpg`;
              link.href = canvas.toDataURL('image/jpeg', 0.9);
              link.click();
          } catch (err) {
              alert("âŒ è½‰å­˜å¤±æ•—: " + err.message);
          }
      };

      // ===== åƒ¹æ ¼é¸æ“‡å™¨çµ„ä»¶ =====
      const PricePickerModal = () => {
          const item = items.find(i => i.id === pickingPriceId);
          if (!item) return null;

          let pricesObj = {};
          if (item.originalSpec && item.originalSpec.prices) {
              pricesObj = item.originalSpec.prices;
          } else {
              const group = productDB[item.name];
              if (group) {
                  const found = group.find(s => s.specDetail === item.specDetail);
                  if (found && found.prices) pricesObj = found.prices;
              }
          }

          const priceEntries = Object.entries(pricesObj);

          return (
              <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-5" onClick={() => setShowPricePicker(false)}>
                  <div className="bg-white rounded-3xl p-8 w-full max-w-lg shadow-2xl" onClick={e => e.stopPropagation()}>
                      <h3 className="text-2xl font-black mb-3">é¸æ“‡åƒ¹æ ¼ç­‰ç´š</h3>
                      <div className="text-lg text-gray-600 mb-6">{item.name} {item.specDetail}</div>
                      <div className="space-y-3 mb-8">
                          {priceEntries.length > 0 ? (
                              priceEntries.map(([tier, price]) => (
                                  <button
                                      key={tier}
                                      onClick={() => selectPrice(price)}
                                      className="w-full p-5 rounded-2xl border-3 border-gray-200 hover:border-blue-500 hover:bg-blue-50 flex justify-between items-center text-left transition card-shadow"
                                  >
                                      <span className="font-bold text-xl text-gray-700">{tier}</span>
                                      <span className="text-3xl font-black text-blue-600">${price.toLocaleString()}</span>
                                  </button>
                              ))
                          ) : (
                              <div className="text-center text-gray-400 py-8 text-lg">
                                  æ­¤ç”¢å“å°šç„¡åƒ¹æ ¼è³‡æ–™
                              </div>
                          )}
                      </div>
                      <button
                          onClick={() => setShowPricePicker(false)}
                          className="w-full py-4 bg-gray-100 rounded-2xl font-bold text-lg text-gray-700 hover:bg-gray-200"
                      >
                          é—œé–‰
                      </button>
                  </div>
              </div>
          );
      };

      // ===== ç®¡ç†é¢æ¿çµ„ä»¶ =====
      const AdminPanel = () => (
          <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-5 no-scrollbar overflow-auto" onClick={() => setShowAdmin(false)}>
              <div className="bg-white rounded-3xl w-full max-w-2xl my-auto card-shadow" onClick={e => e.stopPropagation()}>
                  <div className="sticky top-0 bg-white border-b p-6 rounded-t-3xl flex justify-between items-center">
                      <h2 className="text-2xl font-black">è³‡æ–™ç®¡ç†</h2>
                      <button onClick={() => setShowAdmin(false)} className="p-3 hover:bg-gray-100 rounded-full">
                          <LucideIcon name="X" size={28} />
                      </button>
                  </div>

                  <div className="p-8 space-y-8 max-h-[80vh] overflow-auto">
                      {/* è³‡æ–™åº«ç‹€æ…‹ */}
                      <div className="gradient-blue text-white p-6 rounded-3xl card-shadow">
                          <div className="flex items-center gap-4 mb-5">
                              <LucideIcon name="Database" size={40} />
                              <div>
                                  <h3 className="font-black text-xl">è³‡æ–™åº«ç‹€æ…‹</h3>
                                  <p className="text-sm opacity-90 mt-1">Firebase å³æ™‚åŒæ­¥</p>
                              </div>
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                              <div className="bg-white/20 backdrop-blur-sm p-4 rounded-2xl">
                                  <div className="text-3xl font-black">{Object.keys(productDB).length}</div>
                                  <div className="text-sm opacity-90 mt-1">ç”¢å“åˆ†é¡</div>
                              </div>
                              <div className="bg-white/20 backdrop-blur-sm p-4 rounded-2xl">
                                  <div className="text-3xl font-black">{Object.keys(inventoryDB).length}</div>
                                  <div className="text-sm opacity-90 mt-1">åº«å­˜å“é …</div>
                              </div>
                          </div>
                          {dbMeta.quoteDate && (
                              <div className="mt-4 text-sm opacity-80">
                                  å ±åƒ¹å–®æ›´æ–°: {dbMeta.quoteDate}
                              </div>
                          )}
                          {dbMeta.stockDate && (
                              <div className="text-sm opacity-80">
                                  åº«å­˜æ›´æ–°: {dbMeta.stockDate}
                              </div>
                          )}
                      </div>

                      {/* ä¸Šå‚³æŒ‰éˆ• */}
                      {userRole === 'admin' && (
                          <div className="space-y-4">
                              <label className="block">
                                  <div className="w-full bg-blue-50 border-4 border-dashed border-blue-300 text-blue-700 font-bold p-8 rounded-3xl text-center hover:bg-blue-100 cursor-pointer transition card-shadow">
                                      <LucideIcon name="Upload" size={40} className="mx-auto mb-3" />
                                      <div className="text-xl mb-2">ä¸Šå‚³å ±åƒ¹å–®</div>
                                      <div className="text-base opacity-75">æ”¯æ´ Excel / CSV</div>
                                  </div>
                                  <input
                                      type="file"
                                      className="hidden"
                                      accept=".xlsx,.xls,.csv"
                                      onChange={e => handleFileUpload(e, 'quote')}
                                  />
                              </label>

                              <label className="block">
                                  <div className="w-full bg-green-50 border-4 border-dashed border-green-300 text-green-700 font-bold p-8 rounded-3xl text-center hover:bg-green-100 cursor-pointer transition card-shadow">
                                      <LucideIcon name="Database" size={40} className="mx-auto mb-3" />
                                      <div className="text-xl mb-2">ä¸Šå‚³åº«å­˜è¡¨</div>
                                      <div className="text-base opacity-75">æ”¯æ´ Excel / CSV</div>
                                  </div>
                                  <input
                                      type="file"
                                      className="hidden"
                                      accept=".xlsx,.xls,.csv"
                                      onChange={e => handleFileUpload(e, 'stock')}
                                  />
                              </label>
                          </div>
                      )}

                      {/* åƒ¹æ ¼ç­‰ç´š */}
                      <div className="bg-gray-50 p-6 rounded-3xl">
                          <h4 className="font-bold text-lg mb-3">åƒ¹æ ¼ç­‰ç´š</h4>
                          <div className="flex flex-wrap gap-3">
                              {priceTiers.map(tier => (
                                  <span key={tier} className="px-5 py-2 bg-blue-100 text-blue-700 rounded-full text-base font-bold">
                                      {tier}
                                  </span>
                              ))}
                          </div>
                      </div>

                      {/* å…¬å¸è³‡è¨Šè¨­å®š */}
                      <div className="border-t pt-8">
                          <h4 className="font-bold text-lg mb-4">å…¬å¸è³‡è¨Š</h4>
                          <div className="space-y-4">
                              <input
                                  type="text"
                                  placeholder="å…¬å¸åç¨±"
                                  className="w-full p-4 border-2 border-gray-200 rounded-2xl text-lg"
                                  value={companyInfo.name}
                                  onChange={e => setCompanyInfo({ ...companyInfo, name: e.target.value })}
                              />
                              <input
                                  type="text"
                                  placeholder="é›»è©±"
                                  className="w-full p-4 border-2 border-gray-200 rounded-2xl text-lg"
                                  value={companyInfo.phone}
                                  onChange={e => setCompanyInfo({ ...companyInfo, phone: e.target.value })}
                              />
                              <textarea
                                  placeholder="åŒ¯æ¬¾è³‡è¨Š / å‚™è¨»"
                                  className="w-full p-4 border-2 border-gray-200 rounded-2xl h-32 text-lg"
                                  value={companyInfo.bankInfo}
                                  onChange={e => setCompanyInfo({ ...companyInfo, bankInfo: e.target.value })}
                              />
                              <button
                                  onClick={() => {
                                      localStorage.setItem('v6_company', JSON.stringify(companyInfo));
                                      alert("âœ… å…¬å¸è³‡è¨Šå·²å„²å­˜");
                                  }}
                                  className="w-full bg-blue-600 text-white p-5 rounded-2xl font-bold text-lg hover:bg-blue-700"
                              >
                                  å„²å­˜å…¬å¸è³‡è¨Š
                              </button>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      );

      // ===== ç”¢å“é¸æ“‡çµ„ä»¶ =====
      const SpecModal = () => {
          const [searchTerm, setSearchTerm] = useState('');

          const allSpecs = Object.entries(productDB).flatMap(([name, specs]) =>
              specs.map(spec => ({ ...spec, groupName: name }))
          );

          const filtered = allSpecs.filter(spec => {
              const term = searchTerm.toLowerCase();
              return (
                  spec.name.toLowerCase().includes(term) ||
                  spec.specDetail.toLowerCase().includes(term) ||
                  spec.id.toLowerCase().includes(term)
              );
          });

          return (
              <div className="fixed inset-0 bg-black/60 z-50 flex flex-col">
                  {/* æœå°‹åˆ— */}
                  <div className="bg-white border-b p-5 safe-area-top">
                      <div className="flex gap-3 mb-3">
                          <div className="flex-1 relative">
                              <LucideIcon name="Search" size={24} className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" />
                              <input
                                  type="text"
                                  placeholder="æœå°‹ç”¢å“åç¨±ã€è¦æ ¼æˆ–å“è™Ÿ..."
                                  className="w-full pl-12 pr-5 py-4 border-2 border-gray-200 rounded-2xl focus:border-blue-500 outline-none text-lg"
                                  value={searchTerm}
                                  onChange={e => setSearchTerm(e.target.value)}
                                  autoFocus
                              />
                          </div>
                          <button
                              onClick={() => {
                                  setShowSpecLookup(false);
                                  setSearchTerm('');
                              }}
                              className="px-8 bg-gray-100 rounded-2xl font-bold hover:bg-gray-200 text-lg"
                          >
                              é—œé–‰
                          </button>
                      </div>
                      <div className="text-base text-gray-600">
                          æ‰¾åˆ° <span className="font-bold text-blue-600">{filtered.length}</span> å€‹ç”¢å“
                      </div>
                  </div>

                  {/* ç”¢å“åˆ—è¡¨ */}
                  <div className="flex-1 overflow-auto bg-gray-50 smooth-scroll">
                      {filtered.length === 0 && (
                          <div className="text-center py-16 text-gray-400">
                              <LucideIcon name="Search" size={80} className="mx-auto mb-4 opacity-50" />
                              <p className="text-xl font-bold">æŸ¥ç„¡è³‡æ–™</p>
                              <p className="text-base mt-2">è©¦è©¦å…¶ä»–é—œéµå­—</p>
                          </div>
                      )}

                      <div className="p-5 space-y-4">
                          {Object.entries(
                              filtered.reduce((groups, spec) => {
                                  if (!groups[spec.groupName]) groups[spec.groupName] = [];
                                  groups[spec.groupName].push(spec);
                                  return groups;
                              }, {})
                          ).map(([groupName, specs]) => (
                              <div key={groupName} className="bg-white rounded-3xl overflow-hidden card-shadow">
                                  <div className="bg-gradient-to-r from-gray-700 to-gray-600 text-white px-6 py-4 font-black text-lg">
                                      {groupName}
                                  </div>
                                  {specs.map((spec) => {
                                      const stocks = inventoryDB[spec.id] || [];
                                      const totalStock = stocks.reduce((sum, s) => sum + s.stock, 0);

                                      return (
                                          <div
                                              key={spec.id}
                                              onClick={() => applySpec(spec)}
                                              className="product-card p-6 border-b last:border-b-0 cursor-pointer hover:bg-blue-50"
                                          >
                                              <div className="flex justify-between items-start mb-3">
                                                  <div className="flex-1 pr-4">
                                                      <div className="font-black text-blue-800 text-xl mb-2">
                                                          {spec.specDetail}
                                                      </div>
                                                      <div className="text-base text-gray-600">
                                                          å“è™Ÿ: {spec.id} | ç®±å®¹: {spec.pack}{spec.smallUnit}
                                                      </div>
                                                      {spec.note && (
                                                          <div className="text-sm text-orange-500 mt-2">{spec.note}</div>
                                                      )}
                                                  </div>
                                                  <div className="text-right">
                                                      <div className="text-3xl font-black text-gray-800">
                                                          ${(spec.prices[customerPriceTier] || 0).toLocaleString()}
                                                      </div>
                                                      <div className={`text-sm px-3 py-1.5 rounded-full mt-2 font-bold ${
                                                          totalStock > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-600'
                                                      }`}>
                                                          åº«å­˜: {totalStock}
                                                      </div>
                                                  </div>
                                              </div>

                                              {/* å¤šå€‰ä½åº«å­˜ */}
                                              {stocks.length > 0 && (
                                                  <div className="flex flex-wrap gap-2 mt-3">
                                                      {stocks.map((s, k) => (
                                                          <span
                                                              key={k}
                                                              className="text-sm bg-gray-100 border-2 border-gray-200 px-3 py-1.5 rounded-lg text-gray-700 font-semibold"
                                                          >
                                                              {s.warehouse}: <b className="text-black">{s.stock}</b>
                                                          </span>
                                                      ))}
                                                  </div>
                                              )}
                                          </div>
                                      );
                                  })}
                              </div>
                          ))}
                      </div>
                  </div>
              </div>
          );
      };

      // ===== ç™»å…¥é  =====
      if (!isAuthenticated) {
          return (
              <div className="min-h-screen login-bg flex items-center justify-center p-6">
                  <div className="bg-white/95 backdrop-blur-xl rounded-[40px] p-10 shadow-2xl w-full max-w-md text-center">
                      <div className="mb-10 flex justify-center">
                          <div className="gradient-blue p-6 rounded-full text-white shadow-2xl">
                              <LucideIcon name="Cloud" size={56} />
                          </div>
                      </div>
                      <h1 className="text-4xl font-black text-slate-800 mb-3">å…«æ–¹ç’°çƒå ±åƒ¹</h1>
                      <p className="text-lg text-gray-500 mb-10">V9.0 å¤§å­—é«”ç‰ˆ</p>
                      
                      <form onSubmit={handleLogin} className="space-y-5">
                          <input
                              type="password"
                              className="w-full text-center text-4xl font-black p-5 border-b-4 border-blue-600 bg-slate-100 rounded-2xl focus:bg-white transition outline-none"
                              placeholder="å¯†ç¢¼"
                              maxLength={4}
                              value={loginInput}
                              onChange={e => setLoginInput(e.target.value)}
                              autoFocus
                              style={{fontSize: '32px'}}
                          />
                          <button
                              type="submit"
                              className="w-full py-5 gradient-blue text-white rounded-2xl font-black text-2xl shadow-2xl"
                          >
                              ç™» å…¥
                          </button>
                      </form>
                      
                      <div className="mt-8 text-base text-gray-500">
                          <div>ç®¡ç†å“¡: 8888 | æ¥­å‹™: 1688</div>
                      </div>
                  </div>
              </div>
          );
      }

      // ===== é è¦½æ¨¡å¼ (ç°¡åŒ–ç‰ˆ) =====
      if (viewMode === 'preview') {
          return (
              <div className="min-h-screen bg-white pb-12">
                  <div className="gradient-blue text-white p-5 sticky top-0 z-50 flex justify-between items-center no-print shadow-2xl">
                      <div className="flex items-center gap-4">
                          <button
                              onClick={() => setViewMode('edit')}
                              className="flex items-center gap-2 font-bold text-lg bg-white/20 px-6 py-3 rounded-2xl hover:bg-white/30"
                          >
                              <LucideIcon name="ChevronLeft" size={24} />
                              è¿”å›
                          </button>
                          
                          <div className="flex bg-white/20 rounded-2xl p-1.5 gap-2">
                              <button
                                  onClick={() => setPreviewFormat('mobile')}
                                  className={`px-6 py-3 rounded-xl text-base font-bold transition ${
                                      previewFormat === 'mobile' ? 'bg-white text-blue-900' : 'text-white/80 hover:text-white'
                                  }`}
                              >
                                  ğŸ“± æ‰‹æ©Ÿ
                              </button>
                              <button
                                  onClick={() => setPreviewFormat('a4')}
                                  className={`px-6 py-3 rounded-xl text-base font-bold transition ${
                                      previewFormat === 'a4' ? 'bg-white text-blue-900' : 'text-white/80 hover:text-white'
                                  }`}
                              >
                                  ğŸ“„ A4
                              </button>
                          </div>
                      </div>

                      <div className="flex gap-3">
                          <button
                              onClick={handleDownloadImage}
                              className="bg-yellow-500 text-white px-6 py-3 rounded-2xl font-bold text-lg flex items-center gap-2 hover:bg-yellow-600"
                          >
                              <LucideIcon name="Image" size={20} />
                              è½‰åœ–ç‰‡
                          </button>
                          <button
                              onClick={() => window.print()}
                              className="bg-white text-blue-900 px-6 py-3 rounded-2xl font-bold text-lg flex items-center gap-2 hover:bg-gray-100"
                          >
                              <LucideIcon name="Printer" size={20} />
                              åˆ—å°
                          </button>
                      </div>
                  </div>

                  <div ref={previewRef} className="bg-white">
                      {previewFormat === 'mobile' ? (
                          <div className="max-w-md mx-auto shadow-2xl my-8 rounded-3xl overflow-hidden border-2 border-gray-200">
                              <div className="gradient-blue text-white p-8">
                                  <h2 className="text-3xl font-black mb-2">{customerInfo.name || 'å®¢æˆ¶åç¨±'}</h2>
                                  <p className="text-lg opacity-90">{customerInfo.quoteNo}</p>
                                  {!isQuoteOnly && (
                                      <div className="mt-6 text-5xl font-black text-right">
                                          {fmtMoney(calcTotal())}
                                      </div>
                                  )}
                              </div>

                              <div className="divide-y divide-gray-100">
                                  {items.filter(item => item.name).map((item, i) => (
                                      <div key={i} className="p-6">
                                          <div className="flex justify-between font-black text-xl mb-3">
                                              <span className="flex-1">{item.name} {item.specDetail}</span>
                                              {!isQuoteOnly && (
                                                  <span className="ml-5 text-blue-600">
                                                      {fmtMoney(item.qty * item.packingContent * item.price)}
                                                  </span>
                                              )}
                                          </div>

                                          <div className="text-lg text-gray-600 flex justify-between items-center">
                                              <div className="flex items-center gap-4">
                                                  {item.imageBase64 && (
                                                      <img
                                                          src={item.imageBase64}
                                                          className="w-16 h-16 object-cover rounded-xl border-2 border-gray-200"
                                                          alt=""
                                                      />
                                                  )}
                                                  <span className="font-bold text-xl">
                                                      ${item.price}/{item.smallUnit}
                                                  </span>
                                              </div>
                                              {!isQuoteOnly && (
                                                  <span className="bg-blue-50 text-blue-700 px-5 py-2 rounded-xl font-black text-lg">
                                                      {item.qty} {item.bigUnit}
                                                  </span>
                                              )}
                                          </div>
                                      </div>
                                  ))}
                              </div>

                              <div className="p-8 bg-gray-50 text-base text-gray-600">
                                  <div className="font-bold text-black mb-3 text-lg">å‚™è¨»:</div>
                                  <pre className="whitespace-pre-wrap font-sans leading-relaxed">
                                      {companyInfo.bankInfo}
                                  </pre>
                              </div>
                          </div>
                      ) : (
                          <div className="max-w-[210mm] mx-auto p-12 shadow-2xl my-8 bg-white print:shadow-none print:my-0 print:p-0">
                              <div className="flex justify-between items-end border-b-4 border-black pb-6 mb-8">
                                  <div>
                                      <h1 className="text-5xl font-black mb-3">
                                          {isQuoteOnly ? 'å ± åƒ¹ å–®' : 'éŠ· è²¨ å–®'}
                                      </h1>
                                      <p className="text-lg text-gray-600">
                                          {companyInfo.name} {companyInfo.phone && `| ${companyInfo.phone}`}
                                      </p>
                                  </div>
                                  <div className="text-right text-lg">
                                      <p className="mb-2">
                                          å–®è™Ÿ: <b className="text-xl">{customerInfo.quoteNo}</b>
                                      </p>
                                      <p>
                                          æ—¥æœŸ: <b className="text-xl">{customerInfo.date}</b>
                                      </p>
                                  </div>
                              </div>

                              <div className="mb-8 p-5 border-2 rounded-2xl bg-gray-50">
                                  <div className="grid grid-cols-2 gap-3 text-base">
                                      <p>
                                          å®¢æˆ¶: <b className="text-lg">{customerInfo.name}</b>
                                      </p>
                                      <p>
                                          è¯çµ¡äºº: <b className="text-lg">{customerInfo.contact}</b>
                                      </p>
                                      <p className="col-span-2">
                                          åœ°å€: {customerInfo.address}
                                      </p>
                                  </div>
                              </div>

                              <table className="w-full text-base border-collapse border-2 border-black mb-8">
                                  <thead>
                                      <tr className="bg-gray-800 text-white">
                                          <th className="border border-black p-4 w-16">No.</th>
                                          <th className="border border-black p-4 text-left">å“åè¦æ ¼</th>
                                          {!isQuoteOnly && <th className="border border-black p-4">æ•¸é‡</th>}
                                          <th className="border border-black p-4 text-right">å–®åƒ¹</th>
                                          {!isQuoteOnly && <th className="border border-black p-4 text-right">é‡‘é¡</th>}
                                      </tr>
                                  </thead>
                                  <tbody>
                                      {items.filter(item => item.name).map((item, i) => (
                                          <tr key={i} className="hover:bg-gray-50">
                                              <td className="border border-black p-4 text-center font-bold text-lg">
                                                  {i + 1}
                                              </td>
                                              <td className="border border-black p-4">
                                                  <div className="flex items-center gap-4">
                                                      {item.imageBase64 && (
                                                          <img
                                                              src={item.imageBase64}
                                                              className="w-20 h-20 object-cover rounded border-2 border-gray-200"
                                                              alt=""
                                                          />
                                                      )}
                                                      <div className="A4-product-name text-lg">
                                                          {item.name} {item.specDetail}
                                                      </div>
                                                  </div>
                                              </td>
                                              {!isQuoteOnly && (
                                                  <td className="border border-black p-4 text-center font-black text-lg">
                                                      {item.qty} {item.bigUnit}
                                                  </td>
                                              )}
                                              <td className="border border-black p-4 text-right font-bold text-lg">
                                                  ${item.price.toLocaleString()}
                                              </td>
                                              {!isQuoteOnly && (
                                                  <td className="border border-black p-4 text-right font-black text-blue-600 text-lg">
                                                      {fmtMoney(item.qty * item.packingContent * item.price)}
                                                  </td>
                                              )}
                                          </tr>
                                      ))}
                                  </tbody>
                              </table>

                              {!isQuoteOnly && (
                                  <div className="text-right text-4xl font-black mb-10 text-blue-600">
                                      ç¸½è¨ˆ: {fmtMoney(calcTotal())}
                                  </div>
                              )}

                              <div className="border-2 p-6 text-base bg-gray-50 rounded-2xl">
                                  <p className="font-black mb-3 text-gray-800 text-lg">åŒ¯æ¬¾è³‡è¨Š / å‚™è¨»:</p>
                                  <pre className="whitespace-pre-wrap font-sans text-gray-600 leading-relaxed">
                                      {companyInfo.bankInfo}
                                  </pre>
                              </div>
                          </div>
                      )}
                  </div>
              </div>
          );
      }

      // ===== ç·¨è¼¯æ¨¡å¼ï¼ˆä¸»ç•«é¢ï¼‰ - å¤§å­—é«”å„ªåŒ–ç‰ˆ =====
      return (
          <div className="min-h-screen pb-40 font-sans">
              {showAdmin && <AdminPanel />}
              {showSpecLookup && <SpecModal />}
              {showPricePicker && <PricePickerModal />}

              {/* é ‚éƒ¨å°èˆªåˆ— - æ”¾å¤§ */}
              <div className="bg-white border-b-2 px-5 py-4 sticky top-0 z-30 flex justify-between items-center shadow-lg">
                  <div className="flex items-center gap-4">
                      <div className={`text-white p-3 rounded-2xl shadow-lg ${
                          isSyncing ? 'bg-gray-400' : 'gradient-blue'
                      }`}>
                          <LucideIcon name="Cloud" size={28} />
                      </div>
                      <div>
                          <h1 className="text-2xl font-black text-slate-800">å…«æ–¹ç’°çƒ V9.0</h1>
                          {isSyncing ? (
                              <span className="text-base text-blue-500">é€£ç·šä¸­...</span>
                          ) : (
                              <span className="text-sm text-green-600 font-bold">â— å·²é€£ç·š</span>
                          )}
                      </div>
                  </div>

                  <div className="flex gap-3">
                      <button
                          onClick={() => setShowAdmin(true)}
                          className="p-4 bg-gray-100 rounded-2xl hover:bg-gray-200 relative shadow-md"
                      >
                          <LucideIcon name="Database" size={26} />
                          {userRole === 'admin' && (
                              <span className="absolute top-0 right-0 w-3 h-3 bg-green-500 rounded-full"></span>
                          )}
                      </button>
                      <button
                          onClick={handleLogout}
                          className="p-4 bg-red-50 text-red-500 rounded-2xl hover:bg-red-100 shadow-md"
                      >
                          <LucideIcon name="LogOut" size={26} />
                      </button>
                  </div>
              </div>

              {/* ä¸»è¦å…§å®¹å€ - å­—é«”æ”¾å¤§ */}
              <div className="max-w-4xl mx-auto p-5 space-y-5">
                  {/* å®¢æˆ¶è³‡è¨Šå¡ç‰‡ */}
                  <div className="gradient-card p-7 rounded-3xl card-shadow border border-gray-100">
                      <div className="flex justify-between mb-5 border-b-2 pb-4">
                          <span className="text-sm font-black text-blue-600 tracking-wider">
                              è¨‚å–®è³‡è¨Š
                          </span>
                          <div className="flex items-center gap-4">
                              <input
                                  type="date"
                                  value={customerInfo.date}
                                  onChange={e => setCustomerInfo({ ...customerInfo, date: e.target.value })}
                                  className="bg-gray-100 px-4 py-3 rounded-2xl outline-none focus:bg-white transition text-base"
                              />
                              <label className="flex items-center gap-3 text-base font-bold bg-gray-50 px-4 py-3 rounded-2xl cursor-pointer hover:bg-gray-100 transition">
                                  <input
                                      type="checkbox"
                                      checked={isQuoteOnly}
                                      onChange={e => setIsQuoteOnly(e.target.checked)}
                                      className="w-5 h-5"
                                  />
                                  ç´”å ±åƒ¹
                              </label>
                          </div>
                      </div>

                      <div className="grid grid-cols-3 gap-5">
                          <div className="col-span-2">
                              <input
                                  type="text"
                                  placeholder="å®¢æˆ¶åç¨±"
                                  className="w-full text-2xl font-black border-b-4 py-3 outline-none focus:border-blue-600 transition bg-transparent"
                                  value={customerInfo.name}
                                  onChange={e => setCustomerInfo({ ...customerInfo, name: e.target.value })}
                                  style={{fontSize: '24px'}}
                              />
                          </div>
                          <div className="col-span-1">
                              <select
                                  value={customerPriceTier}
                                  onChange={e => setCustomerPriceTier(e.target.value)}
                                  className="w-full h-full font-bold text-blue-700 bg-blue-50 rounded-2xl text-center outline-none cursor-pointer hover:bg-blue-100 transition text-xl"
                                  style={{fontSize: '18px'}}
                              >
                                  {priceTiers.map(t => (
                                      <option key={t} value={t}>{t}</option>
                                  ))}
                              </select>
                          </div>

                          <input
                              type="text"
                              placeholder="çµ±ç·¨"
                              className="p-4 bg-gray-50 rounded-2xl text-lg outline-none focus:bg-white transition"
                              value={customerInfo.taxId}
                              onChange={e => setCustomerInfo({ ...customerInfo, taxId: e.target.value })}
                          />
                          <input
                              type="text"
                              placeholder="è¯çµ¡äºº"
                              className="p-4 bg-gray-50 rounded-2xl text-lg outline-none focus:bg-white transition"
                              value={customerInfo.contact}
                              onChange={e => setCustomerInfo({ ...customerInfo, contact: e.target.value })}
                          />
                          <select
                              value={customerInfo.paymentMethod}
                              onChange={e => setCustomerInfo({ ...customerInfo, paymentMethod: e.target.value })}
                              className="p-4 bg-gray-50 rounded-2xl font-bold text-lg cursor-pointer outline-none hover:bg-gray-100 transition"
                          >
                              {['ç¾é‡‘', 'æœˆçµ30', 'æœˆçµ60', 'åŒ¯æ¬¾'].map(m => (
                                  <option key={m} value={m}>{m}</option>
                              ))}
                          </select>
                      </div>
                  </div>

                  {/* ç”¢å“é …ç›®åˆ—è¡¨ - å¤§å­—é«” */}
                  <div className="space-y-4">
                      {items.map((item, index) => (
                          <div
                              key={item.id}
                              className="gradient-card p-7 rounded-3xl card-shadow border border-gray-100 relative group hover:shadow-xl transition"
                          >
                              {/* åˆªé™¤æŒ‰éˆ• */}
                              <div className="absolute top-5 right-5 z-10">
                                  <button
                                      onClick={() => removeItem(item.id)}
                                      className="p-3 bg-red-50 rounded-2xl text-red-500 hover:bg-red-100 shadow-md"
                                  >
                                      <LucideIcon name="Trash2" size={22} />
                                  </button>
                              </div>

                              {/* ç”¢å“è³‡è¨Š - æ”¾å¤§ */}
                              <div className="flex gap-4 mb-5 pr-16" onClick={() => openSpecLookup(item.id)}>
                                  <div className="w-14 h-14 rounded-full bg-gradient-to-br from-blue-100 to-blue-200 text-blue-700 flex items-center justify-center font-black text-2xl shrink-0 shadow-md">
                                      {index + 1}
                                  </div>
                                  <div className="cursor-pointer flex-1">
                                      <div className={`text-2xl font-black leading-tight ${
                                          !item.name ? 'text-gray-300' : 'text-gray-800'
                                      }`}>
                                          {item.name || 'é»æ“Šé¸æ“‡ç”¢å“...'}
                                      </div>
                                      {item.specDetail && (
                                          <div className="text-lg font-bold text-blue-600 mt-2">
                                              {item.specDetail}
                                          </div>
                                      )}
                                  </div>
                              </div>

                              {/* æ•¸é‡/åƒ¹æ ¼è¼¸å…¥ - è¶…å¤§å­—é«” */}
                              <div className="grid grid-cols-12 gap-5 items-end mb-5">
                                  {/* æ•¸é‡ */}
                                  <div className="col-span-4">
                                      <label className="text-sm font-bold text-gray-500 uppercase tracking-wide block mb-2">
                                          æ•¸é‡
                                      </label>
                                      <div className="flex items-center border-b-4 border-gray-200 focus-within:border-blue-500 transition">
                                          <input
                                              type="number"
                                              className="w-full number-input-large text-center outline-none py-3 bg-transparent"
                                              value={item.qty || ''}
                                              onChange={e => updateItem(item.id, 'qty', handleNumeric(e))}
                                              min="0"
                                              step="1"
                                          />
                                          <select
                                              value={item.bigUnit}
                                              onChange={e => updateItem(item.id, 'bigUnit', e.target.value)}
                                              className="text-xl font-bold bg-transparent outline-none cursor-pointer pr-2"
                                              style={{fontSize: '20px'}}
                                          >
                                              {['ä»¶', 'ç®±', 'ç±ƒ', 'ä¿'].map(u => (
                                                  <option key={u} value={u}>{u}</option>
                                              ))}
                                          </select>
                                      </div>
                                  </div>

                                  {/* å–®åƒ¹ */}
                                  <div className="col-span-4">
                                      <label className="text-sm font-bold text-gray-500 uppercase tracking-wide block mb-2">
                                          å–®åƒ¹
                                      </label>
                                      <div className="flex items-center border-b-4 border-gray-200 focus-within:border-blue-500 transition">
                                          <input
                                              type="number"
                                              className="w-full number-input-large text-center outline-none py-3 bg-transparent"
                                              value={item.price || ''}
                                              onChange={e => updateItem(item.id, 'price', handleNumeric(e))}
                                              min="0"
                                              step="1"
                                          />
                                          <button
                                              onClick={() => openPricePicker(item.id)}
                                              className="text-blue-500 hover:text-blue-700 p-2"
                                          >
                                              <LucideIcon name="DollarSign" size={24} />
                                          </button>
                                      </div>
                                  </div>

                                  {/* å°è¨ˆ */}
                                  <div className="col-span-4 text-right">
                                      <div className="text-3xl font-black text-gray-900">
                                          {fmtMoney(item.qty * item.packingContent * item.price)}
                                      </div>
                                      <div className="text-sm font-bold text-gray-500 uppercase tracking-wide mt-1">
                                          å°è¨ˆ
                                      </div>
                                  </div>
                              </div>

                              {/* åœ–ç‰‡ä¸Šå‚³ */}
                              <div className="pt-5 border-t-2 border-dashed border-gray-200 flex justify-between items-center">
                                  <label className={`flex items-center gap-3 text-base font-bold px-5 py-3 rounded-2xl cursor-pointer transition ${
                                      uploadingImageId === item.id
                                          ? 'text-gray-400 bg-gray-100 cursor-not-allowed'
                                          : 'text-blue-600 bg-blue-50 hover:bg-blue-100 shadow-md'
                                  }`}>
                                      {uploadingImageId === item.id ? (
                                          <>
                                              <div className="loader"></div>
                                              è™•ç†ä¸­...
                                          </>
                                      ) : (
                                          <>
                                              <LucideIcon name="Image" size={20} />
                                              {item.imageBase64 ? 'æ›´æ›åœ–ç‰‡' : 'æ–°å¢åœ–ç‰‡'}
                                          </>
                                      )}
                                      <input
                                          type="file"
                                          className="hidden"
                                          accept="image/*"
                                          disabled={uploadingImageId === item.id}
                                          onChange={e => handleImageUpload(e, item.id)}
                                      />
                                  </label>

                                  <div className="flex items-center gap-4">
                                      {item.imageBase64 && (
                                          <img
                                              src={item.imageBase64}
                                              className="w-16 h-16 rounded-2xl object-cover border-2 border-gray-200 shadow-md"
                                              alt=""
                                          />
                                      )}
                                      <div className="text-base text-gray-500 font-medium">
                                          ç®±å®¹: <span className="font-bold text-gray-700">{item.packingContent}{item.smallUnit}</span>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      ))}

                      {/* æ–°å¢é …ç›®æŒ‰éˆ• - æ”¾å¤§ */}
                      <button
                          onClick={addItem}
                          className="w-full py-6 rounded-3xl border-4 border-dashed border-gray-300 text-gray-400 font-bold hover:border-blue-500 hover:text-blue-600 hover:bg-blue-50 transition flex items-center justify-center gap-3 shadow-md text-xl"
                      >
                          <LucideIcon name="Plus" size={28} />
                          æ–°å¢ç”¢å“é …ç›®
                      </button>
                  </div>
              </div>

              {/* åº•éƒ¨å›ºå®šåˆ— - è¶…å¤§ */}
              <div className="fixed bottom-0 left-0 right-0 bg-white border-t-4 border-gray-200 p-6 flex justify-between items-center z-40 safe-area-bottom shadow-2xl">
                  <div>
                      <div className="text-sm font-bold text-gray-500 uppercase tracking-wide mb-1">
                          è¨‚å–®ç¸½é¡
                      </div>
                      <div className="text-5xl font-black bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                          {isQuoteOnly ? '---' : fmtMoney(calcTotal())}
                      </div>
                  </div>

                  <div className="flex gap-3">
                      {/* é è¦½æŒ‰éˆ• */}
                      <button
                          onClick={() => setViewMode('preview')}
                          className="gradient-blue text-white px-8 py-4 rounded-2xl font-bold shadow-xl hover:shadow-2xl flex items-center gap-3 text-xl"
                      >
                          é è¦½
                          <LucideIcon name="ArrowRight" size={24} />
                      </button>

                      {/* LINEåˆ†äº«æŒ‰éˆ• */}
                      <button
                          onClick={() => {
                              let msg = `ã€${customerInfo.name}ã€‘${customerInfo.quoteNo}\n${'='.repeat(25)}\n`;
                              items.filter(i => i.name).forEach(i => {
                                  msg += `${i.name} ${i.specDetail}\n`;
                                  msg += `æ•¸é‡: ${i.qty}${i.bigUnit} Ã— $${i.price}\n`;
                                  if (!isQuoteOnly) {
                                      msg += `å°è¨ˆ: ${fmtMoney(i.qty * i.packingContent * i.price)}\n`;
                                  }
                                  msg += '\n';
                              });
                              if (!isQuoteOnly) {
                                  msg += `${'='.repeat(25)}\nç¸½è¨ˆ: ${fmtMoney(calcTotal())}\n`;
                              }
                              msg += `\nå‚™è¨»:\n${companyInfo.bankInfo}`;
                              window.open(`https://line.me/R/msg/text/?${encodeURIComponent(msg)}`);
                          }}
                          className="bg-green-600 text-white px-8 py-4 rounded-2xl font-bold shadow-xl hover:shadow-2xl hover:bg-green-700 flex items-center gap-3 text-xl"
                      >
                          LINE
                          <LucideIcon name="Send" size={24} />
                      </button>
                  </div>
              </div>
          </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
